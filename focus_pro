<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-A8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3B82F6;
            --primary-hover: #2563EB;
            --secondary-color: #6B7280;
            --background-color: #F9FAFB;
            --container-bg: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #002f63;
            --border-color: #E5E7EB;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            background-color: var(--background-color); 
            color: var(--text-primary); 
            display: flex;
            justify-content: center;
            padding: 2rem;
        }
        .container { 
            position: relative;
            background-color: var(--container-bg); 
            padding: 2.5rem; 
            border-radius: 16px; 
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 8px 10px -6px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 1400px;
            border: 1px solid var(--border-color);
        }

        .info-panel-left, .info-panel-right {
            position: absolute;
            font-size: 0.7rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        .info-panel-left { top: 1.5rem; left: 2.5rem; }
        .info-panel-right { top: 1.5rem; right: 2.5rem; text-align: right; }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            margin-top: 3rem; /* Space for info panels */
        }
        .focus-title { 
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
        }
        .focus-title { 
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            font-size: 3.5rem; /* Aumentado para que el efecto sea más notorio */
            font-weight: bold;
            font-family: "Arial", sans-serif; /* Usando la fuente que sugeriste */
        }
        
        .focus-title span {
            color: #2e64d7; /* Color de la letra principal */
            text-shadow: 
                0 1px 0 #ccc, 
                0 2px 0 #c9c9c9,
                0 3px 0 #bbb,
                0 4px 0 #b9b9b9,
                0 5px 0 #aaa,
                0 6px 1px rgba(0,0,0,.1),
                0 0 5px rgba(0,0,0,.1),
                0 1px 3px rgba(0,0,0,.3),
                0 3px 5px rgba(0,0,0,.2),
                0 5px 10px rgba(0,0,0,.25),
                0 10px 10px rgba(0,0,0,.2),
                0 20px 20px rgba(0,0,0,.15);
            transition: transform 0.2s ease-out;
        }

        .focus-title span:hover {
            transform: scale(1.05); /* Efecto de zoom al pasar el ratón */
        }

        #file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            background-color: #FFFFFF;
            /* LÍNEAS A AÑADIR */
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: all 0.2s ease-in-out;
        }
        #file-upload-area:hover {
            background-color: #FDFDFD;
            border-color: var(--primary-color);
            /* LÍNEAS A AÑADIR */
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }
        
        #file-upload-area .icon { font-size: 3rem; color: var(--primary-color); }
        #file-upload-area p { margin: 0.5rem 0 0; color: var(--text-secondary); font-weight: 500; }
        input[type="file"] { display: none; }
        
        .controls-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .checkbox-container input { height: 1.25rem; width: 1.25rem; accent-color: var(--primary-color); }
        .checkbox-container label { font-weight: 500; color: var(--text-secondary); }

        button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            position: relative; /* Necesario para el efecto de movimiento */
            top: 0;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            /* Sombra que crea el borde inferior 3D */
            box-shadow: 0 5px 0 #a3aacd; 
            transition: all 0.1s ease-in-out;
        }
       button:hover {
            background-color: var(--primary-hover);
            top: -2px; /* Al pasar el ratón, el botón se "levanta" */
            box-shadow: 0 7px 0 #1D4ED8;
        }
        button:active {
            top: 3px; /* Al hacer clic, el botón se "hunde" */
            box-shadow: 0 2px 0 #1D4ED8;
            transform: none; /* Se anula el transform para que el efecto sea limpio */
        }
       button:disabled {
            background-color: #D1D5DB;
            cursor: not-allowed;
            box-shadow: 0 5px 0 #9CA3AF; /* Sombra para el estado deshabilitado */
            top: 0;
        }
        
        #status { text-align: center; margin: 1.5rem 0; font-style: italic; color: var(--secondary-color); }

        #validation-summary {
            background-color: #EFF6FF;
            border-left: 5px solid var(--primary-color);
            padding: 1rem;
            margin: 1.5rem 0;
            border-radius: 8px;
            display: none;
        }
        #validation-summary p { margin: 0.25rem 0; font-size: 0.9em; }
        #validation-summary strong { color: var(--primary-color); }
        
        .tab-header, .sub-tab-header {
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tab-header button.tab-link, .sub-tab-header button.sub-tab-link {
            background-color: transparent;
            color: var(--text-secondary);
            border: none;
            border-bottom: 3px solid transparent;
            outline: none;
            cursor: pointer;
            padding: 0.75rem 1rem;
            transition: 0.3s;
            font-size: 0.95em;
            font-weight: 600;
            margin-bottom: -2px;
        }
        .tab-header button.tab-link:hover, .sub-tab-header button.sub-tab-link:hover {
            color: var(--primary-color);
        }
        .tab-header button.tab-link.active, .sub-tab-header button.sub-tab-link.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content, .sub-tab-content { display: none; padding: 1.5rem 0; border-top: none; }
        .tab-content.active, .sub-tab-content.active { display: block; }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 0.0rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02), 0 1px 2px rgba(0,0,0,0.04);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        th, td {
            border: none;
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.875rem;
        }
        th {
            background-color: #b1bedb;
            color: var(--text-secondary);
            font-weight: 600;
            text-align: center;
        }
        td { background-color: var(--container-bg); }
        tr:last-child td { border-bottom: none; }
        tr:nth-child(even) td { background-color: #F9FAFB; }
        td.negative-value { color: #EF4444; font-weight: 500; }
        td.numeric-cell { text-align: right; }
        td.code-format-cell { text-align: center !important; }
        table tfoot td { font-weight: bold; background-color: #F3F4F6; }

        .results-container { max-height: 500px; overflow: auto; margin-top: 1rem; }
        .table-actions-container { margin-bottom: 1rem; text-align: right;}
        .table-actions-container button { font-size: 0.8em; padding: 0.5rem 1rem; background-color: var(--secondary-color); }

        .modal {
            background-color: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(4px);
        }
        .modal-content { 
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            max-width: 700px;
        }
        .footer-info {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

/* --- ESTILOS TITUTLO --- */

.analysis-section {
    margin-top: 2rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.analysis-title {
    font-weight: bold;
    text-align: left;
    font-size: 1.25rem; /* Parámetro para ajustar tamaño de letra */
    color: var(--text-primary);
    margin: 0 0 0.75rem 0;
}

.input-group {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.input-group label {
    font-weight: bold;
    text-align: left;
    color: var(--text-secondary);
    white-space: nowrap; /* Evita que la etiqueta se divida */
}

.input-group input {
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.input-group input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}

/* Estilos para el contenedor del interruptor */
.toggle-container {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-left: 1rem; /* Espacio adicional */
}

/* Estilos para el interruptor (toggle switch) */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
}
.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 28px;
}
.slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}
input:checked + .slider {
    background-color: var(--primary-color);
}
input:checked + .slider:before {
    transform: translateX(22px);
}

/* Clase para ocultar las filas con valor cero */
.row-is-zero {
    display: none !important;
}

/* ▼▼▼ Estilo recomendaciones▼▼▼ */

#recommendations-icon {
    position: absolute;
    top: 250px; /* Alineación vertical aproximada con el centro del área de carga */
    right: 7rem;
    cursor: pointer;
    color: #FBBF24; /* Amarillo advertencia */
    transition: transform 0.2s ease, color 0.2s ease;
}
#recommendations-icon:hover {
    transform: scale(1.1);
    color: #F59E0B; /* Amarillo más oscuro */
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(17, 24, 39, 0.6);
    backdrop-filter: blur(4px);
    display: none; /* Oculto por defecto */
    justify-content: center;
    align-items: flex-start;
     padding-top: 5rem;
    z-index: 1000;
}
.modal-content-recommendations {
    background-color: var(--container-bg);
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
    max-width: 500px;
    width: 90%;
    position: relative;
}
.modal-content-recommendations h3 {
    margin-top: 0;
    color: var(--text-primary);
    font-size: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 0.5rem;
}
.modal-content-recommendations ul {
    padding-left: 1.5rem;
    color: var(--text-secondary);
}
.modal-content-recommendations li {
    margin-bottom: 0.75rem;
    line-height: 1.5;
}
.modal-close {
    position: absolute;
    top: 1rem;
    right: 1.5rem;
    font-size: 2rem;
    font-weight: bold;
    color: #9CA3AF;
    cursor: pointer;
    transition: color 0.2s;
}
.modal-close:hover {
    color: var(--text-primary);
}


/* Nuevo estilo para el borde de las tablas de Resumen General */
.resumen-general-tabla {
    border: 2px solid #b1bedb; /* Este es un azul, puedes cambiarlo por el color que prefieras */
}


/* Contenedor para alinear el título y el ícono */
        .section-title-wrapper {
            display: flex;
            align-items: center; /* Centra verticalmente el ícono con el texto */
            gap: 0.50rem;      /* Espacio entre el título y el ícono */
            margin-top: 1.5rem; /* <-- Parámetro para controlar el espacio superior */
            margin-bottom: 0.0rem; /* <-- Añade o ajusta esta línea */
        
        .section-title-wrapper h3 {
            margin-bottom: 0.1; /* Ajusta este valor para dar más o menos espacio */
        }

        }

        /* Estilos para el ícono de la cámara */
        .capture-icon {
            color: var(--primary-color);
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
            line-height: 1; /* Asegura que no añada espacio vertical extra */
        }
        .capture-icon:hover {
            transform: scale(1.15);
            color: var(--primary-hover);
        }
        .capture-icon svg {
            /* '1em' hace que el ícono tenga el mismo tamaño que la fuente del título */
            width: 1em;
            height: 1em;
        }


/* ▼▼▼ icono home ▼▼▼ */

        .home-icon-link {
            text-align: right; /* Posiciona el ícono a la derecha */
            margin-top: -1.5rem; /* Sube el ícono para alinearlo mejor */
            margin-bottom: 1rem; /* Espacio debajo del ícono */
        }
        .home-icon-link svg {
            width: 24px;
            height: 24px;
            color: var(--secondary-color);
            cursor: pointer;
            transition: transform 0.2s, color 0.2s;
        }
        .home-icon-link:hover svg {
            transform: scale(1.1);
            color: var(--primary-color);
        }



    </style>
</head>
<body>
    <div class="container">
        <div class="info-panel-left">
            Coordinación de Denuncia de Fiscalización<br>
            Subdirección de Apoyo en la Lucha Contra el Delito Aduanero y Fiscal<br>
            Dirección de Impuestos y Aduanas Nacionales - DIAN <br>
            Herramienta No Oficial
        </div>
        <div class="info-panel-right">
            Desarrollado por:<br>
            Ronald H. Fonseca Ariza<br>
            Gestor III<br>
            Coordinación de Denuncia de Fiscalización<br>
            Nivel Central
        </div>

        <div class="header">
            <div class="focus-title">
                <span>F</span><span>O</span><span>C</span><span>U</span><span>S</span>
            </div>
            <p class="focus-subtitle">Fiscal Oversight for Compliance And Uncovering Suspicious <br> <br>Herramienta para Procesar Información Exógena Tributaria Reportada por Terceros</p>
        </div>

        <label for="archivoExcel" id="file-upload-area">
            <div class="icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-cloud-arrow-up-fill" viewBox="0 0 16 16">
                    <path d="M8 2a5.53 5.53 0 0 0-3.594 1.342c-.766.66-1.321 1.52-1.464 2.383C1.266 6.095 0 7.555 0 9.318 0 11.366 1.708 13 3.781 13h8.906C14.502 13 16 11.57 16 9.773c0-1.636-1.242-2.969-2.834-3.194C12.923 3.999 10.69 2 8 2zm2.354 5.146a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2z"/>
                </svg>
            </div>
            <p id="file-name-display">Haz clic aquí para seleccionar tu archivo Excel</p>
        </label>
        <input type="file" id="archivoExcel" accept=".xlsx, .xls" onchange="handleFile()" multiple/>
        
      <div class="controls-container">
    <div class="checkbox-container">
        <input type="checkbox" id="consolidate-checkbox" checked>
        <label for="consolidate-checkbox">Consolidar<br> Datos</label>
    </div>

    <!-- Botón de Procesar -->
    <button id="btnProcesar" onclick="document.getElementById('archivoExcel').click()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311a1.464 1.464 0 0 1-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c-1.4-.413-1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.858 2.929 2.929 0 0 1 0 5.858z"/>
        </svg>
        Procesar
    </button>

    <!-- Botón de Exportar (Ahora cerrado correctamente) -->
   <button id="btnExportar" style="display:none;" onclick="exportarDatos()" title="Descargar Archivo">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
        </svg>
    </button>

    <!-- Botón de Generar PDF (Ahora es un elemento separado) -->
    <button id="btnGenerarPDF" class="icon-button" style="display:none;" onclick="generarPDF()" title="Generar Informe">
       <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
    <path d="M4 11a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-3zm3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-3zm3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-3z"/>
    <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 1.5v2A1.5 1.5 0 0 0 11 5h2V2.45L9.5 1.5z"/>
</svg>
    </button>
</div>

 <!-- Nuevo Botón de Exportar Hoja Organizada -->
    <button id="btnExportarOrganizado" style="display:none;" onclick="exportOrganizedSheet()" title="Descargar Hoja Organizada">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-file-earmark-arrow-down-fill" viewBox="0 0 16 16">
            <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0zM9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1zm-1 4v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 1 1 .708-.708L7.5 11.293V7.5a.5.5 0 0 1 1 0z"/>
        </svg>
        Hoja Organizada
    </button>

<!-- Botón para el nuevo Resumen Consolidado -->
<button id="btnExportarConsolidado" style="display:none;" onclick="exportarResumenConsolidado()" title="Descargar Resumen Consolidado">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-file-earmark-spreadsheet-fill" viewBox="0 0 16 16">
        <path d="M6 12v-2h3v2H6z"/>
        <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0zM9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1zM3 9h10v1h-3v2h3v1h-3v2H9v-2H6v2H5v-2H3v-1h2v-2H3V9z"/>
    </svg>
</button>

<p id="status" style="text-align: center; margin-top: 1.5rem; font-style: italic; color: var(--secondary-color);">Selecciona un archivo Excel para comenzar.</p>

 <div id="validation-summary"></div>

        <div class="footer-info">
            <span id="update-date">Versión: Focus Pro 1.0.0<br>Última Actualización: 01-09-2026 - 04:44 PM</span>
            <span id="current-datetime"></span>
        </div>

        <div id="validation-summary"></div>
        
<!-- --- INICIO DEL CÓDIGO A AÑADIR --- -->

<div class="analysis-section">
    <h3 class="analysis-title">Anexo Informe Análisis de Denuncia<br>Información de Relevancia Tributaria<br>Análisis de Operaciones</h3>
    <div class="input-group">
        <label for="radicado-sidf">Número Radicado Denuncia SIDF:</label>
        <input type="text" id="radicado-sidf" name="radicado-sidf" maxlength="18 size="18" style="text-align:center;">
    </div>
</div>


        <div class="tab-container">
            <div class="tab-header" id="tabHeader"></div>
            <div id="tabContentContainer"></div>
        </div>
    </div>


<!-- Icono de Recomendaciones -->
<div id="recommendations-icon" onclick="openRecommendationsModal()">
    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" viewBox="0 0 16 16">
        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
    </svg><br>
    Léeme
</div>

<!-- Ventana Modal de Recomendaciones (inicialmente oculta) -->
<div id="recommendations-modal" class="modal-overlay">
    <div class="modal-content-recommendations">
        <span class="modal-close" onclick="closeRecommendationsModal()">&times;</span>
        <h3>Recomendaciones</h3>
        <ul>
            <li>Importante verificar el formato 1476: por cofiguración de la información en algunas oportunidades los renglones se desfasan
                para corregir este desface en las celdas correspondientes a Porcentaje de Participación y Numero Propietarios se pueden editar para realizar 
                el respectivo calculo de participación.</li>
             <li> Si detecta errores en algún formato ó la información no se genera puede editarla manualmente en el resumen</li>
             <li>CUALQUIER INCONSISTENCIA AGRADEZCO INFORMARLA PARA REALIZAR LA RESPECTIVA CORRECCIÓN - EL DESARROLLO SE ENCUENTRA EN FASE BETA - </li>
            <!-- Puedes añadir más recomendaciones aquí en el futuro -->
        </ul>
    </div>
</div>
    

    <script>

/**
 * Convierte un número de serie de fecha de Excel a un objeto de fecha de JavaScript.
 * @param {number} serial - El número de serie de la fecha de Excel.
 * @returns {Date} - El objeto de fecha de JavaScript.
 */
function excelSerialDateToJSDate(serial) {
    if (isNaN(serial) || serial < 1) return null;
    // La fecha base de Excel es 30/12/1899 para compatibilidad con Lotus 1-2-3
    const excelEpoch = new Date(1899, 11, 30);
    return new Date(excelEpoch.getTime() + serial * 86400000);
}

        // Constantes para los nombres de las columnas y valores clave.
        const ENCABEZADOS_SECCION_1 = [
            "Código de Formato", "Nombre del Formato", "Código Concepto", "Nombre Concepto",
            "Año Vigencia", "Periodo", "Estado", "NIT", "Nombre / Razón Social", "Reportado Como",
            "Número de Solicitud", "Número de Documento", "Razón Social",
        ];
        const HEADER_TO_FIND_IN_COL_A = "Código de Formato";
        const CODIGO_FORMATO_KEY = "Código de Formato";
        const NOMBRE_FORMATO_KEY = "Nombre del Formato";
        const CODIGO_CONCEPTO_KEY = "Código Concepto";
        const NOMBRE_CONCEPTO_KEY = "Nombre Concepto";
        const ANO_VIGENCIA_KEY = "Año Vigencia";
        const PERIODO_KEY = "Periodo";
        const NIT_KEY = "NIT";
        const NOMBRE_RAZON_SOCIAL_KEY = "Nombre / Razón Social";
        const REPORTADO_COMO_KEY = "Reportado Como";

        const FORMATOS_CON_RESUMEN = ["1001", "1003","1005", "1006", "1008", "1009", "1010","1013", "1014", "1007", "1019","1020", "1021", "1023", "1024", "1026", "1032","1038", "1042", "1476", "1481","1647", "2273","2274","2276","2277","2575", "5247", "5248", "5249","5250","5251", "5252", "1480"];

        // Listas para clasificar conceptos del formato 1001
        const EXCLUIDOS_INGRESOS_1001 = [...new Set([
            "Otra Rte le practicaron",
            "Rte le practican arriendos",
            "Rte le practican honorarios",
            "Rte le practican ingreso tarjeta déb/crédito",
            "Rte le practican rendimiento",
            "Rte le practican salarios",
            "Rte le practican servicios",
            "Rte le practican comisiones",
            "Rtefte  ingreso Arrendamiento Cargos diferidos",
            "Rtefte  Otros ingresos  Cargos diferidos",
            "Rtefte Ventas Cargos diferidos",
            "Rtefte ingreso Servicios  Cargos diferidos",
            "Rtefte Amortizaciones informante",
            "Rtefte ingreso Servicios Inversión ambiente",
            "Rtefte ingreso Impuestos pagados",
            "Rtefte Aportes tasas contribuciones pagados",
            "Rtefte Venta Activo Fijo 158-3 E.T.",
            "Rtefte Venta Activos Fijos",
            "Rtefte Venta activos movibles",
            "Rtefte Gasto representa no ingreso persona",
            "Rtefte Viáticos No ingreso trabajador",
            "Rtefte Asumida Impuestos pagados",
            "Rtefte Asumida Venta activos movibles",
            "Otras Rte asumidas informante",
            "Retención distribuida al tercero",
            "Rtefte ingreso Parafiscal Sena, BF y Cajas",
            "Retención le practican enajenación Notaría ponderado por enajenante",
            "Retención Intereses y rendimientos financeiros pagados",
            "Certificado - Rtefte pagos rentas de trabajo o pensiones",
            "Rte le practican en Notaría y Tránsito",
            "Certificado-Rtefente por pagos al empleado",
            "Valor Total Retención Rendimientos",
            "Retención en la fuente practicada renta (cas40)",
            "IVA > valor deduc Servicios",
            "IVA > valor No dec Servicios",
            "IVA > valor deduc Arrendamientos",
            "IVA > valor No dec Arrendamientos",
            "IVA > valor deduc Compra activo movible",
            "IVA > valor No dec  Venta activos movibles",
            "IVA > valor deduc Compra Activos Fijo",
            "IVA > valor deduc Otros Costos y Deducciones",
            "IVA > valor No dec ingreso Otros Costos",
            "IVA > valor deduc Ventas Cargos diferidos",
            "IVA > valor deduc Otros  Cargos diferidos",
            "IVA > valor No dec Impuestos pagados",
            "IVA > valor No dec Rte ingreso tarjeta deb/cred",
            "IVA mayor valor del costo o gasto deducible (cas38)",
            "IVA mayor valor del costo o gasto no deducible (cas39)",
            "Retención practicada IVA retenido",
            "Rte timbre le practicaron",
            "Rteiva Común Arrendamientos",
            "Rteiva Común Otros ingresos gastos",
            "Rteiva Común Servicios",
            "Rteiva Común Venta activos movibles",
            "Rteiva Común Ingreso tarjetas debito crédito",
            "Retención en la fuente practicada IVA régimen común (cas42)",
            "Retención en la fuente practicada IVA no domiciliados (cas43)",
            "Base Retención timbre - No deducibles"

        ].map(h => normalizeText(h)))];

        const INCLUIDOS_RETEFUENTE_1001 = [...new Set([
            "Otra Rte le practicaron",
            "Rte le practican arriendos",
            "Rte le practican honorarios",
            "Rte le practican ingreso tarjeta déb/crédito",
            "Rte le practican rendimiento",
            "Rte le practican salarios",
            "Rte le practican servicios",
            "Rte le practican comisiones",
            "Rtefte  ingreso Arrendamiento Cargos diferidos",
            "Rtefte  Otros ingresos  Cargos diferidos",
            "Rtefte Ventas Cargos diferidos",
            "Rtefte ingreso Servicios  Cargos diferidos",
            "Rtefte Amortizaciones informante",
            "Rtefte ingreso Servicios Inversión ambiente",
            "Rtefte ingreso Impuestos pagados",
            "Rtefte Aportes tasas contribuciones pagados",
            "Rtefte Venta Activo Fijo 158-3 E.T.",
            "Rtefte Venta Activos Fijos",
            "Rtefte Venta activos movibles",
            "Rtefte Gasto representa no ingreso persona",
            "Rtefte Viáticos No ingreso trabajador",
            "Rtefte Asumida Impuestos pagados",
            "Rtefte Asumida Venta activos movibles",
            "Otras Rte asumidas informante",
            "Retención distribuida al tercero",
            "Rtefte ingreso Parafiscal Sena, BF y Cajas",
            "Retención le practican enajenación Notaría ponderado por enajenante",
            "Retención Intereses y rendimientos financeiros pagados",
            "Certificado - Rtefte pagos rentas de trabajo o pensiones",
            "Rte le practican en Notaría y Tránsito",
            "Certificado-Rtefente por pagos al empleado",
            "Valor Total Retención Rendimientos",
            "Retención en la fuente practicada renta (cas40)"
        ].map(h => normalizeText(h)))];

        const INCLUIDOS_RETEIVA_1001 = [...new Set([
            "Retención practicada IVA retenido",
            "Rteiva Común Arrendamientos",
            "Rteiva Común Otros ingresos gastos",
            "Rteiva Común Servicios",
            "Rteiva Común Venta activos movibles",
            "Rteiva Común Ingreso tarjetas debito crédito",
            "Retención en la fuente practicada IVA régimen común (cas42)"
        ].map(h => normalizeText(h)))];

        const ENCABEZADOS_S1_FILA_RESUMEN_1001 = [
            CODIGO_FORMATO_KEY, "Nombre del Formato", "Código Concepto", "Nombre Concepto", "Año Vigencia"
        ];
        const ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR = [
            CODIGO_FORMATO_KEY, NOMBRE_FORMATO_KEY, CODIGO_CONCEPTO_KEY, NOMBRE_CONCEPTO_KEY,
            ANO_VIGENCIA_KEY, PERIODO_KEY
        ];
        const ENCABEZADOS_S1_FILA_RESUMEN_1019_MOVIMIENTOS = [
            CODIGO_FORMATO_KEY, NOMBRE_FORMATO_KEY, CODIGO_CONCEPTO_KEY, NOMBRE_CONCEPTO_KEY,
            ANO_VIGENCIA_KEY, PERIODO_KEY, REPORTADO_COMO_KEY
        ];

        const ENCABEZADOS_S1_FILA_RESUMEN_1019_PATRIMONIO = [
            CODIGO_FORMATO_KEY, NOMBRE_FORMATO_KEY, CODIGO_CONCEPTO_KEY, NOMBRE_CONCEPTO_KEY,
            ANO_VIGENCIA_KEY, PERIODO_KEY, REPORTADO_COMO_KEY
        ];

    
        const COLUMNAS_S2_FORMATO_1003 = [
            "Retención practicada salario y laborales",
            "Retención practicada compras",
            "Retención practicada servicios",
            "Retención practicada honorarios",
            "Retención practicada comisiones",
            "Retención practicada arrendamientos",
            "Retención practicada otros conceptos",
        ];

        const COLUMNAS_S2_FORMATO_1003_BASES = [
            "Valor pago o abono en cuenta sobre el cual le practicaron la retención por salarios y demás pagos laborales",
            "Valor pago o abono en cuenta retención le practicaron por ventas",
            "Pago abono le practican Rte por ventas",
            "Valor pago o abono en cuenta sobre el cual le practicaron la retención por servicios",
            "Pago abono le practican Rte por servicios",
            "Valor pago o abono en cuenta sobre el cual le practicaron la retención por honorarios",
            "Valor pago o abono en cuenta sobre el cual le practicaron la retención por comisiones",
            "Valor pago o abono en cuenta sobre el cual le practicaron la retención por arrendamientos",
            "Pago abono le practican Rte otros conceptos"
        ];
        
        const COLUMNAS_IVA_DESCONTABLE_1001 = [
            "IVA > valor deduc Servicios",
            "IVA > valor No dec Servicios",
            "IVA > valor deduc Arrendamientos",
            "IVA > valor No dec Arrendamientos",
            "IVA > valor deduc Compra activo movible",
            "IVA > valor No dec  Venta activos movibles",
            "IVA > valor deduc Compra Activos Fijo",
            "IVA > valor deduc Otros Costos y Deducciones",
            "IVA > valor No dec ingreso Otros Costos",
            "IVA > valor deduc Ventas Cargos diferidos",
            "IVA > valor deduc Otros  Cargos diferidos",
            "IVA > valor No dec Rte ingreso tarjeta deb/cred",
            "IVA mayor valor del costo o gasto deducible (cas38)",
            "IVA mayor valor del costo o gasto no deducible (cas39)"
        ];
        
        const COLUMNAS_S2_FORMATO_1005 = [
            "IVA generado",
            "IVA recuperado devolucion compras",
        ];
         const COLUMNAS_S2_FORMATO_1006 = [
            "IVA pagado",
            "IVA recuperado devolucion ventas",
            "Impuesto Descontable",
            "IVA DEVOLUCIONES EN VENTAS"
        ];
        const COLUMNAS_S2_FORMATO_1008 = [
            "Cuenta por pagar como cliente",
            "Pasivos Proveedores",
            "Cuenta por pagar como Socio accionista",
            "Cuenta por pagar accionista, socio o vinculado",
            "Pasivos Casa Matriz, Compañías vinculadas, socios y accionistas",
            "Pasivos obligaciones financieras",
            "Cuenta por pagar impuestos",
            "Pasivos laborales",
            "Demás Cuentas por pagar",
            "Demás Pasivos",
            "Otras cuentas por pagar"

        ];
        const COLUMNAS_S2_FORMATO_1009 = [
            "Cuenta por cobrar como Proveedor",
            "Pasivos Proveedores",
            "Cuenta por cobrar como Socio accionista",
            "Cuenta por cobrar impuestos",
            "Demás Cuentas por cobrar",
        ];
        
        const COLUMNAS_S2_FORMATO_1010 = [
            "Valor patrimonial acciones socios",
            "Valor patrimonial de las acciones o aportes",

        ];

        const COLUMNAS_S2_FORMATO_1013 = [
            "Fiducia Admistracion y pagos Valor Patrimonial",
            "Fiducia Admon y pagos Inversión Año"
        ];

        const COLUMNAS_S2_FORMATO_1019_MOVIMIENTOS = [
            "Valor total Periodo Movimiento Crédito Cuenta",
            "Valor total Movimientos Débito Cuenta"
        ];
        const COLUMNAS_S2_FORMATO_1019_SALDOS = [
            "Total Saldo Final Periodo de la Cuenta"

        ];
         const COLUMNAS_S2_FORMATO_1020_PATRIMONIO = [
            "CDT Saldo Final ponderado por titular"
  
        ];
        const COLUMNAS_S2_FORMATO_1020_INGRESOS = [
            "CDT Rendimientos Pagados",
            "CDT Retención prácticada"
        ];
    
        const COLUMNAS_S2_FORMATO_1021_PATRIMONIO = [
            "Total Saldo Final Periodo de la Cuenta"
       
        ];
        const COLUMNAS_S2_FORMATO_1021_INGRESOS = [
             "Cartera Colectiva Rendimientos Pagado",
             "Valor Total Retención Rendimientos"

        ];
        const COLUMNAS_S2_FORMATO_1021_MOVIMIENTOS = [
             "Inversiones  durante el año en Carteras Colectivas"
        ];
        const COLUMNAS_S2_FORMATO_1023 = [
            "Consumo tarjeta crédito principal",
            "Consumo tarjeta crédito amparada",
            "Consumo tarjeta crédito empresarial"

        ]; 
        const COLUMNAS_S2_FORMATO_1024 = [
            "Venta con tarjeta crédito",
            "Ingresos por diferencia en cambio",
            "Ingresos por servicios",
            "IVA Venta con tarjeta crédito",
        
        ];

        const COLUMNAS_IVA_DESCONTABLE_1024 = ["IVA Venta con tarjeta crédito"];
        const COLUMNAS_IMPUESTO_CONSUMO_1005 = ["Impuesto al consumo"];
        const COLUMNAS_IMPUESTO_CONSUMO_1024 = ["Impuesto al consumo"];

        const COLUMNAS_INGRESOS_1024 = [
        "Ingresos por diferencia en cambio",
        "Ingresos por servicios"

        ];

        const COLUMNAS_IVA_GENERADO_1024 = [
        "IVA Venta con tarjeta crédito"

        ];

        const COLUMNAS_S2_FORMATO_1026 = [
            "Beneficiario Préstamo comercial",
            "Beneficiario Préstamo consumo",
            "Beneficiario Préstamo hipotecario",
            "Beneficiario Préstamo outros prestamos"
        ]; 

        const COLUMNAS_S2_FORMATO_1032 = [
            "Valor Total de la escritura en Notaria",
            "Valor enajenación en Notaría ponderado por enajenante",
            "Valor adquisición en Notaría ponderado por adquirente",
        ]; 

         const COLUMNAS_S2_FORMATO_1038 = [
            "Fecha Creación sociedad en Camara Comercio",
            "Capital Socio sociedad creada en Cámara Comercio",
        ]; 

        const COLUMNAS_S2_FORMATO_1042 = [
            "Adquisiciones Comisionista"
        ];

        const COLUMNAS_S2_FORMATO_1476_DISPLAY = [
            "Identificación autoridad catastral",
            "Número de cédula catastral",
            "Número de matrícula",
            "Valor del Avalúo Catastral",
            "Valor base del impuesto predial",
            "Porcentaje de paticipación",
            "Total  propietarios",
        ];

        const COLUMNA_TOTAL_PARTICIPACION_1476 = "Total Participación";

        const COLUMNAS_S2_FORMATO_1480_DISPLAY = [
            "Marca vehículo", "Línea vehículo", "Placa vehículo", "Valor avalúo vehículo",
            "Modelo (Año) vehículo", "Porcentaje de participación", "Total propietarios"
        ];
        const COLUMNA_TOTAL_PROPIEDAD_1480 = "Total Propiedad";

        const COLUMNAS_S2_FORMATO_1481 = [
            "ICA - Ingresos brutos jurisdicción",
            "ICA - Ingresos gravables jurisdicción",
            "ICA - Ingresos brutos outras jurisdicciones",
            "ICA - Impuesto a cargo",
            "ICA - Impuesto pagado"
        ];

        const COLUMNAS_S2_FORMATO_1647 = [
            "Ingreso distribuido al tercero",
            "Pagos para terceros",
            "Ingresos a traves de terceros",
            "Retención distribuida al tercero"
        ];

         const COLUMNAS_S2_FORMATO_2273_SALDOS = [
            "Saldo total Deceval"
        ];

         const COLUMNAS_S2_FORMATO_2273_INGRESOS = [
            "Recaudo dividendos Deceval",
            "Recaudo Rendimientos Deceval",
            "Retención en la Fuente Deceval"
        ];

        const COLUMNAS_S2_FORMATO_2274 = [
            "Valor cesantías aportadas en el periodo",
            "Cesantías abonadas período",
            "Retiros cesantías acumuladas al 2016 y anteriores",
            "Retiros cesantías acumuladas al 2017 y siguientes",
            "Cesantías acumuladas 2017 y sig 31 dic año reporte"
        ];

        const COLUMNAS_S2_FORMATO_2276_INGRESOS = [
            "Certificado - Total ingresos brutos rentas de trabajo y pensión",
            "Certificado - Pagos por salarios",
            "Certificado - Pagos por prestaciones sociales",
            "Certificado - Otros pagos Rentas de trabajo y pensión",
            "Certificado - Pagos por alimentación hasta a 41 UVT",
            "Certificado - Pagos realizados con bonos, electrónicos, papel",
            "Certificado - Pagos al empleado",
            "Certificado - Cesantías consignadas al fondo de cesantías",
            "Certificado - Cesantías e intereses de cesantías pagadas al empleado",
            "Certificado - Cesantías e intereses pagadas, consignadas o reconocidas",
            "Certificado - Cesantías e intereses pagados",
            "Certificado - Pension jubilación,vejez,invalidez",
            "Certificado - Pagos por honorarios",
            "Certificado - Pagos por servicios",
            "Certificado - Pagos por comisiones"
        ];

        const COLUMNAS_S2_FORMATO_2276_APORTES = [
            "Certificado - Aportes obliga salud",
            "Certificado - Aporte obligatorio fondos pensiones y solidaridad a cargo del trabajador",
            "Certificado - Aportes obliga a fondo pensión,solidaridad y al RAIS",
            "Certificado - Aporte obliga Fondos pensiones y solidaridad pensional",
            "Certificado - Aportes Voluntarios Fondo Pensión"
        ];

        const COLUMNAS_S2_FORMATO_2276_RETEFUENTE = [
            "Certificado - Rtefte pagos rentas de trabajo o pensiones",
            "Certificado - Rtefente por pagos al empleado"
        ];

        const COLUMNAS_S2_FORMATO_2277 = [
            "Aporte pensión obligatoria efectuado aportante"
        ];

         const COLUMNAS_S2_FORMATO_2575 = [
            "Monto de la donación"
        ];

         const COLUMNAS_S2_FORMATO_5249 = [
            "IVA Descontable Contrato Colaboración Empresarial"
        ];

        const COLUMNAS_S2_FORMATO_5250 = [
            "VALOR IMPUESTO GENERADO"
        ];

        const COLUMNAS_S2_FORMATO_5251 = [
            "Cuentas por pagar en Consorcio o Uniones Temporales",
            "Mandante Pasivos Mandato",
            "Cuentas por pagar a Mandato"
        ];

        const COLUMNAS_S2_FORMATO_5252 = [
            "Cuentas por pagar en Consorcio o Uniones Temporales",
            "Cuentas por cobrar a Mandato"
        ];


        let datosBrutosParaExogena = [];
        let datosParaProcesar = [];
        let encabezadosOriginalesGlobal = [];
        let encabezadoCualitativoGlobal = [];

        let formatosProcesadosGlobal = {};
        let encabezadosS1Global = [];
        let masterEncabezadosS2List = [];
        let resumenGeneralData = {}; // NEW: To store calculated summary values
        let consolidatedResultsData = [];
        let organizedWorksheetGlobal = null; // Variable para almacenar la hoja organizada
        resumenGeneralData = {}; 
        
        /**
         * Parsea un valor a entero, limpiando primero caracteres no numéricos.
         * @param {*} value - El valor a parsear.
         * @returns {number} - El número parseado, o 0 si no es válido.
         */
        function parseCleanedInteger(value) {
            if (value === null || value === undefined || String(value).trim() === "") return 0;
            const cleanedString = String(value).replace(/[.,]/g, '');
            const num = parseInt(cleanedString, 10);
            return isNaN(num) ? 0 : num;
        }

        /**
         * Formatea un número al estilo de moneda colombiano.
         * @param {number | string} num - El número a formatear.
         * @param {boolean} makeNegativeRed - Si es verdadero, los números negativos se muestran en rojo.
         * @returns {string} - El número formateado como string.
         */
        function formatNumber(num, makeNegativeRed = false) {
            if (typeof num !== 'number') {
                const parsedNum = parseFloat(String(num));
                if (isNaN(parsedNum)) return num;
                num = parsedNum;
            }
            const formatted = num.toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            if (makeNegativeRed && num < 0) {
                return `<span class="negative-value">${formatted}</span>`;
            }
            return formatted;
        }

        /**
         * Normaliza un texto para comparación, haciéndolo más robusto.
         * @param {string} text - El texto a normalizar.
         * @returns {string} - El texto normalizado.
         */
        function normalizeText(text) {
            if (text === null || text === undefined) return "";
            let normalized = String(text)
                .toLowerCase()
                .trim()
                .replace(/[áäâàãåā]/g, 'a')
                .replace(/[éëêèēęė]/g, 'e')
                .replace(/[íïîìįī]/g, 'i')
                .replace(/[óöôòõøō]/g, 'o')
                .replace(/[úüûùū]/g, 'u')
                .replace(/[ñ]/g, 'n')
                .replace(/[ç]/g, 'c');
            
            normalized = normalized.replace(/[^a-z0-9>]/g, '');
            
            return normalized;
        }

        function esColumnaReteIVA(headerText) {
            const normText = normalizeText(headerText);
            return INCLUIDOS_RETEIVA_1001.map(normalizeText).includes(normText);
        }

        function esColumnaRetencionFuente(headerText) {
            const normText = normalizeText(headerText);
            return INCLUIDOS_RETEFUENTE_1001.map(normalizeText).includes(normText);
        }

        function esColumnaExcluidaIngresos(headerText) {
            const normText = normalizeText(headerText);
            return EXCLUIDOS_INGRESOS_1001.map(normalizeText).includes(normText);
        }

        function updateStatus(message) {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    // Restaura el color y grosor por defecto
    statusDiv.style.color = 'var(--secondary-color)';
    statusDiv.style.fontWeight = 'normal';
}

/**
 * Encuentra el índice de la fila que contiene el encabezado principal.
 * @param {object} worksheet - La hoja de cálculo de XLSX.
 * @returns {number} - El índice de la fila del encabezado, o -1 si no se encuentra.
 */
function findHeaderRow(worksheet) {
    if (!worksheet) return -1;
    const allData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
    for (let i = 0; i < allData.length; i++) {
        const row = allData[i];
        if (row && String(row[0]).trim() === "Código de Formato") {
            return i;
        }
    }
    return -1;
}


        /**
         * Maneja la selección y lectura del archivo Excel.
         */
        

// REEMPLAZA COMPLETAMENTE tu función handleFile actual con esta nueva versión asíncrona.
/**
 * Maneja la selección y lectura de los archivos Excel.
 */
/**
 * Maneja la selección y lectura de los archivos Excel.
 */
async function handleFile() {
    const fileInput = document.getElementById('archivoExcel');
    const validationDiv = document.getElementById('validation-summary');
    const btnProcesar = document.getElementById('btnProcesar');
    const btnExportar = document.getElementById('btnExportar');
    const btnGenerarPDF = document.getElementById('btnGenerarPDF');
    const btnExportarConsolidado = document.getElementById('btnExportarConsolidado');

    if (fileInput.files.length === 0) {
        updateStatus("Por favor, selecciona uno o más archivos Excel.");
        return;
    }

    // 1. Prepara la UI para el procesamiento por lotes
    btnProcesar.disabled = true;
    btnExportar.style.display = 'none';
    btnGenerarPDF.style.display = 'none';
    btnExportarConsolidado.style.display = 'none';

    // Resetea los resultados para el nuevo lote
    consolidatedResultsData = [];
    const files = Array.from(fileInput.files);
    let fileCounter = 0;
    let totalRowsForAllFiles = 0;

    // 2. Itera sobre cada archivo seleccionado
    for (const file of files) {
        fileCounter++;

        // Limpia la UI antes de procesar el siguiente archivo
        document.getElementById('tabHeader').innerHTML = '';
        document.getElementById('tabContentContainer').innerHTML = '';
        validationDiv.style.display = 'none';
        validationDiv.innerHTML = '';
        document.getElementById('file-name-display').textContent = file.name;
        updateStatus(`Procesando archivo ${fileCounter} de ${files.length}: ${file.name}...`);

        // Reinicia las variables globales que se usan por archivo
        datosBrutosParaExogena = [];
        datosParaProcesar = [];
        encabezadosOriginalesGlobal = [];
        encabezadoCualitativoGlobal = [];
        formatosProcesadosGlobal = {};
        organizedWorksheetGlobal = null;
        // <<< AÑADIR ESTA LÍNEA CLAVE >>>
        resumenGeneralData = {}; // Debe resetearse para cada archivo

        try {
            // 3. Lee el contenido de cada archivo de forma asíncrona
            const data = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (err) => reject(err);
                reader.readAsBinaryString(file);
            });

            // --- INICIO DE LA LÓGICA DE PROCESAMIENTO CORREGIDA ---
            let workbook = XLSX.read(data, { type: 'binary', cellStyles: true });
            let worksheet = workbook.Sheets[workbook.SheetNames[0]];

            // Llama a la función de organización y captura el índice de la fila del encabezado.
            const { organizedSheet, mainHeaderRowIndex } = organizeSheet(worksheet);
            organizedWorksheetGlobal = organizedSheet;

            const datosRaw = XLSX.utils.sheet_to_json(organizedWorksheetGlobal, { header: 1, defval: "" });
            if (datosRaw.length === 0) throw new Error("La hoja de Excel está vacía.");

            // Usa el índice de encabezado retornado, no lo busques de nuevo.
            const headerRowIdxFromProcessed = mainHeaderRowIndex;

            if (headerRowIdxFromProcessed === -1 || headerRowIdxFromProcessed === null) {
                throw new Error("No se encontró la fila de encabezados principal.");
            }

            // Si todo va bien, el resto del código se ejecuta
            if (headerRowIdxFromProcessed > 0) {
                encabezadoCualitativoGlobal = datosRaw.slice(0, headerRowIdxFromProcessed);
            } else {
                encabezadoCualitativoGlobal = [];
            }
            encabezadosOriginalesGlobal = datosRaw[headerRowIdxFromProcessed].map(h => String(h || "").trim());
            const dataRowsArrays = datosRaw.slice(headerRowIdxFromProcessed + 1);

            if (dataRowsArrays.length > 0) {
                datosBrutosParaExogena = dataRowsArrays.map(rowArray => {
                    const rowObject = {};
                    encabezadosOriginalesGlobal.forEach((header, index) => {
                        const uniqueKey = `${header}_idx${index}`;
                        rowObject[uniqueKey] = rowArray[index] !== undefined ? rowArray[index] : "";
                    });
                    return rowObject;
                }).filter(obj => Object.keys(obj).length > 0 && Object.values(obj).some(val => val !== "" && val !== null));
                datosParaProcesar = datosBrutosParaExogena.filter(obj => {
                    const key = Object.keys(obj).find(k => k.startsWith(CODIGO_FORMATO_KEY));
                    return key && String(obj[key]).trim() !== "";
                });
                totalRowsForAllFiles += datosParaProcesar.length;
            }
            // --- FIN DE LA LÓGICA DE PROCESAMIENTO CORREGIDA ---

            // 4. Procesa los datos y genera las tablas en la UI
            if (datosParaProcesar.length > 0 || datosBrutosParaExogena.length > 0) {
                procesarDatos();
                // **NUEVA CORRECCIÓN: Calcular los totales netos del 1019 directamente desde la data (F1019/1021/1026) antes de la UI.**
                calculate1019NetTotalsFromRawData();
                // Asegura que la tabla de resumen general se actualice inmediatamente con los valores calculados
                populateResumenGeneralTab(); 
            } else {
                throw new Error("No se encontraron datos para procesar después de los encabezados.");
            }

            // 5. Captura el resumen del archivo actual y lo guarda en la variable global
            updateStatus(`(${fileCounter}/${files.length}) Capturando resumen de: ${file.name}...`);
            // CORRECCIÓN CLAVE: Espera activa por estabilidad del DOM antes de capturar las cifras.
            await waitForDOMStability(); 
            const summaryData = captureFileSummaryData(file.name);
            consolidatedResultsData.push(summaryData);

        } catch (error) {
            console.error(`Error procesando el archivo ${file.name}:`, error);
            updateStatus(`Error en archivo ${file.name}: ${error.message}. Saltando al siguiente.`);
        }
    }

    document.getElementById('btnExportarOrganizado').style.display = 'inline-flex';


    // 6. Finaliza el proceso y habilita el botón de exportación consolidada
    updateStatus(`Procesamiento por lotes completado. Se procesaron ${totalRowsForAllFiles} filas en ${files.length} archivos.`);
    btnProcesar.disabled = false;
    if (consolidatedResultsData.length > 0) {
        btnExportarConsolidado.style.display = 'inline-flex';
    }

    if (fileInput.files.length > 0) {
        document.getElementById('btnExportarOrganizado').style.display = 'inline-flex';
    }
}




/**
 * Organiza una hoja de cálculo concatenando todos los bloques de datos verticalmente en una sola tabla.
 *
 * @param {object} worksheet - El objeto de la hoja de cálculo de XLSX.
 * @returns {object} Un objeto que contiene la hoja organizada y metadatos relevantes.
 */


function organizeSheet(worksheet) {
    const allData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: null });

    // 1. Encuentra todos los índices de las filas de encabezado.
    const headerRowIndices = allData.reduce((acc, row, index) => {
        if (row && String(row[0]).trim() === "Código de Formato") {
            acc.push(index);
        }
        return acc;
    }, []);

    const mainHeaderIndex = headerRowIndices[0];

    // Si no se encontraron encabezados o solo hay uno, retorna la hoja original.
    if (headerRowIndices.length <= 1 || mainHeaderIndex === undefined) {
        return {
            organizedSheet: worksheet,
            mainHeaderRowIndex: findHeaderRow(worksheet),
            totalRows: allData.length,
            finalLastCol: (allData[0] || []).length - 1
        };
    }

    // --- INICIO DE LA LÓGICA MEJORADA CON PRESERVACIÓN DE FORMATO 1001 ---

    let consolidatedData = [];
    
    // 2a. Copia la información cualitativa que está antes del primer encabezado.
    consolidatedData.push(...allData.slice(0, mainHeaderIndex));

    // 3. Define los parámetros base y el Encabezado Maestro.
    
    // 3.1. Base de Encabezados (H1)
    const h1Headers = allData[mainHeaderIndex];
    let masterHeaders = [...h1Headers];
    
    // Encuentra el índice de la columna "Reportado Como" en el encabezado principal (H1)
    const reportedComoHeader = "Reportado Como";
    const reportedComoIndexInH1 = h1Headers.findIndex(h => String(h).trim() === reportedComoHeader);
    
    if (reportedComoIndexInH1 === -1) {
         // Si no se encuentra el pivote, retorna la hoja original.
         return {
            organizedSheet: worksheet,
            mainHeaderRowIndex: mainHeaderIndex,
            totalRows: allData.length,
            finalLastCol: h1Headers.length - 1
        };
    }

    // Este es el índice *después* de "Reportado Como", donde comienzan los encabezados dinámicos.
    const dynamicHeaderStartCol = reportedComoIndexInH1 + 1;
    
    // --- NUEVA LÓGICA: IDENTIFICAR Y EXTRAER FILAS DEL FORMATO 1001 ---
    const formato1001Rows = [];
    
    // Buscar la columna "Código de Formato" en el encabezado
    const codigoFormatoIndex = h1Headers.findIndex(h => String(h || "").trim() === "Código de Formato");
    
    console.log("Índice de 'Código de Formato':", codigoFormatoIndex);
    console.log("Número de encabezados encontrados:", headerRowIndices.length);
    
    // Buscar filas con formato 1001 en TODOS los bloques de datos
    for (let i = 0; i < headerRowIndices.length; i++) {
        const currentHeaderIndex = headerRowIndices[i];
        const nextHeaderIndex = headerRowIndices[i + 1] || allData.length;
        const dataStartIndex = currentHeaderIndex + 1;
        
        for (let j = dataStartIndex; j < nextHeaderIndex; j++) {
            const row = allData[j];
            if (row && row[codigoFormatoIndex] && String(row[codigoFormatoIndex]).trim() === "1001") {
                console.log("Fila 1001 encontrada en índice:", j, "Bloque:", i);
                // Guardar la fila completa del formato 1001
                formato1001Rows.push([...row]);
            }
        }
    }
    
    console.log("Total de filas formato 1001 guardadas:", formato1001Rows.length);
    
    // 3.2. Procesa H2, H3, ... para expandir el Encabezado Maestro
    let accumulatedDynamicLength = masterHeaders.slice(dynamicHeaderStartCol).length;
    
    for (let i = 1; i < headerRowIndices.length; i++) {
        const currentHeaderIndex = headerRowIndices[i];
        const h_i_headers = allData[currentHeaderIndex];

        // 1. Encuentra el ancho físico real del bloque dinámico en la hoja.
        // Se basa en la última columna usada en la fila de encabezado (H_i).
        let lastUsedCol = dynamicHeaderStartCol - 1;
        for(let j = h_i_headers.length - 1; j >= dynamicHeaderStartCol; j--) {
            if(h_i_headers[j] !== null && String(h_i_headers[j]).trim() !== "") {
                lastUsedCol = j;
                break;
            }
        }
        const currentBlockPhysicalWidth = Math.max(0, lastUsedCol - dynamicHeaderStartCol + 1);

        // Extrae el bloque de encabezados dinámicos (incluyendo null/blanks)
        const rawDynamicHeaders = h_i_headers.slice(dynamicHeaderStartCol, dynamicHeaderStartCol + currentBlockPhysicalWidth);
        const currentDynamicLength = rawDynamicHeaders.length; 

        // Añade los encabezados dinámicos al Encabezado Maestro (al final)
        if (currentDynamicLength > 0) {
            // Ahora empujamos la lista completa (con nulls/blanks) al masterHeaders
            masterHeaders.push(...rawDynamicHeaders.map(h => String(h || "").trim() === "" ? null : h));
            accumulatedDynamicLength += currentDynamicLength;
        }
    }
    
    // 3.3. Normaliza el Encabezado Maestro (manteniendo la longitud)
    masterHeaders = masterHeaders.map(h => String(h || "").trim() === "" ? null : h);
    const masterHeaderLength = masterHeaders.length;
    
    // 4. Agrega el Encabezado Maestro al inicio de los datos.
    consolidatedData.push(masterHeaders);

    // 5. Consolidación de datos: Apila y alinea (padding).
    let currentDynamicOffset = 0;

    for (let i = 0; i < headerRowIndices.length; i++) {
        const currentHeaderIndex = headerRowIndices[i];
        const nextHeaderIndex = headerRowIndices[i + 1] || allData.length;
        
        // Bloque de datos (D_i) a transferir
        const dataStartIndex = currentHeaderIndex + 1;
        const dataBlock = allData.slice(dataStartIndex, nextHeaderIndex);
        
        // Determina la longitud dinámica del bloque actual (calculando el ancho físico real)
        const h_i_headers = allData[currentHeaderIndex];

        // 1. Vuelve a calcular el ancho físico real del bloque dinámico en la hoja.
        let lastUsedCol = dynamicHeaderStartCol - 1;
        for(let j = h_i_headers.length - 1; j >= dynamicHeaderStartCol; j--) {
            if(h_i_headers[j] !== null && String(h_i_headers[j]).trim() !== "") {
                lastUsedCol = j;
                break;
            }
        }
        const currentBlockPhysicalWidth = Math.max(0, lastUsedCol - dynamicHeaderStartCol + 1);
        
        // Esta es la longitud de referencia para el slicing y el offset
        const currentDynamicLength = currentBlockPhysicalWidth; 
        
        const offsetCols = currentDynamicOffset; 
        
        // --- PROCESAMIENTO DE LAS FILAS DE DATOS ---
        dataBlock.forEach(dataRow => {
            if (!dataRow || dataRow.every(cell => cell === null || String(cell).trim() === "")) {
                return; // Omitir filas completamente vacías
            }

            // FILTRAR: No procesar filas con formato 1001 (ya las guardamos)
            if (String(dataRow[codigoFormatoIndex]).trim() === "1001") {
                return; // Saltar esta fila, ya está guardada
            }

            const newRow = [];
            
            // 1. Copia la parte estática
            const staticData = dataRow.slice(0, dynamicHeaderStartCol).map(v => v === null ? "" : v);
            
            // 2. Crea el relleno inicial (padding)
            const paddingArrayStart = new Array(offsetCols).fill(""); 
            
            // 3. Copia el bloque dinámico REAL, limitado por currentDynamicLength (que ahora es el ancho físico)
            const rawDynamicSlice = dataRow.slice(dynamicHeaderStartCol, dynamicHeaderStartCol + currentDynamicLength);
            const dynamicData = rawDynamicSlice.map(v => v === null ? "" : v);

            // 4. Ensambla la fila: Estático + Relleno inicial + Datos dinámicos
            newRow.push(...staticData);
            newRow.push(...paddingArrayStart);
            newRow.push(...dynamicData);
            
            // 5. Agrega el relleno final necesario para completar masterHeaderLength
            const endPaddingLength = masterHeaderLength - newRow.length;
            if (endPaddingLength > 0) {
                newRow.push(...new Array(endPaddingLength).fill(""));
            }
            
            // 6. Agrega la fila consolidada
            consolidatedData.push(newRow);
        });
        
        // ACUMULA EL OFFSET para el siguiente bloque
        currentDynamicOffset += currentDynamicLength; // AHORA ACUMULA EL ANCHO FÍSICO
    }

    // --- AGREGAR LAS FILAS DEL FORMATO 1001 AL FINAL ---
    console.log("Filas formato 1001 encontradas:", formato1001Rows.length);
    
    if (formato1001Rows.length > 0) {
        formato1001Rows.forEach(row1001 => {
            const newRow = [];
            
            // Copiar toda la fila tal como está
            for (let j = 0; j < row1001.length; j++) {
                newRow.push(row1001[j] === null ? "" : row1001[j]);
            }
            
            // Rellenar hasta la longitud del encabezado maestro si es necesario
            while (newRow.length < masterHeaderLength) {
                newRow.push("");
            }
            
            // Truncar si es más larga que el encabezado maestro
            consolidatedData.push(newRow.slice(0, masterHeaderLength));
        });
        
        console.log("Filas formato 1001 agregadas al final. Total filas consolidadas:", consolidatedData.length);
    }

    // 6. Crea la nueva hoja de cálculo a partir de los datos consolidados.
    const newWorksheet = XLSX.utils.aoa_to_sheet(consolidatedData);
    
    // Reajusta el rango de la hoja
    const finalLastCol = masterHeaderLength - 1;
    const finalRange = { s: { r: 0, c: 0 }, e: { r: consolidatedData.length - 1, c: finalLastCol } };
    newWorksheet['!ref'] = XLSX.utils.encode_range(finalRange);
    
    // Retorna la nueva hoja organizada
    return {
        organizedSheet: newWorksheet,
        mainHeaderRowIndex: mainHeaderIndex, 
        totalRows: consolidatedData.length,
        finalLastCol: finalLastCol
    };
}





        function consolidateSheet(worksheet, mainHeaderRowIndex, totalRows, finalLastCol) {
            const getCell = (r, c) => worksheet[XLSX.utils.encode_cell({ r, c })];
            const headerRow = [];
            for (let c = 0; c <= finalLastCol; c++) {
                const cell = getCell(mainHeaderRowIndex, c);
                headerRow.push(cell ? cell.v : null);
            }

            const reportedAsCol = headerRow.indexOf('Reportado Como');
            if (reportedAsCol === -1) return worksheet;

            const baseColsCount = reportedAsCol + 1;
            const firstDynamicHeader = headerRow[baseColsCount];
            if (!firstDynamicHeader) return worksheet;

            const nextOccurrenceIndex = headerRow.indexOf(firstDynamicHeader, baseColsCount + 1);
            if (nextOccurrenceIndex === -1) return worksheet;

            const dynamicBlockWidth = nextOccurrenceIndex - baseColsCount;
            if (dynamicBlockWidth <= 0) return worksheet;

            const consolidatedCells = {}; let newRowCounter = mainHeaderRowIndex;

            for (let r = 0; r < mainHeaderRowIndex; r++) { for (let c = 0; c <= finalLastCol; c++) { const cell = getCell(r, c); if (cell) consolidatedCells[XLSX.utils.encode_cell({r, c})] = cell; } }
            for (let c = 0; c < baseColsCount; c++) { const cell = getCell(mainHeaderRowIndex, c); if (cell) consolidatedCells[XLSX.utils.encode_cell({r: newRowCounter, c})] = cell; }
            for (let c = 0; c < dynamicBlockWidth; c++) {
                const cell = getCell(mainHeaderRowIndex, baseColsCount + c);
                if (cell) consolidatedCells[XLSX.utils.encode_cell({r: newRowCounter, c: baseColsCount + c})] = cell;
            }
            newRowCounter++;

            for (let r = mainHeaderRowIndex + 1; r < totalRows; r++) {
                const baseData = [];
                for (let c = 0; c < baseColsCount; c++) { baseData.push(getCell(r, c)); }

                for (let blockStartCol = baseColsCount; blockStartCol <= finalLastCol; blockStartCol += dynamicBlockWidth) {
                    const blockData = []; let blockHasData = false;
                    for (let c = 0; c < dynamicBlockWidth; c++) {
                        const currentCol = blockStartCol + c;
                        if (currentCol > finalLastCol) break;
                        const cell = getCell(r, currentCol);
                        blockData.push(cell);
                        if (cell && (cell.v !== null && cell.v !== undefined && cell.v !== '')) blockHasData = true;
                    }
                    if (blockHasData) {
                        for (let c = 0; c < baseData.length; c++) { if (baseData[c]) consolidatedCells[XLSX.utils.encode_cell({r: newRowCounter, c})] = baseData[c]; }
                        for (let c = 0; c < blockData.length; c++) { if (blockData[c]) consolidatedCells[XLSX.utils.encode_cell({r: newRowCounter, c: baseColsCount + c})] = blockData[c]; }
                        newRowCounter++;
                    }
                }
            }

            const newFinalLastCol = baseColsCount + dynamicBlockWidth - 1;
            const newTotalRows = newRowCounter;
            const newWorksheet = {};
            for(const prop in worksheet) { if(prop.startsWith('!')) { newWorksheet[prop] = worksheet[prop]; } }
            Object.assign(newWorksheet, consolidatedCells);
            newWorksheet['!merges'] = (worksheet['!merges'] || []).filter(m => m.e.r < mainHeaderRowIndex);
            newWorksheet['!ref'] = XLSX.utils.encode_range({ s: { r: 0, c: 0 }, e: { r: newTotalRows - 1, c: newFinalLastCol } });
            return newWorksheet;
        }

        function procesarDatos() {
            encabezadosS1Global = ENCABEZADOS_SECCION_1.filter(h => encabezadosOriginalesGlobal.includes(h));
            masterEncabezadosS2List = [...new Set(encabezadosOriginalesGlobal.filter(h => h && !encabezadosS1Global.includes(h)))];

            formatosProcesadosGlobal = datosParaProcesar.reduce((acc, fila) => {
                const key = Object.keys(fila).find(k => k.startsWith(CODIGO_FORMATO_KEY));
                const codigoFormato = fila[key];
                if (codigoFormato) {
                    if (!acc[codigoFormato]) {
                        acc[codigoFormato] = [];
                    }
                    acc[codigoFormato].push(fila);
                }
                return acc;
            }, {});

            mostrarResultadosConPestanas();
            document.getElementById('btnExportar').style.display = 'inline-flex';
            document.getElementById('btnGenerarPDF').style.display = 'inline-flex';
            document.getElementById('btnProcesar').disabled = false;
            updateStatus("Procesamiento completado. Resultados mostrados abajo.");
        }

    


        function explotarYConsolidarFilas(filasOriginalesConIdx) {
            if (!filasOriginalesConIdx || filasOriginalesConIdx.length === 0) return [];

            const filasResultantes = [];

            filasOriginalesConIdx.forEach(filaConIdx => {
                const datosS1 = {};
                encabezadosS1Global.forEach(h => {
                    const key = Object.keys(filaConIdx).find(k => k.startsWith(h + '_idx'));
                    if(key) datosS1[h] = filaConIdx[key];
                });

                const gruposDeDatosS2 = {};
                masterEncabezadosS2List.forEach(headerS2 => {
                    const keysConIdx = Object.keys(filaConIdx).filter(k => k.startsWith(headerS2 + '_idx'));
                    keysConIdx.forEach((key, i) => {
                        const valor = filaConIdx[key];
                        if (valor !== "" && valor !== null && valor !== undefined) {
                            if (!gruposDeDatosS2[i]) {
                                gruposDeDatosS2[i] = {};
                            }
                            gruposDeDatosS2[i][headerS2] = valor;
                        }
                    });
                });

                if (Object.keys(gruposDeDatosS2).length === 0 && Object.values(datosS1).some(v => v)) {
                     filasResultantes.push({...datosS1});
                } else {
                    Object.values(gruposDeDatosS2).forEach(grupo => {
                        if (Object.keys(grupo).length > 0) {
                            filasResultantes.push({ ...datosS1, ...grupo });
                        }
                    });
                }
            });

            return filasResultantes;
        }




       // FUNCIÓN  NUEVA VERSIÓN informacion cualitativa
    
 // ▼▼▼ REEMPLAZA TU FUNCIÓN crearEncabezadoCualitativoHTML CON ESTA VERSIÓN ▼▼▼

function crearEncabezadoCualitativoHTML() {
    if (!encabezadoCualitativoGlobal || encabezadoCualitativoGlobal.length === 0) {
        return document.createDocumentFragment();
    }

    const headerDiv = document.createElement('div');
    const table = document.createElement('table');

    table.style.marginBottom = '1.5rem';
    table.style.border = 'none';

    const tbody = table.createTBody();

    for (const rowData of encabezadoCualitativoGlobal) {
        const textoPrimeraCelda = rowData && rowData[0] ? String(rowData[0]).trim() : "";

        if (textoPrimeraCelda === 'Formato') {
            break;
        }

        if (textoPrimeraCelda && !textoPrimeraCelda.includes('Consulta Realizada por:') && !textoPrimeraCelda.includes('Usuario')) {
            const tr = tbody.insertRow();
            
            const displayRowData = [...rowData];
            const label = displayRowData[0] || '';

            if (normalizeText(label).includes('fechageneracion')) {
                const dateValue = displayRowData[2];
                const dateObj = excelSerialDateToJSDate(Number(dateValue));
                if (dateObj) {
                    // --- CAMBIO AQUÍ ---
                    displayRowData[2] = dateObj.toLocaleString('es-CO'); 
                }
            }

            displayRowData.forEach((cellData, index) => {
                const cell = tr.insertCell();
                cell.textContent = cellData;

                if (index === 0) {
                    cell.style.border = 'none';
                    cell.style.background = 'transparent';
                    cell.style.fontWeight = 'normal';
                    cell.style.color = 'var(--text-secondary)';
                    cell.style.padding = '0.25rem 0.5rem';
                    cell.style.textAlign = 'left';
                    cell.style.whiteSpace = 'nowrap';
                } else if (index === 2) {
                    cell.style.border = 'none';
                    cell.style.background = 'transparent';
                    cell.style.fontWeight = 'bold';
                    cell.style.color = 'var(--text-primary)';
                    cell.style.whiteSpace = 'nowrap';
                    cell.style.padding = '0.25rem 0.5rem';
                    cell.style.textAlign = 'left';
                } else {
                     cell.style.border = 'none';
                     cell.style.background = 'transparent';
                }
            });
        }
    }

    if (tbody.rows.length > 0) {
        const tableWrapper = document.createElement('div');
        tableWrapper.style.overflowX = 'hidden';
        tableWrapper.appendChild(table);
        headerDiv.appendChild(tableWrapper);
    }

    return headerDiv;
}




function crearTablaHTML(tableId, filas, encabezados) {
    const container = document.createElement('div');

    // FIX: Filtra correctamente los encabezados basándose en las claves indexadas reales de los datos.
    const encabezadosAMostrar = encabezados.filter(header =>
        filas.some(fila => {
            const dataKey = Object.keys(fila).find(k => k.startsWith(header + '_idx'));
            const cellValue = dataKey ? fila[dataKey] : undefined;
            return cellValue !== undefined && cellValue !== null && String(cellValue).trim() !== "";
        })
    );

    container.appendChild(createTableActions(tableId));

    const resultsContainer = document.createElement('div');
    resultsContainer.className = 'results-container';

    const tabla = document.createElement('table');
    tabla.id = tableId;
    const thead = tabla.createTHead();
    const tbody = tabla.createTBody();
    const headerRow = thead.insertRow();

    encabezadosAMostrar.forEach((textoEncabezado) => {
        const th = document.createElement('th');
        th.textContent = textoEncabezado;

        const filterSelect = document.createElement('select');
        filterSelect.className = 'column-filter-select';
        filterSelect.onchange = () => applyAllColumnFilters(tableId);

        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = `-- Filtrar ${textoEncabezado.substring(0,10)} --`;
        filterSelect.appendChild(defaultOption);

        if (filas && filas.length > 0) {
            // FIX: Extrae correctamente los valores únicos para los filtros usando las claves indexadas.
            const uniqueValues = [...new Set(
                filas.map(fila => {
                    const dataKey = Object.keys(fila).find(k => k.startsWith(textoEncabezado + '_idx'));
                    return String(dataKey ? fila[dataKey] : "").trim();
                })
            )]
            .filter(val => val !== "")
            .sort((a,b) => String(a).localeCompare(String(b)));

            uniqueValues.forEach(valDisplay => {
                const option = document.createElement('option');
                option.value = normalizeText(valDisplay);
                option.textContent = valDisplay;
                filterSelect.appendChild(option);
            });
        }

        th.appendChild(document.createElement('br'));
        th.appendChild(filterSelect);
        headerRow.appendChild(th);
    });

    filas.forEach(filaProcesada => {
        const tr = tbody.insertRow();
        encabezadosAMostrar.forEach(header => {
            // FIX: Encuentra la clave de datos correcta (ej. "NIT_idx7") para el encabezado dado ("NIT").
            const dataKey = Object.keys(filaProcesada).find(k => k.startsWith(header + '_idx'));
            const cellValue = dataKey ? filaProcesada[dataKey] : undefined;
            const td = tr.insertCell();
            td.textContent = cellValue !== undefined ? cellValue : "";
        });
    });

    if (!filas || filas.length === 0 || encabezadosAMostrar.length === 0) {
        const p = document.createElement('p');
        p.textContent = "No se encontraron datos para esta tabla.";
        // Limpia el contenedor si no hay nada que mostrar.
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }
        container.appendChild(p);
    } else {
        resultsContainer.appendChild(tabla);
        container.appendChild(resultsContainer);
    }
    return container;
}

       

        function createTableActions(tableId) {
            const actionsDiv = document.createElement('div');
           
            return actionsDiv;
        }

        function clearAllColumnFilters(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            const filterSelects = table.getElementsByTagName("thead")[0].querySelectorAll('select.column-filter-select');
            filterSelects.forEach(select => select.value = '');
            applyAllColumnFilters(tableId);
        }

        function applyAllColumnFilters(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const headerRow = table.getElementsByTagName("thead")[0].getElementsByTagName("tr")[0];
    const filterSelects = headerRow.querySelectorAll('select.column-filter-select');
    const filters = [];
    filterSelects.forEach((selectElement, index) => {
        filters.push({ index: index, value: normalizeText(selectElement.value) });
    });

    const trs = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
    for (let i = 0; i < trs.length; i++) {
        let displayRow = true;
        const tds = trs[i].getElementsByTagName("td");
        for (const filter of filters) {
            if (filter.value !== "") {
                if (!tds[filter.index] || normalizeText(tds[filter.index].textContent) !== filter.value) {
                    displayRow = false;
                    break;
                }
            }
        }
        trs[i].style.display = displayRow ? "" : "none";
    }

    // Lógica para decidir qué función de totales llamar
    if (tableId.includes('1019-Movimientos')) {
        updateTotalsFor1019Movimientos(tableId);
    } else {
        // Se aplica a todas las demás tablas con totales
        updateTableTotals(tableId); 
    }
}

/**
 * Función genérica que recalcula los totales de una tabla basándose en las filas visibles.
 * @param {string} tableId - El ID de la tabla a actualizar.
 */
function updateTableTotals(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;

    const tfoot = table.querySelector('tfoot');
    const tbody = table.querySelector('tbody');
    if (!tfoot || !tbody || tfoot.rows.length === 0) return;

    const footerRow = tfoot.rows[tfoot.rows.length - 1];
    const totalColumns = new Array(footerRow.cells.length).fill(0);
    const headerCells = table.querySelector('thead tr').cells;
    const colSpanOffset = footerRow.cells[0].colSpan > 1 ? footerRow.cells[0].colSpan - 1 : 0;

    for (const row of tbody.rows) {
        if (row.style.display !== 'none') {
            for (let i = 0; i < row.cells.length; i++) {
                if (row.cells[i].classList.contains('numeric-cell')) {
                    const cellValue = parseCleanedInteger(row.cells[i].textContent);
                    const footerCellIndex = i - colSpanOffset;
                    if (footerCellIndex >= 0) {
                       totalColumns[footerCellIndex] += cellValue;
                    }
                }
            }
        }
    }

    for (let i = 1; i < footerRow.cells.length; i++) {
        const cell = footerRow.cells[i];
        const isNegative = tableId.includes('1007') && cell.dataset.header && cell.dataset.header.includes("devolucion");
        cell.innerHTML = formatNumber(totalColumns[i], isNegative);
    }
}

/**
 * Función específica para recalcular los totales de la tabla de Movimientos del formato 1019.
 * @param {string} tableId - El ID de la tabla de movimientos.
 */

function updateTotalsFor1019Movimientos(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;

    const tfoot = table.querySelector('tfoot');
    const tbody = table.querySelector('tbody');
    const thead = table.querySelector('thead');
    if (!tfoot || !tbody || !thead || tfoot.rows.length < 3) return;

    // --- CORRECCIÓN CLAVE: Encontrar los índices de Crédito y Débito dinámicamente ---
   const headerCells = Array.from(thead.querySelectorAll('th'));
    let creditoCellIndex = -1;
    let debitoCellIndex = -1;

    headerCells.forEach((th, index) => {
        // Obtenemos el texto sin el filtro desplegable (si existe) y lo normalizamos
        const headerText = th.textContent.split('--')[0].trim();
        
        // Normalización y verificación simple
        const normText = normalizeText(headerText); 

        if (normText.includes("valortotalperiodomovimientocreditocuenta")) {
            creditoCellIndex = index;
        } else if (normText.includes("valortotalmovimientosdebitocuenta")) {
            debitoCellIndex = index;
        }
    });

    if (creditoCellIndex === -1 || debitoCellIndex === -1) {
        console.error("No se encontraron los encabezados de Crédito/Débito en la tabla 1019. Crédito: " + creditoCellIndex + ", Débito: " + debitoCellIndex);
        return;
    }
    // Fin de la corrección dinámica de índices

    let totalCreditoBruto = 0;
    let totalDebitoBruto = 0;

    // 1. Calcula los totales brutos de las filas visibles
    for (const row of tbody.rows) {
        if (row.style.display !== 'none') {
            // Usa los índices dinámicamente encontrados en el thead
            if(row.cells[creditoCellIndex]) {
                totalCreditoBruto += parseCleanedInteger(row.cells[creditoCellIndex].textContent);
            }
            if(row.cells[debitoCellIndex]) {
                totalDebitoBruto += parseCleanedInteger(row.cells[debitoCellIndex].textContent);
            }
        }
    }

    // 2. Actualiza la fila de "Total Bruto" (tfoot.rows[0])
    // La celda de etiqueta tiene un colspan, las celdas de valor son el resto
    tfoot.rows[0].cells[1].innerHTML = formatNumber(totalCreditoBruto);
    if(tfoot.rows[0].cells[2]) tfoot.rows[0].cells[2].innerHTML = formatNumber(totalDebitoBruto);

    // 3. Obtiene el valor del ajuste (F1026) pre-calculado globalmente.
    const sumaBeneficiarioPrestamo1026 = resumenGeneralData['1026-ajuste-bruto'] || 0;

    // --- 4. Muestra el valor de F1026 en la fila de ajuste (tfoot.rows[1]) ---
    const ajusteCreditoCell = tfoot.rows[1].cells[1];
    if (ajusteCreditoCell) {
        // Se muestra el valor con formato negativo (true)
        ajusteCreditoCell.innerHTML = formatNumber(sumaBeneficiarioPrestamo1026, true);
    }

    // 5. Calcula el total neto (Movimientos Netos)
    const totalCreditoNeto = totalCreditoBruto - sumaBeneficiarioPrestamo1026;
    const totalDebitoNeto = totalDebitoBruto; // El débito no tiene ajuste F1026

    // --- 6. Muestra los resultados netos en la fila Total Movimientos Netos (tfoot.rows[2]) ---
    
    // Crédito Neto
    tfoot.rows[2].cells[1].innerHTML = formatNumber(totalCreditoNeto);
    
    // Débito Neto
    if (tfoot.rows[2].cells[2]) {
        tfoot.rows[2].cells[2].innerHTML = formatNumber(totalDebitoNeto);
    }
}


/**
 * Genera la tabla de resumen para los formatos 1001 y 5247.
 * @param {Array<Object>} filasDelFormatoOriginal - Datos del formato sin consolidar horizontalmente.
 * @param {string} tipoResumen - 'ingresos', 'retencionFuente', o 'reteIVA'.
 * @param {Array<string>} encabezadosS2ActivosFormato - Encabezados S2 activos en el formato.
 * @param {string} tituloTabla - Título de la tabla.
 * @param {string} tableIdSuffix - Sufijo para el ID de la tabla.
 * @returns {Object} Un objeto con el elemento HTML de la tabla y el total.
 */
function generarTablaResumen1001y5247(filasDelFormatoOriginal, tipoResumen, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix) {
    const tableId = `summaryTable-${tableIdSuffix}-${tipoResumen}`;

    const containerGeneral = document.createElement('div');
    const tituloH3 = document.createElement('h3');
    tituloH3.className = 'summary-table-title';
    tituloH3.textContent = tituloTabla;
    containerGeneral.appendChild(tituloH3);

    if (filasDelFormatoOriginal.length === 0) {
        return { element: document.createDocumentFragment(), total: 0 };
    }

    const s1KeysForGrouping = [CODIGO_CONCEPTO_KEY];
    const s1HeadersForDisplayInRow = ENCABEZADOS_S1_FILA_RESUMEN_1001;
    
    // Lista de encabezados a excluir de la suma total
    const palabrasClaveAExcluir = [
        "documento",
        "titulo",
        "participacion", 
        "propiedad",
        "fecha",
        "propietarios",
        "matricula"
    ];

    let columnasS2ParaEstaTabla = [];
    if (tipoResumen === 'ingresos') {
         columnasS2ParaEstaTabla = encabezadosS2ActivosFormato.filter(h => !esColumnaExcluidaIngresos(h));
    } else if (tipoResumen === 'retencionFuente') {
        columnasS2ParaEstaTabla = encabezadosS2ActivosFormato.filter(h => esColumnaRetencionFuente(h));
    } else if (tipoResumen === 'reteIVA') {
        columnasS2ParaEstaTabla = encabezadosS2ActivosFormato.filter(h => esColumnaReteIVA(h));
    }

    // Se filtra la lista de columnas que no tienen valores diferentes a cero
    const headersToShowInTable = [...new Set(columnasS2ParaEstaTabla)].filter(colS2 =>
        Object.values(filasDelFormatoOriginal.reduce((acc, fila) => {
            const claveAgrupacion = s1KeysForGrouping.map(key => fila[key] || "N/A").join('|');
            if (!acc[claveAgrupacion]) acc[claveAgrupacion] = { s2Values: {} };
            if (!acc[claveAgrupacion].s2Values[colS2]) acc[claveAgrupacion].s2Values[colS2] = 0;
            acc[claveAgrupacion].s2Values[colS2] += parseCleanedInteger(fila[colS2]);
            return acc;
        }, {})).some(dataGrupo => dataGrupo.s2Values[colS2] && dataGrupo.s2Values[colS2] !== 0)
    );

    // Se crea una lista separada para las columnas que deben totalizarse
    const columnasS2ParaSumar = headersToShowInTable.filter(h => {
        const normH = normalizeText(h);
        return !palabrasClaveAExcluir.some(keyword => normH.includes(keyword));
    });

    const agrupadoPorClaveCompuesta = filasDelFormatoOriginal.reduce((acc, fila) => {
        const claveAgrupacion = s1KeysForGrouping.map(key => fila[key] || "N/A").join('|');
        if (!acc[claveAgrupacion]) {
            acc[claveAgrupacion] = { s1Data: {}, s2Values: {} };
            s1HeadersForDisplayInRow.forEach(key => acc[claveAgrupacion].s1Data[key] = fila[key] || "N/A");
        }
        headersToShowInTable.forEach(hS2 => {
            if (!acc[claveAgrupacion].s2Values[hS2]) acc[claveAgrupacion].s2Values[hS2] = 0;
            acc[claveAgrupacion].s2Values[hS2] += parseCleanedInteger(fila[hS2]);
        });
        return acc;
    }, {});
    
    if (headersToShowInTable.length === 0) {
        return { element: document.createDocumentFragment(), total: 0 };
    }

    containerGeneral.appendChild(createTableActions(tableId));
    const resultsContainer = document.createElement('div');
    resultsContainer.className = 'results-container';
    const tabla = document.createElement('table');
    tabla.id = tableId;
    const thead = tabla.createTHead();
    const tbody = tabla.createTBody();
    const tfoot = tabla.createTFoot();
    resultsContainer.appendChild(tabla);
    containerGeneral.appendChild(resultsContainer);

    const headerRow = thead.insertRow();
    const encabezadosCompletosTablaResumen = [...s1HeadersForDisplayInRow, ...headersToShowInTable, "Total"];

    const filasParaDropdowns = Object.values(agrupadoPorClaveCompuesta).map(item => {
        const fila = {...item.s1Data};
        headersToShowInTable.forEach(hS2 => fila[hS2] = item.s2Values[hS2] || 0);
        fila["Total"] = columnasS2ParaSumar.reduce((sum, hS2) => sum + (item.s2Values[hS2] || 0), 0);
        return fila;
    }).filter(fila => fila["Total"] !== 0);

    encabezadosCompletosTablaResumen.forEach((textoEncabezado) => {
        const th = document.createElement('th');
        th.textContent = textoEncabezado;
        const filterSelect = document.createElement('select');
        filterSelect.className = 'column-filter-select';
        filterSelect.onchange = () => applyAllColumnFilters(tableId);
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = `-- Filtrar ${String(textoEncabezado).substring(0,10)} --`;
        filterSelect.appendChild(defaultOption);

        if (filasParaDropdowns.length > 0) {
             const uniqueValues = [...new Set(filasParaDropdowns.map(fila => {
                const val = fila[textoEncabezado];
                if (headersToShowInTable.includes(textoEncabezado) || textoEncabezado === "Total") {
                    return typeof val === 'number' ? formatNumber(val) : String(val || "").trim();
                }
                return String(val || "").trim();
            }))]
            .filter(val => val !== "")
            .sort((a,b) => {
                const valA = String(a);
                const valB = String(b);
                const numA = parseFloat(valA.replace(/[^\d,.-]/g, '').replace(',','.'));
                const numB = parseFloat(valB.replace(/[^\d,.-]/g, '').replace(',','.') === valB);
                if (!isNaN(numA) && !isNaN(numB) && valA.replace(/[^\d,.-]/g, '').replace(',','.') === valA && valB.replace(/[^\d,.-]/g, '').replace(',','.') === valB) {
                   if (numA < numB) return -1;
                   if (numA > numB) return 1;
                   return 0;
                }
                return valA.localeCompare(valB);
            });

            uniqueValues.forEach(valDisplay => {
                const option = document.createElement('option');
                option.value = normalizeText(valDisplay);
                option.textContent = valDisplay;
                filterSelect.appendChild(option);
            });
        }
        th.appendChild(document.createElement('br'));
        th.appendChild(filterSelect);
        headerRow.appendChild(th);
    });

    const totalesVerticales = {};
    headersToShowInTable.forEach(h => totalesVerticales[h] = 0);
    let granTotalHorizontal = 0;

    filasParaDropdowns.forEach(dataGrupo => {
        const tr = tbody.insertRow();
        s1HeadersForDisplayInRow.forEach(hS1 => {
            const td = tr.insertCell();
            td.textContent = dataGrupo[hS1];
             if (hS1 === CODIGO_FORMATO_KEY) {
                td.classList.add('code-format-cell');
            }
        });

        headersToShowInTable.forEach(hS2 => {
            const td = tr.insertCell();
            const valor = dataGrupo[hS2] || 0;
            if (columnasS2ParaSumar.includes(hS2)) {
                td.classList.add('numeric-cell');
                td.innerHTML = formatNumber(valor);
                totalesVerticales[hS2] += valor;
            } else {
                td.textContent = valor;
            }
        });
        const tdTotalHorizontal = tr.insertCell();
        tdTotalHorizontal.classList.add('numeric-cell');
        tdTotalHorizontal.innerHTML = formatNumber(dataGrupo["Total"]);
        granTotalHorizontal += dataGrupo["Total"];
    });

    const footerRow = tfoot.insertRow();
    const tdFooterLabel = footerRow.insertCell();
    tdFooterLabel.colSpan = s1HeadersForDisplayInRow.length;
    tdFooterLabel.textContent = "TOTALES";

    headersToShowInTable.forEach(hS2 => {
        const td = footerRow.insertCell();
        td.classList.add('numeric-cell');
        if (columnasS2ParaSumar.includes(hS2)) {
            td.innerHTML = formatNumber(totalesVerticales[hS2] || 0);
        } else {
            td.textContent = '-';
            td.style.textAlign = 'center';
        }
    });
    const tdGranTotal = footerRow.insertCell();
    tdGranTotal.classList.add('numeric-cell');
    tdGranTotal.innerHTML = formatNumber(granTotalHorizontal);

    return { element: containerGeneral, total: granTotalHorizontal };
}





        

        function generarTablaResumenGeneral(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix, s1Headers = ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, s2Headers = null, conTotalHorizontal = true) {
            const tableId = `summaryTable-${tableIdSuffix}`; // REMOVED -general
            const s1HeadersToDisplay = s1Headers;
            
            const sourceHeaders = s2Headers ? s2Headers : encabezadosS2ActivosFormato;
            const headerMap = {};
            const columnasS2ParaEstaTabla = [];

             sourceHeaders.forEach(h_predefinida => {
                const h_real = encabezadosS2ActivosFormato.find(h_activo => normalizeText(h_activo) === normalizeText(h_predefinida));
                if (h_real) {
                    headerMap[h_predefinida] = h_real; 
                    columnasS2ParaEstaTabla.push(h_predefinida); 
                }
            });

            const filasPrincipalesOVacias = filasDelFormatoOriginal;

            const containerGeneral = document.createElement('div');
            const tituloH3 = document.createElement('h3');
            tituloH3.className = 'summary-table-title';
            tituloH3.textContent = tituloTabla;
            containerGeneral.appendChild(tituloH3);

            if (filasPrincipalesOVacias.length === 0) {
                const p = document.createElement('p');
                p.textContent = `No hay datos para generar el resumen.`;
                containerGeneral.appendChild(p);
                return { element: containerGeneral, total: 0 };
            }

            const agrupadoPorClaveCompuesta = filasPrincipalesOVacias.reduce((acc, fila) => {
                const claveAgrupacion = s1HeadersToDisplay.map(key => fila[key] || "N/A").join('|');

                if (!acc[claveAgrupacion]) {
                    acc[claveAgrupacion] = { s1Data: {}, s2Values: {} };
                    s1HeadersToDisplay.forEach(key => {
                        acc[claveAgrupacion].s1Data[key] = fila[key] || "N/A";
                    });
                }

                columnasS2ParaEstaTabla.forEach(hS2 => {
                     const h_real = headerMap[hS2];
                    if (!acc[claveAgrupacion].s2Values[hS2]) acc[claveAgrupacion].s2Values[hS2] = 0;
                    let valor = parseCleanedInteger(fila[h_real]);
                     if (tableIdSuffix.includes('1007') && normalizeText(hS2).includes("devolucion")) {
                        valor = -valor;
                    }
                    acc[claveAgrupacion].s2Values[hS2] += valor;
                });
                return acc;
            }, {});
            
            const columnasS2Finales = columnasS2ParaEstaTabla.filter(colS2 =>
                Object.values(agrupadoPorClaveCompuesta).some(dataGrupo => dataGrupo.s2Values[colS2] && dataGrupo.s2Values[colS2] !== 0)
            );


            if (Object.keys(agrupadoPorClaveCompuesta).length === 0 || columnasS2Finales.length === 0) {
                const p = document.createElement('p');
                p.textContent = `No hay datos agrupados con valores para el resumen.`;
                containerGeneral.appendChild(p);
                return { element: containerGeneral, total: 0 };
            }

            containerGeneral.appendChild(createTableActions(tableId));
            const resultsContainer = document.createElement('div');
            resultsContainer.className = 'results-container';
            const tabla = document.createElement('table');
            tabla.id = tableId;
            const thead = tabla.createTHead();
            const tbody = tabla.createTBody();
            const tfoot = tabla.createTFoot();
            resultsContainer.appendChild(tabla);
            containerGeneral.appendChild(resultsContainer);

            const headerRow = thead.insertRow();
            let encabezadosCompletosTablaResumen = [...s1HeadersToDisplay, ...columnasS2Finales];
             if (conTotalHorizontal) {
                encabezadosCompletosTablaResumen.push("Total");
            }


            const filasParaDropdowns = Object.values(agrupadoPorClaveCompuesta).map(item => {
                const fila = { ...item.s1Data };
                columnasS2Finales.forEach(hS2 => fila[hS2] = item.s2Values[hS2] || 0);
                if (conTotalHorizontal) {
                    fila["Total"] = columnasS2Finales.reduce((sum, hS2) => sum + (item.s2Values[hS2] || 0), 0);
                }
                return fila;
            }).filter(fila => {
                if (conTotalHorizontal) return fila["Total"] !== 0;
                return columnasS2Finales.some(hS2 => fila[hS2] !== 0)
            });


            encabezadosCompletosTablaResumen.forEach((textoEncabezado) => {
                const th = document.createElement('th');
                th.textContent = textoEncabezado;
                const filterSelect = document.createElement('select');
                filterSelect.className = 'column-filter-select';
                filterSelect.onchange = () => applyAllColumnFilters(tableId);
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = `-- Filtrar ${String(textoEncabezado).substring(0, 10)} --`;
                filterSelect.appendChild(defaultOption);

                if (filasParaDropdowns.length > 0) {
                     const uniqueValues = [...new Set(filasParaDropdowns.map(fila => {
                        const val = fila[textoEncabezado];
                        return (typeof val === 'number') ? formatNumber(val) : String(val || "").trim();
                    }))].filter(val => val !== "").sort((a,b)=>String(a).localeCompare(String(b)));

                    uniqueValues.forEach(valDisplay => {
                        const option = document.createElement('option');
                        option.value = normalizeText(valDisplay);
                        option.textContent = valDisplay;
                        filterSelect.appendChild(option);
                    });
                }
                th.appendChild(document.createElement('br'));
                th.appendChild(filterSelect);
                headerRow.appendChild(th);
            });

            const totalesVerticales = {};
            columnasS2Finales.forEach(h => totalesVerticales[h] = 0);
            let granTotalHorizontal = 0;

            filasParaDropdowns.forEach(dataGrupo => {
                const tr = tbody.insertRow();
                s1HeadersToDisplay.forEach(hS1 => {
                    const td = tr.insertCell();
                    td.textContent = dataGrupo[hS1];
                     if (hS1 === CODIGO_FORMATO_KEY) {
                        td.classList.add('code-format-cell');
                    }
                });
                columnasS2Finales.forEach(hS2 => {
                    const td = tr.insertCell();
                    td.classList.add('numeric-cell');
                    const valor = dataGrupo[hS2] || 0;
                    td.innerHTML = formatNumber(valor, tableIdSuffix.includes('1007') && normalizeText(hS2).includes("devolucion"));
                    totalesVerticales[hS2] += valor;
                });
                if (conTotalHorizontal) {
                    const tdTotalHorizontal = tr.insertCell();
                    tdTotalHorizontal.classList.add('numeric-cell');
                    tdTotalHorizontal.innerHTML = formatNumber(dataGrupo["Total"]);
                    granTotalHorizontal += dataGrupo["Total"];
                }
            });

            const footerRow = tfoot.insertRow();
            const tdFooterLabel = footerRow.insertCell();
            tdFooterLabel.colSpan = s1HeadersToDisplay.length;
            tdFooterLabel.textContent = "TOTALES";
            columnasS2Finales.forEach(hS2 => {
                const td = footerRow.insertCell();
                td.classList.add('numeric-cell');
                td.innerHTML = formatNumber(totalesVerticales[hS2] || 0, tableIdSuffix.includes('1007') && normalizeText(hS2).includes("devolucion"));
            });

            if (conTotalHorizontal) {
                const tdGranTotal = footerRow.insertCell();
                tdGranTotal.classList.add('numeric-cell');
               tdGranTotal.innerHTML = formatNumber(granTotalHorizontal); // AHORA USA EL TOTAL CALCULADO
            }
            
                updateTableTotals(tableId);

            return { element: containerGeneral, total: granTotalHorizontal };
        }
        

        
        function generarTablaResumenFormato1006(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix) {
             return generarTablaResumenGeneral(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix, ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_1006);
        }
        
        function generarTablaResumenFormato1008(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix) {
             return generarTablaResumenGeneral(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix, ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_1008);
        }
        function generarTablaResumenFormato1009(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix) {
             return generarTablaResumenGeneral(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix, ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_1009);
        }


function generarTablaResumenMovimientos1019(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix) {
    const tableId = `summaryTable-<span class="math-inline">\{tableIdSuffix\}\-</span>{tituloTabla.replace(/\s+/g, '')}`;
    const s1HeadersToDisplay = ENCABEZADOS_S1_FILA_RESUMEN_1019_MOVIMIENTOS.filter(h => h !== PERIODO_KEY);
    const s2HeadersToSum = COLUMNAS_S2_FORMATO_1019_MOVIMIENTOS.filter(h => encabezadosS2ActivosFormato.includes(h));

    let filasCombinadas = [...filasDelFormatoOriginal];
    if (String(tableIdSuffix) === "1019" && formatosProcesadosGlobal['1021']) {
        if (!filasDelFormatoOriginal.some(f => String(f[CODIGO_FORMATO_KEY]) === '1021')) {
            filasCombinadas.push(...explotarYConsolidarFilas(formatosProcesadosGlobal['1021']));
        }
    }

    const filasPrincipalesOVacias = filasCombinadas.filter(fila => {
        const reportadoComoNorm = normalizeText(fila[REPORTADO_COMO_KEY]);
        const formatoValido = String(fila[CODIGO_FORMATO_KEY]) === '1019' || String(fila[CODIGO_FORMATO_KEY]) === '1021';
        return formatoValido && (reportadoComoNorm === 'principal' || reportadoComoNorm === '');
    });

    const containerGeneral = document.createElement('div');
    const tituloH3 = document.createElement('h3');
    tituloH3.className = 'summary-table-title';
    tituloH3.textContent = tituloTabla;
    containerGeneral.appendChild(tituloH3);

    if (filasPrincipalesOVacias.length === 0 || s2HeadersToSum.length === 0) {
        const p = document.createElement('p');
        p.textContent = `No hay datos aplicables para la tabla de ${tituloTabla}.`;
        containerGeneral.appendChild(p);
        return containerGeneral;
    }

    const agrupadoPorClave = filasPrincipalesOVacias.reduce((acc, fila) => {
        const claveAgrupacion = s1HeadersToDisplay.map(key => fila[key] || "N/A").join('|');
        if (!acc[claveAgrupacion]) {
            acc[claveAgrupacion] = { s1Data: {}, s2Values: {} };
            s1HeadersToDisplay.forEach(key => {
               acc[claveAgrupacion].s1Data[key] = fila[key] || "N/A";
            });
        }
        s2HeadersToSum.forEach(hS2 => {
            if (!acc[claveAgrupacion].s2Values[hS2]) acc[claveAgrupacion].s2Values[hS2] = 0;
            acc[claveAgrupacion].s2Values[hS2] += parseCleanedInteger(fila[hS2]);
        });
        return acc;
    }, {});

    containerGeneral.appendChild(createTableActions(tableId));
    const resultsContainer = document.createElement('div');
    resultsContainer.className = 'results-container';
    const tabla = document.createElement('table');
    tabla.id = tableId;
    const thead = tabla.createTHead();
    const tbody = tabla.createTBody();
    const tfoot = tabla.createTFoot();
    resultsContainer.appendChild(tabla);
    containerGeneral.appendChild(resultsContainer);

    const headerRow = thead.insertRow();
    const encabezadosCompletosTabla = [...s1HeadersToDisplay, ...s2HeadersToSum];

    const filasParaTabla = Object.values(agrupadoPorClave).map(item => {
        const fila = { ...item.s1Data };
        s2HeadersToSum.forEach(hS2 => fila[hS2] = item.s2Values[hS2] || 0);
        return fila;
    }).filter(fila => s2HeadersToSum.some(hS2 => fila[hS2] !== 0));


    encabezadosCompletosTabla.forEach((textoEncabezado) => {
        const th = document.createElement('th');
        th.textContent = textoEncabezado;
        const filterSelect = document.createElement('select');
        filterSelect.className = 'column-filter-select';
        filterSelect.onchange = () => applyAllColumnFilters(tableId);
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = `-- Filtrar ${String(textoEncabezado).substring(0,10)} --`;
        filterSelect.appendChild(defaultOption);
        if (filasParaTabla.length > 0) {
            const uniqueValues = [...new Set(filasParaTabla.map(fila => String(fila[textoEncabezado] || "").trim()))].filter(val => val !== "").sort((a,b) => String(a).localeCompare(String(b)));
            uniqueValues.forEach(valDisplay => {
                const option = document.createElement('option');
                option.value = normalizeText(valDisplay);
                option.textContent = valDisplay;
                filterSelect.appendChild(option);
            });
        }
        th.appendChild(document.createElement('br'));
        th.appendChild(filterSelect);
        headerRow.appendChild(th);
    });

    filasParaTabla.forEach(dataGrupo => {
        const tr = tbody.insertRow();
        s1HeadersToDisplay.forEach(hS1 => {
            const td = tr.insertCell();
            td.textContent = dataGrupo[hS1];
             if (hS1 === CODIGO_FORMATO_KEY) {
                td.classList.add('code-format-cell');
            }
        });
        s2HeadersToSum.forEach(hS2 => {
            const td = tr.insertCell();
            td.classList.add('numeric-cell');
            const valor = dataGrupo[hS2] || 0;
            td.innerHTML = formatNumber(valor);
        });
    });

// --- Creación del pie de página (tfoot) con estructura clara ---
    
    // Se calcula la cantidad de columnas S1 que tienen colspan
    const s1Colspan = s1HeadersToDisplay.length;
    // Se calcula la cantidad de columnas de valor (Crédito y Débito, normalmente 2)
    const s2ValueCount = s2HeadersToSum.length;

    // Fila 1: Total Bruto
    const trTotalBruto = tfoot.insertRow();
    const tdLabelTotalBruto = trTotalBruto.insertCell();
    tdLabelTotalBruto.colSpan = s1Colspan;
    tdLabelTotalBruto.textContent = "Total Bruto";
    for (let i = 0; i < s2ValueCount; i++) {
        const td = trTotalBruto.insertCell();
        td.classList.add('numeric-cell');
        td.innerHTML = formatNumber(0);
    }

    if (tableIdSuffix === '1019') {
        // Fila 2: Ajuste F1026
        const tr1026 = tfoot.insertRow();
        const tdLabel1026 = tr1026.insertCell();
        tdLabel1026.colSpan = s1Colspan;
        tdLabel1026.textContent = "(-) Préstamos Bancarios Otorgados (F1026)";
        
        // Columna de Crédito (ajuste)
        const tdValorCredito1026 = tr1026.insertCell();
        tdValorCredito1026.classList.add('numeric-cell');
        tdValorCredito1026.innerHTML = formatNumber(0);
        
        // Columna de Débito (si existe)
        if (s2ValueCount > 1) { 
            const tdValorDebito1026 = tr1026.insertCell();
            tdValorDebito1026.classList.add('numeric-cell');
            tdValorDebito1026.textContent = "-"; // El ajuste no aplica a Débito
            tdValorDebito1026.style.textAlign = 'center';
        }

        // Fila 3: Total Movimientos Netos
        const trTotalNeto = tfoot.insertRow();
        const tdLabelTotalNeto = trTotalNeto.insertCell();
        tdLabelTotalNeto.colSpan = s1Colspan;
        tdLabelTotalNeto.textContent = "Total Movimientos Netos";
        
        // Columna de Crédito Neto
        const tdValorTotalNetoCredito = trTotalNeto.insertCell();
        tdValorTotalNetoCredito.classList.add('numeric-cell');
        tdValorTotalNetoCredito.innerHTML = formatNumber(0);
        
        // Columna de Débito Neto (si existe)
        if (s2ValueCount > 1) {
            const tdValorTotalNetoDebito = trTotalNeto.insertCell();
            tdValorTotalNetoDebito.classList.add('numeric-cell');
            tdValorTotalNetoDebito.innerHTML = formatNumber(0);
        }
    }
    
    setTimeout(() => {
        updateTotalsFor1019Movimientos(tableId);
    }, 50);
    return containerGeneral;

}

    

        function generarTablaResumenSaldoCuentas1019(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix) {
            const tableId = `summaryTable-${tableIdSuffix}-${tituloTabla.replace(/\s+/g, '')}`;
            const s1HeadersToDisplay = ENCABEZADOS_S1_FILA_RESUMEN_1019_PATRIMONIO;

           const containerGeneral = document.createElement('div');
    const tituloH3 = document.createElement('h3');
    tituloH3.className = 'summary-table-title';
    tituloH3.textContent = tituloTabla;
    containerGeneral.appendChild(tituloH3);

    // CORRECCIÓN 1: Se aplica el filtro combinado para Periodo '12' Y Reportado Como 'principal'.
    const filasFiltradas = filasDelFormatoOriginal.filter(fila => {
        const reportadoComo = normalizeText(fila[REPORTADO_COMO_KEY] || '');
        const periodo = String(fila[PERIODO_KEY] || '').trim();
        return (reportadoComo === 'principal' || reportadoComo === '') && periodo === '12';
    });

    if (filasFiltradas.length === 0) {
        const p = document.createElement('p');
        p.textContent = `No hay datos para el Periodo 12 de tipo "Principal" para generar la tabla de ${tituloTabla}.`;
        containerGeneral.appendChild(p);
        return containerGeneral;
    }

    // CORRECCIÓN 2: La lógica de agrupación ahora es más simple y solo suma los valores ya filtrados.
    const agrupadoPorClave = filasFiltradas.reduce((acc, fila) => {
        const claveAgrupacion = fila[CODIGO_CONCEPTO_KEY] || "N/A_Concepto";

        if (!acc[claveAgrupacion]) {
            acc[claveAgrupacion] = {
                s1Data: {},
                s2Value: 0
            };
            s1HeadersToDisplay.forEach(key => {
                acc[claveAgrupacion].s1Data[key] = fila[key] || "N/A";
            });
        }

        acc[claveAgrupacion].s2Value += parseCleanedInteger(fila[COLUMNAS_S2_FORMATO_1019_SALDOS[0]]);
        return acc;
    }, {});

    containerGeneral.appendChild(createTableActions(tableId));
    const resultsContainer = document.createElement('div');
    resultsContainer.className = 'results-container';
    const tabla = document.createElement('table');
    tabla.id = tableId;
    const thead = tabla.createTHead();
    const tbody = tabla.createTBody();
    const tfoot = tabla.createTFoot();
    resultsContainer.appendChild(tabla);
    containerGeneral.appendChild(resultsContainer);

    const headerRow = thead.insertRow();
    const encabezadosCompletosTabla = [...s1HeadersToDisplay, COLUMNAS_S2_FORMATO_1019_SALDOS[0]];

    const filasParaTabla = Object.values(agrupadoPorClave).map(item => {
        const fila = { ...item.s1Data };
        fila[COLUMNAS_S2_FORMATO_1019_SALDOS[0]] = item.s2Value || 0;
        return fila;
    }).filter(fila => fila[COLUMNAS_S2_FORMATO_1019_SALDOS[0]] !== 0);

    encabezadosCompletosTabla.forEach((textoEncabezado) => {
        const th = document.createElement('th');
        th.textContent = textoEncabezado;
        const filterSelect = document.createElement('select');
        filterSelect.className = 'column-filter-select';
        filterSelect.onchange = () => applyAllColumnFilters(tableId);
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = `-- Filtrar ${String(textoEncabezado).substring(0,10)} --`;
        filterSelect.appendChild(defaultOption);
        if (filasParaTabla.length > 0) {
            const uniqueValues = [...new Set(filasParaTabla.map(fila => String(fila[textoEncabezado] || "").trim()))].filter(val => val !== "").sort((a,b)=>String(a).localeCompare(String(b)));
            uniqueValues.forEach(valDisplay => {
                const option = document.createElement('option');
                option.value = normalizeText(valDisplay);
                option.textContent = valDisplay;
                filterSelect.appendChild(option);
            });
        }
        th.appendChild(document.createElement('br'));
        th.appendChild(filterSelect);
        headerRow.appendChild(th);
    });

    let totalVertical = 0;
    filasParaTabla.forEach(dataGrupo => {
        const tr = tbody.insertRow();
        s1HeadersToDisplay.forEach(hS1 => {
            const td = tr.insertCell();
            td.textContent = dataGrupo[hS1];
             if (hS1 === CODIGO_FORMATO_KEY) {
                td.classList.add('code-format-cell');
            }
        });
        const tdValor = tr.insertCell();
        tdValor.classList.add('numeric-cell');
        const valor = dataGrupo[COLUMNAS_S2_FORMATO_1019_SALDOS[0]] || 0;
        tdValor.innerHTML = formatNumber(valor);
        totalVertical += valor;
    });

    const footerRow = tfoot.insertRow();
    const tdFooterLabel = footerRow.insertCell();
    tdFooterLabel.colSpan = s1HeadersToDisplay.length;
    tdFooterLabel.textContent = "TOTAL";
    const tdTotalCol = footerRow.insertCell();
    tdTotalCol.classList.add('numeric-cell');
    tdTotalCol.innerHTML = formatNumber(totalVertical);
    return containerGeneral;
}

        

        function generarTablaResumenFormato1476(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix) {
            const filasConsolidadas = filasDelFormatoOriginal;
            const tableId = `summaryTable-${tableIdSuffix}`;
            const s1HeadersToDisplay = ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR;

            const containerGeneral = document.createElement('div');
            const tituloH3 = document.createElement('h3');
            tituloH3.className = 'summary-table-title';
            tituloH3.textContent = tituloTabla;
            containerGeneral.appendChild(tituloH3);

            if (filasConsolidadas.length === 0) {
                const p = document.createElement('p');
                p.textContent = `No hay datos para generar el resumen.`;
                containerGeneral.appendChild(p);
                updateTotalColumn1476(tableId, columnIndices.total);
                return containerGeneral;
            }

            const filasConParticipacionCalculada = [];
            filasConsolidadas.forEach(filaConsolidada => {
                const filaCalculada = { ...filaConsolidada };

                const valorAvaluo = parseCleanedInteger(filaCalculada["Valor del Avalúo Catastral"] || 0);
                const valorBaseImpuesto = parseCleanedInteger(filaCalculada["Valor base del impuesto predial"] || 0);
                let porcentajeParticipacionNum = 0;
                if(filaCalculada["Porcentaje de paticipación"]){
                    porcentajeParticipacionNum = parseFloat(String(filaCalculada["Porcentaje de paticipación"]).replace(',', '.'));
                    if (isNaN(porcentajeParticipacionNum)) porcentajeParticipacionNum = 0;
                }

                let totalPropietariosNum = 0;
                 if(filaCalculada["Total  propietarios"]){
                   totalPropietariosNum = parseCleanedInteger(filaCalculada["Total  propietarios"]);
                }

                const baseCalculo = Math.max(valorAvaluo, valorBaseImpuesto);
                let totalParticipacionCalculado = 0;

                if (porcentajeParticipacionNum > 0 && porcentajeParticipacionNum <= 100) {
                    totalParticipacionCalculado = baseCalculo * (porcentajeParticipacionNum / 100);
                } else if (totalPropietariosNum > 0) {
                    totalParticipacionCalculado = baseCalculo / totalPropietariosNum;
                }

                filaCalculada[COLUMNA_TOTAL_PARTICIPACION_1476] = totalParticipacionCalculado;
                filasConParticipacionCalculada.push(filaCalculada);
            });

            containerGeneral.appendChild(createTableActions(tableId));
            const resultsContainer = document.createElement('div');
            resultsContainer.className = 'results-container';
            const tabla = document.createElement('table');
            tabla.id = tableId;
            const thead = tabla.createTHead();
            const tbody = tabla.createTBody();
            const tfoot = tabla.createTFoot();
            resultsContainer.appendChild(tabla);
            containerGeneral.appendChild(resultsContainer);

            const headerRow = thead.insertRow();
            const encabezadosDeTablaParaMostrar = [...s1HeadersToDisplay, ...COLUMNAS_S2_FORMATO_1476_DISPLAY, COLUMNA_TOTAL_PARTICIPACION_1476];
            // --- BLOQUE RECALCULO TABLA ---
            const columnIndices = {
            avaluo: encabezadosDeTablaParaMostrar.indexOf("Valor del Avalúo Catastral"),
            baseImpuesto: encabezadosDeTablaParaMostrar.indexOf("Valor base del impuesto predial"),
            porcentaje: encabezadosDeTablaParaMostrar.indexOf("Porcentaje de paticipación"),
            propietarios: encabezadosDeTablaParaMostrar.indexOf("Total  propietarios"),
            total: encabezadosDeTablaParaMostrar.indexOf(COLUMNA_TOTAL_PARTICIPACION_1476)
};
// --- FIN DEL BLOQUE A AÑADIR RECALCULO TABLA ---


             const filasFiltradas = filasConParticipacionCalculada.filter(fila => {
                return COLUMNAS_S2_FORMATO_1476_DISPLAY.some(header => {
                    const value = fila[header];
                    return value !== undefined && value !== null && String(value).trim() !== '' && String(value).trim() !== '0';
                });
            });


            encabezadosDeTablaParaMostrar.forEach((textoEncabezado) => {
                const th = document.createElement('th');
                th.textContent = textoEncabezado;
                const filterSelect = document.createElement('select');
                filterSelect.className = 'column-filter-select';
                filterSelect.onchange = () => applyAllColumnFilters(tableId);
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = `-- Filtrar ${String(textoEncabezado).substring(0, 10)} --`;
                filterSelect.appendChild(defaultOption);

                if (filasFiltradas.length > 0) {
                    const uniqueValues = [...new Set(filasFiltradas.map(fila => {
                        const val = fila[textoEncabezado];
                        return (typeof val === 'number') ? formatNumber(val) : String(val || "").trim();
                    }))].filter(val => val !== "").sort((a, b) => String(a).localeCompare(String(b)));
                    uniqueValues.forEach(valDisplay => {
                        const option = document.createElement('option');
                        option.value = normalizeText(valDisplay);
                        option.textContent = valDisplay;
                        filterSelect.appendChild(option);
                    });
                }
                th.appendChild(document.createElement('br'));
                th.appendChild(filterSelect);
                headerRow.appendChild(th);
            });

            const totalesVerticales = {};
            [...COLUMNAS_S2_FORMATO_1476_DISPLAY, COLUMNA_TOTAL_PARTICIPACION_1476].forEach(h => {
                if(typeof filasFiltradas[0]?.[h] === 'number') {
                    totalesVerticales[h] = 0;
                }
            });

            filasFiltradas.forEach(dataGrupo => {
                const tr = tbody.insertRow();
                encabezadosDeTablaParaMostrar.forEach(header => {
                    const td = tr.insertCell();
                    const cellValue = dataGrupo[header];
                     if (header === CODIGO_FORMATO_KEY) {
                        td.classList.add('code-format-cell');
                    }
                     if (typeof cellValue === 'number') {
                        td.classList.add('numeric-cell');
                        td.innerHTML = formatNumber(cellValue);
                        if(totalesVerticales.hasOwnProperty(header)) {
                           totalesVerticales[header] += cellValue;
                        }
                    } else {
                        td.textContent = cellValue !== undefined ? cellValue : "";

                        td.setAttribute('contenteditable', 'true');
                        td.addEventListener('blur', () => {
                        recalculateRow1476(tr, columnIndices);
                        updateTotalColumn1476(tableId, columnIndices.total);
                        });
                        
                        td.addEventListener('keydown', (e) => {
                       if (e.key === 'Enter') {
                       e.preventDefault();
                       e.target.blur();
                    }
                });
            
                    }
                });
            });

            const footerRow = tfoot.insertRow();
            const tdFooterLabel = footerRow.insertCell();
            tdFooterLabel.colSpan = s1HeadersToDisplay.length;
            tdFooterLabel.textContent = "TOTALES";
            
            [...COLUMNAS_S2_FORMATO_1476_DISPLAY, COLUMNA_TOTAL_PARTICIPACION_1476].forEach(header => {
                 const td = footerRow.insertCell();
                 if(totalesVerticales.hasOwnProperty(header)) {
                    td.classList.add('numeric-cell');
                    td.innerHTML = formatNumber(totalesVerticales[header]);
                 }
            });

            return containerGeneral;
        }

// --- INICIO DE LAS NUEVAS FUNCIONES PARA EL FORMATO 1476 ---

/**
 * Recalcula el valor de la columna 'Total Participación' para una fila específica.
 * @param {HTMLTableRowElement} rowElement - El elemento <tr> de la fila que se está editando.
 * @param {object} columnIndices - Un objeto con los índices de las columnas necesarias.
 */
function recalculateRow1476(rowElement, columnIndices) {
    if (!rowElement || !columnIndices) return;

    // Obtener los valores de la fila
    const valorAvaluo = parseCleanedInteger(rowElement.cells[columnIndices.avaluo].textContent);
    const valorBaseImpuesto = parseCleanedInteger(rowElement.cells[columnIndices.baseImpuesto].textContent);
    const porcentajeStr = rowElement.cells[columnIndices.porcentaje].textContent.replace(',', '.');
    const porcentajeNum = parseFloat(porcentajeStr);
    const totalPropietariosNum = parseCleanedInteger(rowElement.cells[columnIndices.propietarios].textContent);

    const baseCalculo = Math.max(valorAvaluo, valorBaseImpuesto);
    let totalParticipacionCalculado = 0;

    // Aplicar la misma lógica de cálculo original
    if (!isNaN(porcentajeNum) && porcentajeNum > 0 && porcentajeNum <= 100) {
        totalParticipacionCalculado = baseCalculo * (porcentajeNum / 100);
    } else if (totalPropietariosNum > 0) {
        totalParticipacionCalculado = baseCalculo / totalPropietariosNum;
    }

    // Actualizar la celda de 'Total Participación' en la fila
    const totalCell = rowElement.cells[columnIndices.total];
    if (totalCell) {
        totalCell.innerHTML = formatNumber(totalParticipacionCalculado);
    }
}

/**
 * Actualiza la suma total de la columna 'Total Participación' y refresca el resumen general.
 * @param {string} tableId - El ID de la tabla 1476.
 * @param {number} totalColumnIndex - El índice de la columna 'Total Participación'.
 */
function updateTotalColumn1476(tableId, totalColumnIndex) {
    const table = document.getElementById(tableId);
    if (!table || totalColumnIndex === -1) return;

    const tbody = table.querySelector('tbody');
    const tfoot = table.querySelector('tfoot');
    if (!tbody || !tfoot) return;

    // La variable se declara aquí, al inicio de la función.
    let granTotal = 0; 

    for (const row of tbody.rows) {
        const cell = row.cells[totalColumnIndex];
        if (cell) {
            granTotal += parseCleanedInteger(cell.textContent);
        }
    }

    const footerCell = tfoot.rows[0].cells[tfoot.rows[0].cells.length - 1];
    if (footerCell) {
        footerCell.innerHTML = formatNumber(granTotal);
    }

    // Esta llamada actualiza la tabla de resumen general.
    populateResumenGeneralTab();
}

// --- FIN DE LAS NUEVAS FUNCIONES ---


       function generarTablaResumenFormato1003(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix) {
            const filasConsolidadas = filasDelFormatoOriginal;
            const tableId = `summaryTable-${tableIdSuffix}`;
            const s1HeadersToDisplay = ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR;
            const s2HeadersToSum = COLUMNAS_S2_FORMATO_1003.filter(h => encabezadosS2ActivosFormato.includes(h));

            const containerGeneral = document.createElement('div');
            const tituloH3 = document.createElement('h3');
            tituloH3.className = 'summary-table-title';
            tituloH3.textContent = tituloTabla;
            containerGeneral.appendChild(tituloH3);

            if (filasConsolidadas.length === 0 || s2HeadersToSum.length === 0) {
                const p = document.createElement('p');
                p.textContent = `No hay datos aplicables para la tabla ${tituloTabla}.`;
                containerGeneral.appendChild(p);
                return containerGeneral;
            }

            const agrupadoPorClave = filasConsolidadas.reduce((acc, fila) => {
                const claveAgrupacion = s1HeadersToDisplay.map(key => fila[key] || "N/A").join('|');
                if (!acc[claveAgrupacion]) {
                    acc[claveAgrupacion] = { s1Data: {}, s2Values: {} };
                    s1HeadersToDisplay.forEach(key => {
                        acc[claveAgrupacion].s1Data[key] = fila[key] || "N/A";
                    });
                }
                s2HeadersToSum.forEach(hS2Conceptual => {
                     if (!acc[claveAgrupacion].s2Values[hS2Conceptual]) {
                        acc[claveAgrupacion].s2Values[hS2Conceptual] = 0;
                    }
                    acc[claveAgrupacion].s2Values[hS2Conceptual] += parseCleanedInteger(fila[hS2Conceptual]);
                });
                return acc;
            }, {});

            containerGeneral.appendChild(createTableActions(tableId));
            const resultsContainer = document.createElement('div');
            resultsContainer.className = 'results-container';
            const tabla = document.createElement('table');
            tabla.id = tableId;
            const thead = tabla.createTHead();
            const tbody = tabla.createTBody();
            const tfoot = tabla.createTFoot();
            resultsContainer.appendChild(tabla);
            containerGeneral.appendChild(resultsContainer);

            const headerRow = thead.insertRow();
            const encabezadosCompletosTabla = [...s1HeadersToDisplay, ...s2HeadersToSum, "Total"];

            const filasParaDropdowns = Object.values(agrupadoPorClave).map(item => {
                const fila = { ...item.s1Data };
                s2HeadersToSum.forEach(hS2 => fila[hS2] = item.s2Values[hS2] || 0);
                fila["Total"] = s2HeadersToSum.reduce((sum, hS2) => sum + (fila[hS2] || 0), 0);
                return fila;
            }).filter(fila => s2HeadersToSum.some(hS2 => fila[hS2] !== 0));


            encabezadosCompletosTabla.forEach((textoEncabezado) => {
                const th = document.createElement('th');
                th.textContent = textoEncabezado;
                const filterSelect = document.createElement('select');
                filterSelect.className = 'column-filter-select';
                filterSelect.onchange = () => applyAllColumnFilters(tableId);
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = `-- Filtrar ${String(textoEncabezado).substring(0,10)} --`;
                filterSelect.appendChild(defaultOption);
                if (filasParaDropdowns.length > 0) {
                    const uniqueValues = [...new Set(filasParaDropdowns.map(fila => {
                        const val = fila[textoEncabezado];
                        return (typeof val === 'number') ? formatNumber(val) : String(val || "").trim();
                    }))].filter(val => val !== "").sort((a,b) => String(a).localeCompare(String(b)));
                    uniqueValues.forEach(valDisplay => {
                        const option = document.createElement('option');
                        option.value = normalizeText(valDisplay);
                        option.textContent = valDisplay;
                        filterSelect.appendChild(option);
                    });
                }
                th.appendChild(document.createElement('br'));
                th.appendChild(filterSelect);
                headerRow.appendChild(th);
            });

            const totalesVerticales = {};
            s2HeadersToSum.forEach(h => totalesVerticales[h] = 0);
            let granTotalHorizontal = 0;

            filasParaDropdowns.forEach(dataGrupo => {
                const tr = tbody.insertRow();
                s1HeadersToDisplay.forEach(hS1 => {
                    const td = tr.insertCell();
                    td.textContent = dataGrupo[hS1];
                     if (hS1 === CODIGO_FORMATO_KEY) {
                        td.classList.add('code-format-cell');
                    }
                });
                s2HeadersToSum.forEach(hS2 => {
                    const td = tr.insertCell();
                    td.classList.add('numeric-cell');
                    const valor = dataGrupo[hS2] || 0;
                    td.innerHTML = formatNumber(valor);
                    totalesVerticales[hS2] += valor;
                });
                const tdTotalHorizontal = tr.insertCell();
                tdTotalHorizontal.classList.add('numeric-cell');
                const totalFila = dataGrupo["Total"] || 0;
                tdTotalHorizontal.innerHTML = formatNumber(totalFila);
                granTotalHorizontal += totalFila;
            });

            const footerRowTotal = tfoot.insertRow();
            const tdFooterLabel = footerRowTotal.insertCell();
            tdFooterLabel.colSpan = s1HeadersToDisplay.length;
            tdFooterLabel.textContent = "TOTALES";
            s2HeadersToSum.forEach(hS2 => {
                const td = footerRowTotal.insertCell();
                td.classList.add('numeric-cell');
                td.innerHTML = formatNumber(totalesVerticales[hS2] || 0);
            });
            const tdGranTotal = footerRowTotal.insertCell();
            tdGranTotal.classList.add('numeric-cell');
            tdGranTotal.innerHTML = formatNumber(granTotalHorizontal);
            return containerGeneral;
        }

        function generarTablaResumenFormato1005(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix) {
            const filasConsolidadas = filasDelFormatoOriginal;
            const tableId = `summaryTable-${tableIdSuffix}`;
            const s1HeadersToDisplay = ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR;
            const s2HeadersToSum = COLUMNAS_S2_FORMATO_1005.filter(h => encabezadosS2ActivosFormato.includes(h));

            const containerGeneral = document.createElement('div');
            const tituloH3 = document.createElement('h3');
            tituloH3.className = 'summary-table-title';
            tituloH3.textContent = tituloTabla;
            containerGeneral.appendChild(tituloH3);

            if (filasConsolidadas.length === 0 || s2HeadersToSum.length === 0) {
                const p = document.createElement('p');
                p.textContent = `No hay datos aplicables para la tabla ${tituloTabla}.`;
                containerGeneral.appendChild(p);
                return { element: containerGeneral, total: 0 };
            }

            const agrupadoPorClave = filasConsolidadas.reduce((acc, fila) => {
                const claveAgrupacion = s1HeadersToDisplay.map(key => fila[key] || "N/A").join('|');
                if (!acc[claveAgrupacion]) {
                    acc[claveAgrupacion] = { s1Data: {}, s2Values: {} };
                    s1HeadersToDisplay.forEach(key => {
                        acc[claveAgrupacion].s1Data[key] = fila[key] || "N/A";
                    });
                }
                s2HeadersToSum.forEach(hS2Conceptual => {
                     if (!acc[claveAgrupacion].s2Values[hS2Conceptual]) {
                        acc[claveAgrupacion].s2Values[hS2Conceptual] = 0;
                    }
                    acc[claveAgrupacion].s2Values[hS2Conceptual] += parseCleanedInteger(fila[hS2Conceptual]);
                });
                return acc;
            }, {});

            containerGeneral.appendChild(createTableActions(tableId));
            const resultsContainer = document.createElement('div');
            resultsContainer.className = 'results-container';
            const tabla = document.createElement('table');
            tabla.id = tableId;
            const thead = tabla.createTHead();
            const tbody = tabla.createTBody();
            const tfoot = tabla.createTFoot();
            resultsContainer.appendChild(tabla);
            containerGeneral.appendChild(resultsContainer);

            const headerRow = thead.insertRow();
            const encabezadosCompletosTabla = [...s1HeadersToDisplay, ...s2HeadersToSum, "Total"];

            const filasParaDropdowns = Object.values(agrupadoPorClave).map(item => {
                const fila = { ...item.s1Data };
                s2HeadersToSum.forEach(hS2 => fila[hS2] = item.s2Values[hS2] || 0);
                fila["Total"] = s2HeadersToSum.reduce((sum, hS2) => sum + (fila[hS2] || 0), 0);
                return fila;
            }).filter(fila => s2HeadersToSum.some(hS2 => fila[hS2] !== 0));


            encabezadosCompletosTabla.forEach((textoEncabezado) => {
                const th = document.createElement('th');
                th.textContent = textoEncabezado;
                const filterSelect = document.createElement('select');
                filterSelect.className = 'column-filter-select';
                filterSelect.onchange = () => applyAllColumnFilters(tableId);
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = `-- Filtrar ${String(textoEncabezado).substring(0,10)} --`;
                filterSelect.appendChild(defaultOption);
                if (filasParaDropdowns.length > 0) {
                    const uniqueValues = [...new Set(filasParaDropdowns.map(fila => {
                        const val = fila[textoEncabezado];
                        return (typeof val === 'number') ? formatNumber(val) : String(val || "").trim();
                    }))].filter(val => val !== "").sort((a,b) => String(a).localeCompare(String(b)));
                    uniqueValues.forEach(valDisplay => {
                        const option = document.createElement('option');
                        option.value = normalizeText(valDisplay);
                        option.textContent = valDisplay;
                        filterSelect.appendChild(option);
                    });
                }
                th.appendChild(document.createElement('br'));
                th.appendChild(filterSelect);
                headerRow.appendChild(th);
            });

            const totalesVerticales = {};
            s2HeadersToSum.forEach(h => totalesVerticales[h] = 0);
            let granTotalHorizontal = 0;

            filasParaDropdowns.forEach(dataGrupo => {
                const tr = tbody.insertRow();
                s1HeadersToDisplay.forEach(hS1 => {
                    const td = tr.insertCell();
                    td.textContent = dataGrupo[hS1];
                     if (hS1 === CODIGO_FORMATO_KEY) {
                        td.classList.add('code-format-cell');
                    }
                });
                s2HeadersToSum.forEach(hS2 => {
                    const td = tr.insertCell();
                    td.classList.add('numeric-cell');
                    const valor = dataGrupo[hS2] || 0;
                    td.innerHTML = formatNumber(valor);
                    totalesVerticales[hS2] += valor;
                });
                const tdTotalHorizontal = tr.insertCell();
                tdTotalHorizontal.classList.add('numeric-cell');
                const totalFila = dataGrupo["Total"] || 0;
                tdTotalHorizontal.innerHTML = formatNumber(totalFila);
                granTotalHorizontal += totalFila;
            });

            const footerRowTotal = tfoot.insertRow();
            const tdFooterLabel = footerRowTotal.insertCell();
            tdFooterLabel.colSpan = s1HeadersToDisplay.length;
            tdFooterLabel.textContent = "TOTALES";
            s2HeadersToSum.forEach(hS2 => {
                const td = footerRowTotal.insertCell();
                td.classList.add('numeric-cell');
                td.innerHTML = formatNumber(totalesVerticales[hS2] || 0);
            });
            const tdGranTotal = footerRowTotal.insertCell();
            tdGranTotal.classList.add('numeric-cell');
            tdGranTotal.innerHTML = formatNumber(granTotalHorizontal);
            return { element: containerGeneral, total: granTotalHorizontal };
        }


        function generarTablaResumenFormato1481(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix) {
            const filasConsolidadas = filasDelFormatoOriginal;
            const tableId = `summaryTable-${tableIdSuffix}`;
            const s1HeadersToDisplay = ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR;
            const s2HeadersToSum = COLUMNAS_S2_FORMATO_1481.filter(h => encabezadosS2ActivosFormato.includes(h));


            const filasPrincipalesOVacias = filasConsolidadas;

            const containerGeneral = document.createElement('div');
            const tituloH3 = document.createElement('h3');
            tituloH3.className = 'summary-table-title';
            tituloH3.textContent = tituloTabla; // "ICA"
            containerGeneral.appendChild(tituloH3);

            if (filasPrincipalesOVacias.length === 0 || s2HeadersToSum.length === 0) {
                const p = document.createElement('p');
                p.textContent = `No hay datos aplicables para la tabla ${tituloTabla}.`;
                containerGeneral.appendChild(p);
                return containerGeneral;
            }

            const agrupadoPorClave = filasPrincipalesOVacias.reduce((acc, fila) => {
                const claveAgrupacion = s1HeadersToDisplay.map(key => fila[key] || "N/A").join('|');
                if (!acc[claveAgrupacion]) {
                    acc[claveAgrupacion] = { s1Data: {}, s2Values: {} };
                    s1HeadersToDisplay.forEach(key => {
                        acc[claveAgrupacion].s1Data[key] = fila[key] || "N/A";
                    });
                }
                s2HeadersToSum.forEach(hS2Conceptual => {
                     if (!acc[claveAgrupacion].s2Values[hS2Conceptual]) {
                        acc[claveAgrupacion].s2Values[hS2Conceptual] = 0;
                    }
                    acc[claveAgrupacion].s2Values[hS2Conceptual] += parseCleanedInteger(fila[hS2Conceptual]);
                });
                return acc;
            }, {});

            containerGeneral.appendChild(createTableActions(tableId));
            const resultsContainer = document.createElement('div');
            resultsContainer.className = 'results-container';
            const tabla = document.createElement('table');
            tabla.id = tableId;
            const thead = tabla.createTHead();
            const tbody = tabla.createTBody();
            const tfoot = tabla.createTFoot();
            resultsContainer.appendChild(tabla);
            containerGeneral.appendChild(resultsContainer);

            const headerRow = thead.insertRow();
            const encabezadosCompletosTabla = [...s1HeadersToDisplay, ...s2HeadersToSum];

            const filasParaDropdowns = Object.values(agrupadoPorClave).map(item => {
                const fila = { ...item.s1Data };
                s2HeadersToSum.forEach(hS2 => fila[hS2] = item.s2Values[hS2] || 0);
                return fila;
            }).filter(fila => s2HeadersToSum.some(hS2 => fila[hS2] !== 0));


            encabezadosCompletosTabla.forEach((textoEncabezado) => {
                const th = document.createElement('th');
                th.textContent = textoEncabezado;
                const filterSelect = document.createElement('select');
                filterSelect.className = 'column-filter-select';
                filterSelect.onchange = () => applyAllColumnFilters(tableId);
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = `-- Filtrar ${String(textoEncabezado).substring(0,10)} --`;
                filterSelect.appendChild(defaultOption);
                if (filasParaDropdowns.length > 0) {
                    const uniqueValues = [...new Set(filasParaDropdowns.map(fila => {
                        const val = fila[textoEncabezado];
                        return (typeof val === 'number') ? formatNumber(val) : String(val || "").trim();
                    }))].filter(val => val !== "").sort((a,b) => String(a).localeCompare(String(b)));
                    uniqueValues.forEach(valDisplay => {
                        const option = document.createElement('option');
                        option.value = normalizeText(valDisplay);
                        option.textContent = valDisplay;
                        filterSelect.appendChild(option);
                    });
                }
                th.appendChild(document.createElement('br'));
                th.appendChild(filterSelect);
                headerRow.appendChild(th);
            });

            const totalesVerticales = {};
            s2HeadersToSum.forEach(h => totalesVerticales[h] = 0);

            filasParaDropdowns.forEach(dataGrupo => {
                const tr = tbody.insertRow();
                s1HeadersToDisplay.forEach(hS1 => {
                    const td = tr.insertCell();
                    td.textContent = dataGrupo[hS1];
                     if (hS1 === CODIGO_FORMATO_KEY) {
                        td.classList.add('code-format-cell');
                    }
                });
                s2HeadersToSum.forEach(hS2 => {
                    const td = tr.insertCell();
                    td.classList.add('numeric-cell');
                    const valor = dataGrupo[hS2] || 0;
                    td.innerHTML = formatNumber(valor);
                    totalesVerticales[hS2] += valor;
                });
            });

            const footerRowTotal = tfoot.insertRow();
            const tdFooterLabel = footerRowTotal.insertCell();
            tdFooterLabel.colSpan = s1HeadersToDisplay.length;
            tdFooterLabel.textContent = "TOTALES";
            s2HeadersToSum.forEach(hS2 => {
                const td = footerRowTotal.insertCell();
                td.classList.add('numeric-cell');
                td.innerHTML = formatNumber(totalesVerticales[hS2] || 0);
            });
            return containerGeneral;
        }

        
function generarTablaResumenFormato1480(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix) {
    const tableId = `summaryTable-${tableIdSuffix}`;
    const s1HeadersToDisplay = ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR;

    const containerGeneral = document.createElement('div');
    const tituloH3 = document.createElement('h3');
    tituloH3.className = 'summary-table-title';
    tituloH3.textContent = tituloTabla;
    containerGeneral.appendChild(tituloH3);

    if (filasDelFormatoOriginal.length === 0) {
        const p = document.createElement('p');
        p.textContent = `No hay datos para generar el resumen.`;
        containerGeneral.appendChild(p);
        return containerGeneral;
    }

    const filasConPropiedadCalculada = [];
    filasDelFormatoOriginal.forEach(filaOriginal => {
        const filaCalculada = { ...filaOriginal };
        const valorAvaluo = parseCleanedInteger(filaOriginal["Valor avalúo vehículo"] || 0);
        let porcentajeParticipacionNum = 0;
        const porcentajeStr = String(filaOriginal["Porcentaje de participación"] || "");
        if(porcentajeStr && porcentajeStr.trim() !== ""){
            porcentajeParticipacionNum = parseFloat(porcentajeStr.replace(',', '.'));
            if (isNaN(porcentajeParticipacionNum)) porcentajeParticipacionNum = 0;
        }
        let totalPropietariosNum = 0;
        const totalPropStr = String(filaOriginal["Total propietarios"] || "");
        if(totalPropStr && totalPropStr.trim() !== ""){
           totalPropietariosNum = parseCleanedInteger(totalPropStr);
        }
        let totalPropiedadCalculado = 0;
        if (porcentajeParticipacionNum > 0 && porcentajeParticipacionNum <= 100) {
            totalPropiedadCalculado = valorAvaluo * (porcentajeParticipacionNum / 100);
        } else if (totalPropietariosNum > 0) {
            totalPropiedadCalculado = valorAvaluo / totalPropietariosNum;
        } else {
            totalPropiedadCalculado = valorAvaluo;
        }
        filaCalculada[COLUMNA_TOTAL_PROPIEDAD_1480] = totalPropiedadCalculado;
        filasConPropiedadCalculada.push(filaCalculada);
    });

    containerGeneral.appendChild(createTableActions(tableId));
    const resultsContainer = document.createElement('div');
    resultsContainer.className = 'results-container';
    const tabla = document.createElement('table');
    tabla.id = tableId;
    const thead = tabla.createTHead();
    const tbody = tabla.createTBody();
    const tfoot = tabla.createTFoot();
    resultsContainer.appendChild(tabla);
    containerGeneral.appendChild(resultsContainer);

    const headerRow = thead.insertRow();
    const encabezadosDeTablaParaMostrar = [...s1HeadersToDisplay, ...COLUMNAS_S2_FORMATO_1480_DISPLAY, COLUMNA_TOTAL_PROPIEDAD_1480];

     const filasFiltradas = filasConPropiedadCalculada.filter(fila => {
        return COLUMNAS_S2_FORMATO_1480_DISPLAY.some(header => {
            const value = fila[header];
            return value !== undefined && value !== null && String(value).trim() !== '' && String(value).trim() !== '0';
        });
    });

    encabezadosDeTablaParaMostrar.forEach((textoEncabezado) => {
        const th = document.createElement('th');
        th.textContent = textoEncabezado;
        const filterSelect = document.createElement('select');
        filterSelect.className = 'column-filter-select';
        filterSelect.onchange = () => applyAllColumnFilters(tableId);
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = `-- Filtrar ${String(textoEncabezado).substring(0, 10)} --`;
        filterSelect.appendChild(defaultOption);
        if (filasFiltradas.length > 0) {
            const uniqueValues = [...new Set(filasFiltradas.map(fila => {
                const val = fila[textoEncabezado];
                return (typeof val === 'number') ? formatNumber(val) : String(val || "").trim();
            }))].filter(val => val !== "").sort((a, b) => String(a).localeCompare(String(b)));
            uniqueValues.forEach(valDisplay => {
                const option = document.createElement('option');
                option.value = normalizeText(valDisplay);
                option.textContent = valDisplay;
                filterSelect.appendChild(option);
            });
        }
        th.appendChild(document.createElement('br'));
        th.appendChild(filterSelect);
        headerRow.appendChild(th);
    });

    const numericHeaders = ["Valor avalúo vehículo", COLUMNA_TOTAL_PROPIEDAD_1480];

    filasFiltradas.forEach(dataGrupo => {
        const tr = tbody.insertRow();
        encabezadosDeTablaParaMostrar.forEach(header => {
            const td = tr.insertCell();
            const cellValue = dataGrupo[header];
            if (header === CODIGO_FORMATO_KEY) {
                td.classList.add('code-format-cell');
            }

            if (numericHeaders.includes(header)) {
                td.classList.add('numeric-cell');
                td.innerHTML = formatNumber(cellValue || 0);
            } else {
                td.textContent = cellValue !== undefined ? cellValue : "";
            }
        });
    });

    // --- INICIO DE LA CORRECCIÓN ---
    // Se estandariza la creación del pie de página para que coincida con otras tablas.
    const footerRow = tfoot.insertRow();
    const tdFooterLabel = footerRow.insertCell();
    tdFooterLabel.textContent = "TOTALES";

    // Se calcula el colspan para todas las columnas que no son numéricas
    let colspan = 0;
    for (const header of encabezadosDeTablaParaMostrar) {
        if (numericHeaders.includes(header)) {
            // Se detiene el conteo al encontrar la primera columna numérica
            break;
        }
        colspan++;
    }
    tdFooterLabel.colSpan = colspan;

    // Se añaden las celdas restantes, que corresponden a las columnas numéricas
    for (let i = colspan; i < encabezadosDeTablaParaMostrar.length; i++) {
        const header = encabezadosDeTablaParaMostrar[i];
        const td = footerRow.insertCell();
        if (numericHeaders.includes(header)) {
            td.classList.add('numeric-cell');
        }
        td.innerHTML = formatNumber(0);
    }

    // Se conecta la tabla al sistema de actualización de totales.
     updateTableTotals(tableId);
    // --- FIN DE LA CORRECCIÓN ---

    return containerGeneral;
}

function generarTablaResumenPatrimonio1020(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix) {
    const tableId = `summaryTable-${tableIdSuffix}`;
    const s1HeadersToDisplay = ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR;

    const containerGeneral = document.createElement('div');
    const tituloH3 = document.createElement('h3');
    tituloH3.className = 'summary-table-title';
    tituloH3.textContent = tituloTabla;
    containerGeneral.appendChild(tituloH3);

    if (filasDelFormatoOriginal.length === 0) {
        const p = document.createElement('p');
        p.textContent = `No hay datos para generar la tabla de ${tituloTabla}.`;
        containerGeneral.appendChild(p);
        return containerGeneral;
    }

    // Lógica para agrupar por concepto y encontrar el saldo del último periodo
    const agrupadoPorClave = filasDelFormatoOriginal.reduce((acc, fila) => {
        const claveAgrupacion = fila[CODIGO_CONCEPTO_KEY] || "N/A_Concepto";

        const periodoActual = parseInt(String(fila[PERIODO_KEY]).trim(), 10) || 0;
        const saldoActual = parseCleanedInteger(fila[COLUMNAS_S2_FORMATO_1020_PATRIMONIO[0]]);

        if (!acc[claveAgrupacion] || periodoActual > acc[claveAgrupacion].latestPeriod) {
            acc[claveAgrupacion] = {
                s1Data: {},
                s2Value: saldoActual,
                latestPeriod: periodoActual
            };
            s1HeadersToDisplay.forEach(key => {
                acc[claveAgrupacion].s1Data[key] = fila[key] || "N/A";
            });
            acc[claveAgrupacion].s1Data[PERIODO_KEY] = fila[PERIODO_KEY];
        }
        return acc;
    }, {});

    containerGeneral.appendChild(createTableActions(tableId));
    const resultsContainer = document.createElement('div');
    resultsContainer.className = 'results-container';
    const tabla = document.createElement('table');
    tabla.id = tableId;
    const thead = tabla.createTHead();
    const tbody = tabla.createTBody();
    const tfoot = tabla.createTFoot();
    resultsContainer.appendChild(tabla);
    containerGeneral.appendChild(resultsContainer);

    const headerRow = thead.insertRow();
    const encabezadosCompletosTabla = [...s1HeadersToDisplay, COLUMNAS_S2_FORMATO_1020_PATRIMONIO[0]];

    const filasParaTabla = Object.values(agrupadoPorClave).map(item => {
        const fila = { ...item.s1Data };
        fila[COLUMNAS_S2_FORMATO_1020_PATRIMONIO[0]] = item.s2Value || 0;
        return fila;
    }).filter(fila => fila[COLUMNAS_S2_FORMATO_1020_PATRIMONIO[0]] !== 0);

    encabezadosCompletosTabla.forEach((textoEncabezado) => {
        const th = document.createElement('th');
        th.textContent = textoEncabezado;
        const filterSelect = document.createElement('select');
        filterSelect.className = 'column-filter-select';
        filterSelect.onchange = () => applyAllColumnFilters(tableId);
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = `-- Filtrar ${String(textoEncabezado).substring(0,10)} --`;
        filterSelect.appendChild(defaultOption);
        if (filasParaTabla.length > 0) {
            const uniqueValues = [...new Set(filasParaTabla.map(fila => String(fila[textoEncabezado] || "").trim()))].filter(val => val !== "").sort((a,b)=>String(a).localeCompare(String(b)));
            uniqueValues.forEach(valDisplay => {
                const option = document.createElement('option');
                option.value = normalizeText(valDisplay);
                option.textContent = valDisplay;
                filterSelect.appendChild(option);
            });
        }
        th.appendChild(document.createElement('br'));
        th.appendChild(filterSelect);
        headerRow.appendChild(th);
    });

    let totalVertical = 0;
    filasParaTabla.forEach(dataGrupo => {
        const tr = tbody.insertRow();
        s1HeadersToDisplay.forEach(hS1 => {
            const td = tr.insertCell();
            td.textContent = dataGrupo[hS1];
             if (hS1 === CODIGO_FORMATO_KEY) {
                td.classList.add('code-format-cell');
            }
        });
        const tdValor = tr.insertCell();
        tdValor.classList.add('numeric-cell');
        const valor = dataGrupo[COLUMNAS_S2_FORMATO_1020_PATRIMONIO[0]] || 0;
        tdValor.innerHTML = formatNumber(valor);
        totalVertical += valor;
    });

    const footerRow = tfoot.insertRow();
    const tdFooterLabel = footerRow.insertCell();
    tdFooterLabel.colSpan = s1HeadersToDisplay.length;
    tdFooterLabel.textContent = "TOTAL";
    const tdTotalCol = footerRow.insertCell();
    tdTotalCol.classList.add('numeric-cell');
    tdTotalCol.innerHTML = formatNumber(totalVertical);
    return containerGeneral;
}





        function generarTablaResumen1021_Patrimonio(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix) {
            const result = generarTablaResumenGeneral(
                filasDelFormatoOriginal,
                encabezadosS2ActivosFormato,
                tituloTabla,
                tableIdSuffix,
                ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR,
                COLUMNAS_S2_FORMATO_1021_PATRIMONIO,
                false
            );
            return result.element;
        }

        function generarTablaResumen1021_Movimientos(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix) {
            const result = generarTablaResumenGeneral(
                filasDelFormatoOriginal,
                encabezadosS2ActivosFormato,
                tituloTabla,
                tableIdSuffix,
                ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR,
                COLUMNAS_S2_FORMATO_1021_MOVIMIENTOS,
                false
            );
            return result.element;
        }

        function generarTablaResumen1021_Ingresos(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix) {
             const result = generarTablaResumenGeneral(
                filasDelFormatoOriginal,
                encabezadosS2ActivosFormato,
                tituloTabla,
                tableIdSuffix,
                ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR,
                COLUMNAS_S2_FORMATO_1021_INGRESOS,
                false
            );
             return result.element;
        }

        function generarTablaResumen2276(filasDelFormatoOriginal, encabezadosS2ActivosFormato, tituloTabla, tableIdSuffix, s2Headers) {
            const tableId = `summaryTable-${tableIdSuffix}`;
            const s1HeadersToDisplay = ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR;
            const columnasS2Finales = s2Headers.filter(h_predefinida => 
                encabezadosS2ActivosFormato.some(h_activo => normalizeText(h_activo) === normalizeText(h_predefinida))
            );

            const containerGeneral = document.createElement('div');
            const tituloH3 = document.createElement('h3');
            tituloH3.className = 'summary-table-title';
            tituloH3.textContent = tituloTabla;
            containerGeneral.appendChild(tituloH3);

            if (filasDelFormatoOriginal.length === 0 || columnasS2Finales.length === 0) {
                const p = document.createElement('p');
                p.textContent = `No hay datos aplicables para el resumen de ${tituloTabla}.`;
                containerGeneral.appendChild(p);
                return containerGeneral;
            }

            const agrupadoPorClaveCompuesta = filasDelFormatoOriginal.reduce((acc, fila) => {
                const claveAgrupacion = s1HeadersToDisplay.map(key => fila[key] || "N/A").join('|');
                if (!acc[claveAgrupacion]) {
                    acc[claveAgrupacion] = { s1Data: {}, s2Values: {} };
                    s1HeadersToDisplay.forEach(key => acc[claveAgrupacion].s1Data[key] = fila[key] || "N/A");
                    columnasS2Finales.forEach(h => acc[claveAgrupacion].s2Values[h] = 0);
                }

                for (const h_activo in fila) {
                    if (!s1HeadersToDisplay.includes(h_activo)) {
                        const normalizedActivo = normalizeText(h_activo);
                        const h_predefinida = columnasS2Finales.find(h => normalizeText(h) === normalizedActivo);
                        if (h_predefinida) {
                            acc[claveAgrupacion].s2Values[h_predefinida] += parseCleanedInteger(fila[h_activo]);
                        }
                    }
                }
                return acc;
            }, {});

            
            containerGeneral.appendChild(createTableActions(tableId));
            const resultsContainer = document.createElement('div');
            resultsContainer.className = 'results-container';
            const tabla = document.createElement('table');
            tabla.id = tableId;
            const thead = tabla.createTHead();
            const tbody = tabla.createTBody();
            const tfoot = tabla.createTFoot();
            resultsContainer.appendChild(tabla);
            containerGeneral.appendChild(resultsContainer);
            
            const headerRow = thead.insertRow();
            const specialColumn = "Certificado - Total ingresos brutos rentas de trabajo y pensión";
            const isIngresosTable = tituloTabla === "Concepto de Ingresos";
            
            if (isIngresosTable) {
                columnasS2Finales.sort((a, b) => {
                    if (normalizeText(a) === normalizeText(specialColumn)) return -1;
                    if (normalizeText(b) === normalizeText(specialColumn)) return 1;
                    return 0;
                });
            }

            const encabezadosCompletosTablaResumen = [...s1HeadersToDisplay, ...columnasS2Finales, "Total"];

             const filasParaTabla = Object.values(agrupadoPorClaveCompuesta).map(item => {
                const fila = { ...item.s1Data };
                let totalHorizontal = 0;
                columnasS2Finales.forEach(hS2 => {
                    const valor = item.s2Values[hS2] || 0;
                    fila[hS2] = valor;
                     if (!isIngresosTable || normalizeText(hS2) !== normalizeText(specialColumn)) {
                         totalHorizontal += valor;
                    }
                });
                fila["Total"] = totalHorizontal;
                return fila;
            }).filter(fila => columnasS2Finales.some(hS2 => fila[hS2] !== 0));


            encabezadosCompletosTablaResumen.forEach((textoEncabezado) => {
                const th = document.createElement('th');
                th.textContent = textoEncabezado;
                 const filterSelect = document.createElement('select');
                filterSelect.className = 'column-filter-select';
                filterSelect.onchange = () => applyAllColumnFilters(tableId);
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = `-- Filtrar --`;
                filterSelect.appendChild(defaultOption);
                if (filasParaTabla.length > 0) {
                    const uniqueValues = [...new Set(filasParaTabla.map(f => {
                         const val = f[textoEncabezado];
                        return typeof val === 'number' ? formatNumber(val) : String(val || "").trim();
                    }))].filter(v => v).sort((a, b) => String(a).localeCompare(String(b), undefined, {numeric: true}));
                    uniqueValues.forEach(valDisplay => {
                        const option = document.createElement('option');
                        option.value = normalizeText(valDisplay);
                        option.textContent = valDisplay;
                        filterSelect.appendChild(option);
                    });
                }
                th.appendChild(document.createElement('br'));
                th.appendChild(filterSelect);
                headerRow.appendChild(th);
            });

            const totalesVerticales = {};
            columnasS2Finales.forEach(h => totalesVerticales[h] = 0);
            let granTotalHorizontal = 0;

            filasParaTabla.forEach(dataGrupo => {
                const tr = tbody.insertRow();
                s1HeadersToDisplay.forEach(hS1 => {
                    const td = tr.insertCell();
                    td.textContent = dataGrupo[hS1];
                    if (hS1 === CODIGO_FORMATO_KEY) {
                        td.classList.add('code-format-cell');
                    }
                });
                columnasS2Finales.forEach(hS2 => {
                    const td = tr.insertCell();
                    td.classList.add('numeric-cell');
                    const valor = dataGrupo[hS2] || 0;
                    td.innerHTML = formatNumber(valor);
                    totalesVerticales[hS2] += valor;
                    if (isIngresosTable && normalizeText(hS2) === normalizeText(specialColumn)) {
                         td.classList.add('special-column-bg');
                    }
                });
                const tdTotalHorizontal = tr.insertCell();
                tdTotalHorizontal.classList.add('numeric-cell');
                tdTotalHorizontal.innerHTML = formatNumber(dataGrupo["Total"]);
                granTotalHorizontal += dataGrupo["Total"];
            });

            const footerRow = tfoot.insertRow();
            const tdFooterLabel = footerRow.insertCell();
            tdFooterLabel.colSpan = s1HeadersToDisplay.length;
            tdFooterLabel.textContent = "TOTALES";
            columnasS2Finales.forEach(hS2 => {
                const td = footerRow.insertCell();
                td.classList.add('numeric-cell');
                td.innerHTML = formatNumber(totalesVerticales[hS2] || 0);
            });

            const tdGranTotal = footerRow.insertCell();
            tdGranTotal.classList.add('numeric-cell');
            tdGranTotal.innerHTML = formatNumber(granTotalHorizontal);
            
            return containerGeneral;
        }





       function crearSubPestanas(codigoFormato, nombreFormato, filasDelFormato, encabezadosS1, encabezadosS2ActivosFormato) {
    const mainContentDiv = document.createElement('div');

    const subTabHeader = document.createElement('div');
    subTabHeader.className = 'sub-tab-header';

    const subTabContentContainer = document.createElement('div');

    // Declaraciones para los botones y contenidos
    let resumenSubTabButton, resumenSubTabContentId;
    let datosSubTabButton, datosSubTabContentId;
    let firstButtonToActivate, firstContentIdToActivate;

    // --- 1. Crear la pestaña de RESUMEN primero (si aplica) ---
    if (FORMATOS_CON_RESUMEN.includes(String(codigoFormato))) {
        resumenSubTabButton = document.createElement('button');
        resumenSubTabButton.className = 'sub-tab-link';
        resumenSubTabButton.textContent = 'Resumen';
        resumenSubTabContentId = `subcontent-resumen-${codigoFormato}`;
        resumenSubTabButton.onclick = (e) => activateTab(e.currentTarget, resumenSubTabContentId);

        const resumenSubTabContent = document.createElement('div');
        resumenSubTabContent.id = resumenSubTabContentId;
        resumenSubTabContent.className = 'sub-tab-content';
        resumenSubTabContent.appendChild(crearEncabezadoCualitativoHTML());
        resumenSubTabContent.appendChild(createHomeLink());

        const filasParaResumen = explotarYConsolidarFilas(filasDelFormato);
        const encabezadosConsolidados = [...new Set(filasParaResumen.flatMap(f => Object.keys(f)))];
        const encabezadosS2Consolidados = encabezadosConsolidados.filter(h => !encabezadosS1Global.includes(h));
        const summaryContainer = document.createElement('div');
        summaryContainer.className = 'summary-tables-wrapper';

        // (Aquí va toda la lógica para generar el contenido del resumen que ya tenías)
        // ... (el gran bloque if/else if para cada codigoFormato) ...
        if (String(codigoFormato) === "1001" || String(codigoFormato) === "5247") {
            summaryContainer.appendChild(generarTablaResumen1001y5247(filasParaResumen, 'ingresos', encabezadosS2Consolidados, 'Ingresos', codigoFormato).element);
            summaryContainer.appendChild(generarTablaResumen1001y5247(filasParaResumen, 'retencionFuente', encabezadosS2Consolidados, 'Retención en la Fuente', codigoFormato).element);
            summaryContainer.appendChild(generarTablaResumen1001y5247(filasParaResumen, 'reteIVA', encabezadosS2Consolidados, 'ReteIVA', codigoFormato).element);
        } else if (String(codigoFormato) === "1003") {
            summaryContainer.appendChild(generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, `Bases Retenciones Practicadas`, `${codigoFormato}-Bases-Retenciones-Practicadas`, ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_1003_BASES, true).element);
            summaryContainer.appendChild(generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, `Retenciones Practicadas`, `${codigoFormato}-Retenciones-Practicadas`, ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_1003, true).element);
        } else if (String(codigoFormato) === "1005") {
            let totalIvaDescontable = 0;
            let totalImpuestoConsumo = 0;

            const res1005 = generarTablaSubResumen("IVA Descontable", filasParaResumen, COLUMNAS_S2_FORMATO_1005, "1005-IVA-Descontable" );
            summaryContainer.appendChild(res1005.element);
            totalIvaDescontable += res1005.total;

            const datos1001 = formatosProcesadosGlobal['1001'] ? explotarYConsolidarFilas(formatosProcesadosGlobal['1001']) : [];
            const res1001 = generarTablaSubResumen("IVA Descontable (F1001)", datos1001, COLUMNAS_IVA_DESCONTABLE_1001, "1005-IVA-Descontable-(F1001)" );
            summaryContainer.appendChild(res1001.element);
            totalIvaDescontable += res1001.total;
            
            const datos1024_iva = formatosProcesadosGlobal['1024'] ? explotarYConsolidarFilas(formatosProcesadosGlobal['1024']) : [];
            const res1024_iva = generarTablaSubResumen("IVA Descontable (F1024)", datos1024_iva, COLUMNAS_IVA_DESCONTABLE_1024, "1005-IVA-Descontable-(F1024)" );
            summaryContainer.appendChild(res1024_iva.element);
            totalIvaDescontable += res1024_iva.total;

            const datos5249 = formatosProcesadosGlobal['5249'] ? explotarYConsolidarFilas(formatosProcesadosGlobal['5249']) : [];
            const res5249 = generarTablaSubResumen("IVA Descontable (F5249)", datos5249, COLUMNAS_S2_FORMATO_5249, "1005-IVA-Descontable-(F5249)" );
            summaryContainer.appendChild(res5249.element);
            totalIvaDescontable += res5249.total;

            const totalIvaRow = document.createElement('h3');
            totalIvaRow.className = 'summary-table-title';
            totalIvaRow.innerHTML = `Total IVA Descontable: <span style="float:right;">${formatNumber(totalIvaDescontable)}</span>`;
            summaryContainer.appendChild(totalIvaRow);


            const resIC1005 = generarTablaSubResumen("Impuesto al Consumo", filasParaResumen, COLUMNAS_IMPUESTO_CONSUMO_1005, "1005-Impuesto-al-Consumo");
            summaryContainer.appendChild(resIC1005.element);
            totalImpuestoConsumo += resIC1005.total;
            
            const datos1024_ic = formatosProcesadosGlobal['1024'] ? explotarYConsolidarFilas(formatosProcesadosGlobal['1024']) : [];
            const resIC1024 = generarTablaSubResumen("Impuesto al Consumo (F1024)", datos1024_ic, COLUMNAS_IMPUESTO_CONSUMO_1024, "1005-Impuesto-al-Consumo-(F1024)");
            summaryContainer.appendChild(resIC1024.element);
            totalImpuestoConsumo += resIC1024.total;

            const totalIcRow = document.createElement('h3');
            totalIcRow.className = 'summary-table-title';
            totalIcRow.innerHTML = `Total Impuesto al Consumo: <span style="float:right;">${formatNumber(totalImpuestoConsumo)}</span>`;
            summaryContainer.appendChild(totalIcRow);
        } else if (String(codigoFormato) === "1006") {
            let totalIvaGenerado = 0;
            const res1006 = generarTablaResumenFormato1006(filasParaResumen, encabezadosS2Consolidados, `IVA Generado`, "1006-IVA-Generado");
            summaryContainer.appendChild(res1006.element);
            totalIvaGenerado += res1006.total;
            
            const datos5250 = formatosProcesadosGlobal['5250'] ? explotarYConsolidarFilas(formatosProcesadosGlobal['5250']) : [];
            if(datos5250.length > 0){
                const res5250 = generarTablaSubResumen("IVA Generado (F5250)", datos5250, COLUMNAS_S2_FORMATO_5250, "1006-IVA-Generado-(F5250)", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, true);
                summaryContainer.appendChild(res5250.element);
                totalIvaGenerado += res5250.total;
            }

            
            const totalIvaGeneradoRow = document.createElement('h3');
            totalIvaGeneradoRow.className = 'summary-table-title';
            totalIvaGeneradoRow.innerHTML = `Total IVA Generado: <span style="float:right;">${formatNumber(totalIvaGenerado)}</span>`;
            summaryContainer.appendChild(totalIvaGeneradoRow);

            let totalImpuestoConsumo = 0;
            const resIC1006 = generarTablaSubResumen("Impuesto al Consumo", filasParaResumen, ["Impuesto al consumo"], "1006-Impuesto-al-Consumo", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR);
            summaryContainer.appendChild(resIC1006.element);
            totalImpuestoConsumo += resIC1006.total;
            
            const totalIcRow = document.createElement('h3');
            totalIcRow.className = 'summary-table-title';
            totalIcRow.innerHTML = `Total Impuesto al Consumo: <span style="float:right;">${formatNumber(totalImpuestoConsumo)}</span>`;
            summaryContainer.appendChild(totalIcRow);
        } else if (String(codigoFormato) === "1008") { 
            let totalCuentasPorPagar = 0;
            const res1008 = generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, `Cuentas por Cobrar (F1008)`, "1008-Cuentas-por-Pagar", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_1008, true);
            summaryContainer.appendChild(res1008.element);
            totalCuentasPorPagar += res1008.total;

            const datos5251 = formatosProcesadosGlobal['5251'] ? explotarYConsolidarFilas(formatosProcesadosGlobal['5251']) : [];
             if(datos5251.length > 0){
                 const res5251 = generarTablaSubResumen(
                    "Cuentas por Cobrar (F5251)",
                    datos5251,
                    COLUMNAS_S2_FORMATO_5251,
                    "1008-Cuentas-por-Pagar-(F5251)",
                    ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR,
                    true
                );
                summaryContainer.appendChild(res5251.element);
                totalCuentasPorPagar += res5251.total;
             }
            
            const totalCxPRow = document.createElement('h3');
            totalCxPRow.className = 'summary-table-title';
            totalCxPRow.innerHTML = `Total Cuentas por Pagar: <span style="float:right;">${formatNumber(totalCuentasPorPagar)}</span>`;
            summaryContainer.appendChild(totalCxPRow);

        } else if (String(codigoFormato) === "1009") { 
            let totalCuentasPorCobrar = 0;
            const res1009 = generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, `Cuentas por Pagar`, "1009-Cuentas-por-Cobrar", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_1009, true);
            summaryContainer.appendChild(res1009.element);
            totalCuentasPorCobrar += res1009.total;

            const datos5252 = formatosProcesadosGlobal['5252'] ? explotarYConsolidarFilas(formatosProcesadosGlobal['5252']) : [];
             if(datos5252.length > 0){
                 const res5252 = generarTablaSubResumen(
                    "Cuentas por Pagar (F5252)",
                    datos5252,
                    COLUMNAS_S2_FORMATO_5252,
                    "1009-Cuentas-por-Cobrar-(F5252)",
                    ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR,
                    true
                );
                summaryContainer.appendChild(res5252.element);
                totalCuentasPorCobrar += res5252.total;
             }
            
            const totalCxCRow = document.createElement('h3');
            totalCxCRow.className = 'summary-table-title';
            totalCxCRow.innerHTML = `Total Cuentas por Cobrar: <span style="float:right;">${formatNumber(totalCuentasPorCobrar)}</span>`;
            summaryContainer.appendChild(totalCxCRow);


} else if(String(codigoFormato) === "5252"){
     summaryContainer.appendChild(generarTablaResumenGeneral(
        filasParaResumen, 
        encabezadosS2Consolidados, 
        "Cuentas por Cobrar en Contratos de Colaboración Empresarial", 
        "5252-Cuentas-por-Cobrar", 
        ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, 
        COLUMNAS_S2_FORMATO_5252, 
        true
    ).element);




        } else if (String(codigoFormato) === "1010") {
            summaryContainer.appendChild(generarTablaResumenGeneral(
                filasParaResumen,
                encabezadosS2Consolidados,
                "Resumen Valor Patrimonial Socios",
                "1010-Resumen-Valor-Patrimonial-Socios",
                ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR,
                COLUMNAS_S2_FORMATO_1010,
                false 
            ).element);
        } else if (String(codigoFormato) === "1013") {
            summaryContainer.appendChild(generarTablaResumenGeneral(
                filasParaResumen,
                encabezadosS2Consolidados,
                "Resumen de Fiducias",
                "1013-Resumen-de-Fiducias",
                ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR,
                COLUMNAS_S2_FORMATO_1013,
                false 
            ).element);
        } else if (String(codigoFormato) === "1007" || String(codigoFormato) === "1014" || String(codigoFormato) === "5248") {
            summaryContainer.appendChild(generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, `Compras`, `${codigoFormato}-Compras`, ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, null).element);
        } else if (String(codigoFormato) === "1019") {
             let filasParaMovimientos1019 = [...filasParaResumen];
            
            if (formatosProcesadosGlobal['1021']) {
               const filas1021 = explotarYConsolidarFilas(formatosProcesadosGlobal['1021']);
               filasParaMovimientos1019.push(...filas1021);
            }

            summaryContainer.appendChild(generarTablaResumenMovimientos1019(filasParaMovimientos1019, encabezadosS2Consolidados, 'Movimientos', codigoFormato));

            const seccionPatrimonio = document.createElement('div');
             const tituloPat = document.createElement('h3');
            tituloPat.className = 'section-title';
            tituloPat.textContent = 'Patrimonio';
            seccionPatrimonio.appendChild(tituloPat);
            seccionPatrimonio.appendChild(generarTablaResumenSaldoCuentas1019(filasParaResumen, encabezadosS2Consolidados, 'Saldo Cuentas', codigoFormato));
            summaryContainer.appendChild(seccionPatrimonio);
       
        } else if (String(codigoFormato) === "1020") {
            let filasPatrimonio1020 = filasParaResumen;
            if (filasParaResumen.length > 0) {
                const maxPeriodo = Math.max(...filasParaResumen.map(fila => parseInt(String(fila[PERIODO_KEY]).trim(), 10) || 0));
                filasPatrimonio1020 = filasParaResumen.filter(fila => (parseInt(String(fila[PERIODO_KEY]).trim(), 10) || 0) === maxPeriodo);
            }

            summaryContainer.appendChild(generarTablaResumenGeneral(
                filasPatrimonio1020, 
                encabezadosS2Consolidados, "Patrimonio (CDT)", "1020-Patrimonio",
                ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_1020_PATRIMONIO, false
            ).element);

            summaryContainer.appendChild(generarTablaResumenGeneral(
                filasParaResumen, 
                encabezadosS2Consolidados, "Ingresos (CDT)", "1020-Ingresos",
                ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_1020_INGRESOS, false
            ).element);
        } else if (String(codigoFormato) === "1021") {
            summaryContainer.appendChild(generarTablaResumen1021_Patrimonio(filasParaResumen, encabezadosS2Consolidados, "Patrimonio", "1021-Patrimonio"));
            summaryContainer.appendChild(generarTablaResumen1021_Movimientos(filasParaResumen, encabezadosS2Consolidados, "Movimientos", "1021-Movimientos"));
            summaryContainer.appendChild(generarTablaResumen1021_Ingresos(filasParaResumen, encabezadosS2Consolidados, "Ingresos", "1021-Ingresos"));
        } else if (String(codigoFormato) === "1023") {
            summaryContainer.appendChild(generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, "Consumos con Tarjeta de Crédito", "1023-Consumos-con-Tarjeta-de-Credito", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_1023, true).element);
        } else if (String(codigoFormato) === "1024") {summaryContainer.appendChild(generarTablaSubResumen("Ingresos",filasParaResumen, COLUMNAS_INGRESOS_1024, "1024-Ingresos").element);summaryContainer.appendChild(generarTablaSubResumen("IVA Generado", filasParaResumen,
        COLUMNAS_IVA_GENERADO_1024,"1024-IVA-Generado").element);
        } else if(String(codigoFormato) === "1026"){
             summaryContainer.appendChild(generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, "Prestamos Bancarios Otorgados", "1026-Prestamos-Bancarios-Otorgados", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_1026, true).element);
        } else if(String(codigoFormato) === "1032"){
             summaryContainer.appendChild(generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, "Enajenación de Bienes y Derechos Notaria", "1032-Enajenacion-de-Bienes-y-Derechos-Notaria", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_1032, false).element);
        } else if(String(codigoFormato) === "1038"){
            summaryContainer.appendChild(generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, "Información de Constitución de Sociedades", "1038-Constitucion-Sociedades", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_1038, false).element);
        } else if(String(codigoFormato) === "1042"){
             summaryContainer.appendChild(generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, "Adquisiciones a través de Comisionistas", "1042-Adquisiciones-a-traves-de-Comisionistas", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_1042, false).element);
        } else if (String(codigoFormato) === "1476") {
             summaryContainer.appendChild(generarTablaResumenFormato1476(filasParaResumen, encabezadosS2Consolidados, "Información Catastral y de Impuesto Predial", "1476-Informacion-Catastral-y-de-Impuesto-Predial"));
        } else if (String(codigoFormato) === "1481") {
             summaryContainer.appendChild(generarTablaResumenFormato1481(filasParaResumen, encabezadosS2Consolidados, "ICA", "1481-ICA"));
        } else if (String(codigoFormato) === "1480") {
             summaryContainer.appendChild(generarTablaResumenFormato1480(filasParaResumen, encabezadosS2Consolidados, "Vehículos", "1480-Vehiculos"));
        } else if(String(codigoFormato) === "1647"){
             summaryContainer.appendChild(generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, "Ingresos Recibidos para Terceros", "1647-Ingresos-Recibidos-para-Terceros", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_1647, false).element);
        } else if(String(codigoFormato) === "2273"){
            const filasFiltradasPeriodo12 = filasParaResumen.filter(fila => String(fila[PERIODO_KEY]).trim() === '12');
            summaryContainer.appendChild(generarTablaResumenGeneral(filasFiltradasPeriodo12, encabezadosS2Consolidados, "Saldos en Depósito", "2273-Saldos-en-Deposito", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_2273_SALDOS, false).element);
            summaryContainer.appendChild(generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, "Ingresos", "2273-Ingresos", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_2273_INGRESOS, false).element);
        } else if(String(codigoFormato) === "2274"){
            summaryContainer.appendChild(generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, "Cesantías", "2274-Cesantias", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_2274, false).element);
        } else if(String(codigoFormato) === "2276"){
            summaryContainer.appendChild(generarTablaResumen2276(filasParaResumen, encabezadosS2Consolidados, "Concepto de Ingresos", "2276-ingresos", COLUMNAS_S2_FORMATO_2276_INGRESOS));
            summaryContainer.appendChild(generarTablaResumen2276(filasParaResumen, encabezadosS2Consolidados, "Concepto de los Aportes", "2276-aportes", COLUMNAS_S2_FORMATO_2276_APORTES));
            summaryContainer.appendChild(generarTablaResumen2276(filasParaResumen, encabezadosS2Consolidados, "Retención en la Fuente", "2276-retefuente", COLUMNAS_S2_FORMATO_2276_RETEFUENTE));
        } else if(String(codigoFormato) === "2277"){
            summaryContainer.appendChild(generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, "Aportes a Pensiones", "2277-Aportes-a-Pensiones", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_2277, false).element);
        } else if(String(codigoFormato) === "2575"){
             summaryContainer.appendChild(generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, "Donaciones Recibidas", "2575-Donaciones-Recibidas", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_2575, false).element);
        } else if(String(codigoFormato) === "5249"){
             summaryContainer.appendChild(generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, "IVA Descontable en Contratos de Colaboración Empresarial", "5249-IVA-Descontable", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_5249, false).element);
        } else if(String(codigoFormato) === "5250"){
             summaryContainer.appendChild(generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, "IVA Generado en Contratos de Colaboración Empresarial", "5250-IVA-Generado", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_5250, false).element);
        } else if(String(codigoFormato) === "5251"){
             summaryContainer.appendChild(generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, "Cuentas por Pagar en Contratos de Colaboración Empresarial", "5251-Cuentas-por-Pagar", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_5251, true).element);
        } else if(String(codigoFormato) === "5252"){
             summaryContainer.appendChild(generarTablaResumenGeneral(filasParaResumen, encabezadosS2Consolidados, "Cuentas por Cobrar en Contratos de Colaboración Empresarial", "5252-Cuentas-por-Cobrar", ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR, COLUMNAS_S2_FORMATO_5252, true).element);
        }
        // ... fin del gran bloque if/else ...

        if (filasDelFormato.length > 0 && summaryContainer.innerText.trim() === "") {
            const p = document.createElement('p');
            p.textContent = "Se encontraron datos para este formato, pero no hay valores aplicables para generar un resumen.";
            summaryContainer.appendChild(p);
        }
        resumenSubTabContent.appendChild(summaryContainer);

        // Añadir el botón y el contenido al DOM
        subTabHeader.appendChild(resumenSubTabButton);
        subTabContentContainer.appendChild(resumenSubTabContent);

        // Definir esta como la pestaña a activar por defecto
        firstButtonToActivate = resumenSubTabButton;
        firstContentIdToActivate = resumenSubTabContentId;
    }

    // --- 2. Crear la pestaña de DATOS (siempre se crea) ---
    datosSubTabButton = document.createElement('button');
    datosSubTabButton.className = 'sub-tab-link';
    datosSubTabButton.textContent = 'Datos';
    datosSubTabContentId = `subcontent-datos-${codigoFormato}`;
    const datosTableId = `dataTable-${codigoFormato}`;
    datosSubTabButton.onclick = (e) => activateTab(e.currentTarget, datosSubTabContentId);

    const datosSubTabContent = document.createElement('div');
    datosSubTabContent.id = datosSubTabContentId;
    datosSubTabContent.className = 'sub-tab-content';
    datosSubTabContent.appendChild(crearEncabezadoCualitativoHTML());
    datosSubTabContent.appendChild(createHomeLink());

    datosSubTabContent.appendChild(crearTablaHTML(datosTableId, filasDelFormato, encabezadosOriginalesGlobal));

    subTabHeader.appendChild(datosSubTabButton);
    subTabContentContainer.appendChild(datosSubTabContent);

    // Si 'Resumen' no se creó, 'Datos' será la pestaña por defecto
    if (!firstButtonToActivate) {
        firstButtonToActivate = datosSubTabButton;
        firstContentIdToActivate = datosSubTabContentId;
    }

    // --- 3. Ensamblaje final y activación ---
    mainContentDiv.appendChild(subTabHeader);
    mainContentDiv.appendChild(subTabContentContainer);

    setTimeout(() => {
        if (firstButtonToActivate && firstButtonToActivate.isConnected) {
            activateTab(firstButtonToActivate, firstContentIdToActivate);
        }
    }, 0);

    return mainContentDiv;
}








        function generarTablaSubResumen(titulo, filasOrigen, columnasS2, tableIdSuffix, s1HeadersToDisplay = ENCABEZADOS_S1_FILA_RESUMEN_ESTANDAR) {
            const tableId = `summaryTable-${tableIdSuffix}`;
            const containerGeneral = document.createElement('div');
            const tituloH3 = document.createElement('h3');
            tituloH3.className = 'summary-table-title';
            tituloH3.textContent = titulo;
            containerGeneral.appendChild(tituloH3);

            if (!filasOrigen || filasOrigen.length === 0) {
                 const p = document.createElement('p');
                 p.textContent = `No hay datos en el formato de origen para generar la tabla "${titulo}".`;
                 containerGeneral.appendChild(p);
                 return { element: containerGeneral, total: 0 };
            }
            
            const encabezadosActivosOrigen = [...new Set(filasOrigen.flatMap(f => Object.keys(f)))];
            
            const headerMap = {};
            const s2HeadersToSum = [];
            columnasS2.forEach(h_predefinida => {
                const h_real = encabezadosActivosOrigen.find(h_activo => normalizeText(h_activo) === normalizeText(h_predefinida));
                if (h_real) {
                    headerMap[h_predefinida] = h_real;
                    s2HeadersToSum.push(h_predefinida);
                }
            });


            if(s2HeadersToSum.length === 0) {
                const p = document.createElement('p');
                p.textContent = `No se encontraron columnas aplicables para la tabla "${titulo}".`;
                containerGeneral.appendChild(p);
                return { element: containerGeneral, total: 0 };
            }
            
            const agrupadoPorClave = filasOrigen.reduce((acc, fila) => {
                const claveAgrupacion = s1HeadersToDisplay.map(key => fila[key] || "N/A").join('|');
                if (!acc[claveAgrupacion]) {
                    acc[claveAgrupacion] = { s1Data: {}, s2Values: {} };
                    s1HeadersToDisplay.forEach(key => {
                        acc[claveAgrupacion].s1Data[key] = fila[key] || "N/A";
                    });
                }
                 s2HeadersToSum.forEach(hS2Conceptual => {
                     if(!acc[claveAgrupacion].s2Values[hS2Conceptual]){
                        acc[claveAgrupacion].s2Values[hS2Conceptual] = 0;
                     }
                      const h_real = headerMap[hS2Conceptual];
                      if (fila.hasOwnProperty(h_real)) {
                         acc[claveAgrupacion].s2Values[hS2Conceptual] += parseCleanedInteger(fila[h_real]);
                      }
                 });
                return acc;
            }, {});

            containerGeneral.appendChild(createTableActions(tableId));
            const resultsContainer = document.createElement('div');
            resultsContainer.className = 'results-container';
            const tabla = document.createElement('table');
            tabla.id = tableId;
            const thead = tabla.createTHead();
            const tbody = tabla.createTBody();
            const tfoot = tabla.createTFoot();
            resultsContainer.appendChild(tabla);
            containerGeneral.appendChild(resultsContainer);

            const headerRow = thead.insertRow();
            const encabezadosCompletosTabla = [...s1HeadersToDisplay, ...s2HeadersToSum, "Total"];

            const filasParaDropdowns = Object.values(agrupadoPorClave).map(item => {
                const fila = { ...item.s1Data };
                s2HeadersToSum.forEach(hS2 => fila[hS2] = item.s2Values[hS2] || 0);
                fila["Total"] = s2HeadersToSum.reduce((sum, hS2) => sum + (fila[hS2] || 0), 0);
                return fila;
            }).filter(fila => fila.Total !== 0);

            encabezadosCompletosTabla.forEach((textoEncabezado) => {
                const th = document.createElement('th');
                th.textContent = textoEncabezado;
                const filterSelect = document.createElement('select');
                filterSelect.className = 'column-filter-select';
                filterSelect.onchange = () => applyAllColumnFilters(tableId);
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = `-- Filtrar --`;
                filterSelect.appendChild(defaultOption);
                 if (filasParaDropdowns.length > 0) {
                    const uniqueValues = [...new Set(filasParaDropdowns.map(f => String(f[textoEncabezado] || "").trim()))].filter(v => v).sort();
                    uniqueValues.forEach(valDisplay => {
                        const option = document.createElement('option');
                        option.value = normalizeText(valDisplay);
                        option.textContent = valDisplay;
                        filterSelect.appendChild(option);
                    });
                }

                th.appendChild(document.createElement('br'));
                th.appendChild(filterSelect);
                headerRow.appendChild(th);
            });

            const totalesVerticales = {};
            s2HeadersToSum.forEach(h => totalesVerticales[h] = 0);
            let granTotalHorizontal = 0;

            filasParaDropdowns.forEach(dataGrupo => {
                const tr = tbody.insertRow();
                s1HeadersToDisplay.forEach(hS1 => {
                    const td = tr.insertCell();
                    td.textContent = dataGrupo[hS1] || '';
                    if (hS1 === CODIGO_FORMATO_KEY) {
                        td.classList.add('code-format-cell');
                    }
                });
                s2HeadersToSum.forEach(hS2 => {
                    const td = tr.insertCell();
                    td.classList.add('numeric-cell');
                    const valor = dataGrupo[hS2] || 0;
                    td.innerHTML = formatNumber(valor);
                    totalesVerticales[hS2] += valor;
                });
                const tdTotalHorizontal = tr.insertCell();
                tdTotalHorizontal.classList.add('numeric-cell');
                const totalFila = dataGrupo["Total"] || 0;
                tdTotalHorizontal.innerHTML = formatNumber(totalFila);
                granTotalHorizontal += totalFila;
            });

            const footerRowTotal = tfoot.insertRow();
            const tdFooterLabel = footerRowTotal.insertCell();
            tdFooterLabel.colSpan = s1HeadersToDisplay.length;
            tdFooterLabel.textContent = "TOTALES";
            s2HeadersToSum.forEach(hS2 => {
                const td = footerRowTotal.insertCell();
                td.classList.add('numeric-cell');
                td.innerHTML = formatNumber(totalesVerticales[hS2] || 0);
            });
            const tdGranTotal = footerRowTotal.insertCell();
            tdGranTotal.classList.add('numeric-cell');
            tdGranTotal.innerHTML = formatNumber(granTotalHorizontal);
            
            return { element: containerGeneral, total: granTotalHorizontal };
        }



     /**
 * Muestra los resultados en una estructura de pestañas.
 */
function mostrarResultadosConPestanas() {
    const tabHeader = document.getElementById('tabHeader');
    const tabContentContainer = document.getElementById('tabContentContainer');
    tabHeader.innerHTML = '';
    tabContentContainer.innerHTML = '';

    if (Object.keys(formatosProcesadosGlobal).length === 0 && datosBrutosParaExogena.length === 0) {
        updateStatus("No se generaron resultados para mostrar.");
        return;
        
    }

    // NUEVA LÓGICA: Si hay datos relevantes para el resumen del 1005,
    // se asegura de que el formato 1005 exista en la lista para que se genere la pestaña.
    if (formatosProcesadosGlobal['1001'] || formatosProcesadosGlobal['1024'] || formatosProcesadosGlobal['5249']) {
        if (!formatosProcesadosGlobal['1005']) {
            formatosProcesadosGlobal['1005'] = [];
        }
    }
    
    // Add Resumen Tab
    const resumenTabButtonId = 'btn-tab-resumen';
    const resumenTabContentId = 'content-tab-resumen';
    const resumenButton = document.createElement('button');
    resumenButton.id = resumenTabButtonId;
    resumenButton.className = 'tab-link';
    resumenButton.textContent = 'Resumen';
    resumenButton.onclick = (e) => activateTab(e.currentTarget, resumenTabContentId);
    tabHeader.appendChild(resumenButton);

    const resumenContentDiv = document.createElement('div');
    resumenContentDiv.id = resumenTabContentId;
    resumenContentDiv.className = 'tab-content';
    resumenContentDiv.appendChild(crearEncabezadoCualitativoHTML());
    resumenContentDiv.appendChild(generarContenidoResumen()); // Create empty structure
    tabContentContainer.appendChild(resumenContentDiv);


    const exogenaTabButtonId = 'btn-tab-exogena';
    const exogenaTabContentId = 'content-tab-exogena';
    const exogenaButton = document.createElement('button');
    exogenaButton.id = exogenaTabButtonId;
    exogenaButton.className = 'tab-link';
    exogenaButton.textContent = 'Exógena';
    exogenaButton.onclick = (e) => activateTab(e.currentTarget, exogenaTabContentId);
    tabHeader.appendChild(exogenaButton);

    const exogenaContentDiv = document.createElement('div');
    exogenaContentDiv.id = exogenaTabContentId;
    exogenaContentDiv.className = 'tab-content';
    exogenaContentDiv.appendChild(crearEncabezadoCualitativoHTML());
    const exogenaTitle = document.createElement('h2');
    exogenaTitle.className = 'content-title';
    exogenaTitle.textContent = 'Datos Cargados del Archivo (Exógena)';
    exogenaContentDiv.appendChild(exogenaTitle);
    exogenaContentDiv.appendChild(crearTablaHTML('exogenaTable', datosBrutosParaExogena, encabezadosOriginalesGlobal));
    tabContentContainer.appendChild(exogenaContentDiv);

    const indiceTabButtonId = 'btn-tab-indice';
    const indiceTabContentId = 'content-tab-indice';
    const indiceButton = document.createElement('button');
    indiceButton.id = indiceTabButtonId;
    indiceButton.className = 'tab-link';
    indiceButton.textContent = 'Índice';
    indiceButton.onclick = (e) => activateTab(e.currentTarget, indiceTabContentId);
    tabHeader.appendChild(indiceButton);

    const indiceContentDiv = document.createElement('div');
    indiceContentDiv.id = indiceTabContentId;
    indiceContentDiv.className = 'tab-content';
    indiceContentDiv.appendChild(crearEncabezadoCualitativoHTML());
    const indiceTitle = document.createElement('h2');
    indiceTitle.className = 'content-title';
    indiceTitle.textContent = 'Índice de Formatos Procesados';
    const indiceSubtitle = document.createElement('h4');
    indiceSubtitle.className = 'detail-subtitle';
    indiceSubtitle.textContent = 'Detalle Consulta General de lo Reportado por Terceros';
    indiceContentDiv.appendChild(indiceTitle);
    indiceContentDiv.appendChild(indiceSubtitle);
    const indiceListUl = document.createElement('ul');
    indiceListUl.id = 'indiceListaGlobal';
    indiceContentDiv.appendChild(indiceListUl);
    tabContentContainer.appendChild(indiceContentDiv);

    for (const codigoFormato in formatosProcesadosGlobal) {
        const filasParaEsteFormato = formatosProcesadosGlobal[codigoFormato];
        let nombreFormato = "N/A";
        let reportadoComoGeneral = "N/A";

        if (filasParaEsteFormato.length > 0) {
            const key = Object.keys(filasParaEsteFormato[0]).find(k => k.startsWith(NOMBRE_FORMATO_KEY));
            if (key && filasParaEsteFormato[0][key]) {
                nombreFormato = filasParaEsteFormato[0][key];
            }
            const rkey = Object.keys(filasParaEsteFormato[0]).find(k => k.startsWith(REPORTADO_COMO_KEY));
            if (rkey && filasParaEsteFormato[0][rkey]) {
                reportadoComoGeneral = filasParaEsteFormato[0][rkey];
            } else {
                reportadoComoGeneral = "(No especificado)";
            }
        }

        const encabezadosS2ActivosEsteFormato = [...new Set(filasParaEsteFormato.flatMap(f => Object.keys(f).map(k => k.replace(/_idx\d+$/, ''))))].filter(h => !encabezadosS1Global.includes(h));

        const dataTabButtonId = `btn-tab-${codigoFormato}`;
        const dataTabContentId = `content-tab-${codigoFormato}`;
        const dataButton = document.createElement('button');
        dataButton.id = dataTabButtonId;
        dataButton.className = 'tab-link';
        dataButton.textContent = codigoFormato;
        dataButton.onclick = (e) => activateTab(e.currentTarget, dataTabContentId);
        tabHeader.appendChild(dataButton);

        const listItem = document.createElement('li');
        const link = document.createElement('a');
        link.href = '#';
        link.textContent = `${codigoFormato} - ${nombreFormato}`;
        link.onclick = (e) => {
            e.preventDefault();
            activateTab(dataButton, dataTabContentId);
        };
        listItem.appendChild(link);
        indiceListUl.appendChild(listItem);

        const dataContentDiv = document.createElement('div');
        dataContentDiv.id = dataTabContentId;
        dataContentDiv.className = 'tab-content';

        const dataTitle = document.createElement('h2');
        dataTitle.className = 'content-title';
        dataTitle.textContent = `Formato: ${codigoFormato} - ${nombreFormato}`;
        const dataSubtitle = document.createElement('h4');
        dataSubtitle.className = 'detail-subtitle';
        dataSubtitle.textContent = `Detalle Consulta General de lo Reportado por Terceros para: ${reportadoComoGeneral}`;

        dataContentDiv.appendChild(dataTitle);
        dataContentDiv.appendChild(dataSubtitle);

        dataContentDiv.appendChild(
            crearSubPestanas(codigoFormato, nombreFormato, filasParaEsteFormato, encabezadosS1Global, encabezadosS2ActivosEsteFormato)
        );

        tabContentContainer.appendChild(dataContentDiv);
    }
    
    // Populate the Resumen tab after all other content is created.
    //setTimeout(populateResumenGeneralTab, 0);

    // Activate resumen tab by default
    if (resumenButton && resumenButton.isConnected) {
        activateTab(resumenButton, resumenTabContentId);
    } else if (exogenaButton && exogenaButton.isConnected) {
        activateTab(exogenaButton, exogenaTabContentId);
    }
}





   
    
        /**
         * Activa una pestaña y muestra su contenido.
         * @param {HTMLElement} tabButtonElement - El botón de la pestaña que se ha hecho clic.
         * @param {string} tabContentIdToOpen - El ID del contenido de la pestaña a mostrar.
         */
        
        function activateTab(tabButtonElement, tabContentIdToOpen) {
    // Obtiene el contenedor de los botones (.tab-header o .sub-tab-header)
    const parentHeader = tabButtonElement.closest('.tab-header, .sub-tab-header');
    if (!parentHeader) return;

    // Obtiene el contenedor de los paneles de contenido
    const parentContentContainer = parentHeader.nextElementSibling;
    if (!parentContentContainer) return;

    // --- MEJORA #1: Selectores precisos ---
    // Oculta solo los paneles de contenido que son hijos directos.
    // Esto evita que se oculten las subpestañas de forma no deseada.
    for (const child of parentContentContainer.children) {
        if (child.classList.contains('tab-content') || child.classList.contains('sub-tab-content')) {
            child.style.display = 'none';
        }
    }

    // Desactiva solo los botones que son hijos directos.
    for (const child of parentHeader.children) {
        if (child.classList.contains('tab-link') || child.classList.contains('sub-tab-link')) {
            child.classList.remove('active');
        }
    }

    // Muestra el panel de contenido objetivo
    const targetContent = document.getElementById(tabContentIdToOpen);
    if (targetContent) {
        targetContent.style.display = 'block';
    }

    // Activa el botón de la pestaña objetivo
    if (tabButtonElement) {
       tabButtonElement.classList.add('active');
    }

    // --- MEJORA #2: Activación explícita de subpestaña ---
    // Si acabamos de activar una pestaña principal (un formato), ahora activamos
    // explícitamente su primera subpestaña ("Resumen"), eliminando la dependencia del setTimeout.
    if (tabButtonElement.classList.contains('tab-link')) {
        const mainContentPanel = document.getElementById(tabContentIdToOpen);
        if (mainContentPanel) {
            // Busca el primer botón de subpestaña dentro del panel principal que acabamos de mostrar.
            const firstSubTabButton = mainContentPanel.querySelector('.sub-tab-header .sub-tab-link');
            if (firstSubTabButton) {
                // Simula un clic en él para que se active de forma automática.
                firstSubTabButton.click();
            }
        }
    }
}


        /**
         * Exporta los datos procesados a un nuevo archivo Excel.
         */
        function exportarDatos() {
            if (Object.keys(formatosProcesadosGlobal).length === 0 && datosBrutosParaExogena.length === 0) {
                updateStatus("No hay datos para exportar.");
                return;
            }
            updateStatus("Generando archivo Excel para exportar...");

            const wb = XLSX.utils.book_new();

            if (datosBrutosParaExogena.length > 0) {
                const exogenaSheetData = [encabezadosOriginalesGlobal];
                datosBrutosParaExogena.forEach(row => {
                    exogenaSheetData.push(encabezadosOriginalesGlobal.map((header) => row[header] !== undefined ? row[header] : ""));
                });
                const wsExogena = XLSX.utils.aoa_to_sheet(exogenaSheetData);
                XLSX.utils.book_append_sheet(wb, wsExogena, "Exogena");
            }


            for (const codigoFormato in formatosProcesadosGlobal) {
                const filasParaHoja = formatosProcesadosGlobal[codigoFormato];
                if (!filasParaHoja || filasParaHoja.length === 0) continue;

                const encabezadosDeLaHoja = encabezadosOriginalesGlobal;

                const datosParaHoja = [];
                datosParaHoja.push(encabezadosDeLaHoja);

                filasParaHoja.forEach(filaProcesada => {
                    const filaArray = encabezadosDeLaHoja.map((header) => {
                        const cellValue = filaProcesada[header];
                        return cellValue !== undefined ? cellValue : "";
                    });
                    datosParaHoja.push(filaArray);
                });

                const ws = XLSX.utils.aoa_to_sheet(datosParaHoja);
                let nombreHojaExport = String(codigoFormato);
                if (filasParaHoja.length > 0) {
                    const nombreFormato = filasParaHoja[0][NOMBRE_FORMATO_KEY];
                    if(nombreFormato){
                       nombreHojaExport += " " + String(nombreFormato);
                    }
                }
                nombreHojaExport = nombreHojaExport.replace(/[\*\?\:\/\\\[\]]/g, '_').substring(0, 30);
                XLSX.utils.book_append_sheet(wb, ws, nombreHojaExport);
            }

            if (wb.SheetNames.length === 0) {
                updateStatus("No se generaron hojas con datos para exportar.");
                return;
            }

            const nombreArchivo = `Excel_Procesado_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, nombreArchivo);
            updateStatus(`Archivo "${nombreArchivo}" exportado.`);
        }
        
        // --- NEW FUNCTIONS FOR "RESUMEN" TAB ---

        const resumenGeneralConfig = [
            // Sección Ingresos
            { id: '1001-ingresos', codigo: '1001', nombre: 'Pagos o Abonos en Cuenta y Retenciones Practicadas', seccion: 'Ingresos', source: { tableIdSuffix: '1001-ingresos', valueType: 'total' } },
            { id: '1020-ingresos', codigo: '1020', nombre: 'Certificados de Depósito a Término - Rendimientos Pagados', seccion: 'Ingresos', source: { tableIdSuffix: '1020-Ingresos', valueType: 'column', headerName: 'CDT Rendimientos Pagados' } },
            { id: '1021-ingresos', codigo: '1021', nombre: 'Información de los Fondos de Inversion Colectiva - Rendimientos', seccion: 'Ingresos', source: { tableIdSuffix: '1021-Ingresos', valueType: 'column', headerName: 'Cartera Colectiva Rendimientos Pagado' } },
            { id: '1024-ingresos', codigo: '1024', nombre: 'Ventas a Través del Sistema de Tarjetas de Crédito', seccion: 'Ingresos', source: { tableIdSuffix: '1024-Ingresos', valueType: 'total' } },
            { id: '1032-enajenacion', codigo: '1032', nombre: 'Información de Enejenación de Bienes y Derechos a Través de Notaria', seccion: 'Ingresos', source: { tableIdSuffix: '1032-Enajenacion-de-Bienes-y-Derechos-Notaria', valueType: 'column', headerName: 'Valor enajenación en Notaría ponderado por enajenante' } },
            { id: '1647-ingresos-terceros', codigo: '1647', nombre: 'Ingresos Recibidos para Terceros', seccion: 'Ingresos', source: { tableIdSuffix: '1647-Ingresos-Recibidos-para-Terceros', valueType: 'column', headerName: 'Ingreso distribuido al tercero' } },
            { id: '2273-dividendos', codigo: '2273', nombre: 'Deposito de Titulos Valores y Rendimientos o Dividendos Cancelados - Dividendos', seccion: 'Ingresos', source: { tableIdSuffix: '2273-Ingresos', valueType: 'column', headerName: 'Recaudo dividendos Deceval' } },
            { id: '2273-rendimientos', codigo: '2273', nombre: 'Deposito de Titulos Valores y Rendimientos o Dividendos Cancelados - Rendimientos', seccion: 'Ingresos', source: { tableIdSuffix: '2273-Ingresos', valueType: 'column', headerName: 'Recaudo Rendimientos Deceval' } },
            { id: '2276-ingresos', codigo: '2276', nombre: 'Información de Rentas de Trabajo y de Pensiones', seccion: 'Ingresos', source: { tableIdSuffix: '2276-ingresos', valueType: 'total' } },
            { id: '5247-ingresos', codigo: '5247', nombre: 'Pagos o Abonos en Cuenta y Retenciones Cttos Colaboración Empresarial', seccion: 'Ingresos', source: { tableIdSuffix: '5247-ingresos', valueType: 'total' } },
            

            // Sección Retención en la fuente
            { id: '1001-retencion', codigo: '1001', nombre: 'Pagos o Abonos en Cuenta y Retenciones Practicadas', seccion: 'Retención en la fuente', source: { tableIdSuffix: '1001-retencionFuente', valueType: 'total' } },
            { id: '1020-retencion', codigo: '1020', nombre: 'Certificados de Depósito a Término - Retención Practicada', seccion: 'Retención en la fuente', source: { tableIdSuffix: '1020-Ingresos', valueType: 'column', headerName: 'CDT Retención prácticada' } },
            { id: '1647-retencion-terceros', codigo: '1647', nombre: 'Ingresos Recibidos para Terceros', seccion: 'Retención en la fuente', source: { tableIdSuffix: '1647-Ingresos-Recibidos-para-Terceros', valueType: 'column', headerName: 'Retención distribuida al tercero' } },
            { id: '2273-retencion', codigo: '2273', nombre: 'Deposito de Titulos Valores y Rendimientos o Dividendos Cancelados', seccion: 'Retención en la fuente', source: { tableIdSuffix: '2273-Ingresos', valueType: 'column', headerName: 'Retención en la Fuente Deceval' } },
            { id: '2276-retencion', codigo: '2276', nombre: 'Información de Rentas de Trabajo y de Pensiones', seccion: 'Retención en la fuente', source: { tableIdSuffix: '2276-retefuente', valueType: 'total' } },
            { id: '1021-retencion', codigo: '1021', nombre: 'Información de los Fondos de Inversion Colectiva', seccion: 'Retención en la fuente', source: { tableIdSuffix: '1021-Ingresos', valueType: 'column', headerName: 'Valor Total Retención Rendimientos' } },
            { id: '5247-retencion', codigo: '5247', nombre: 'Pagos o Abonos en Cuenta y Retenciones Cttos Colaboración Empresarial - Retención', seccion: 'Retención en la fuente', source: { tableIdSuffix: '5247-retencionFuente', valueType: 'total' } },
            { id: '1001-reteiva', codigo: '1001', nombre: 'Pagos o Abonos en Cuenta y Retenciones Practicadas - ReteIVA', seccion: 'Retención en la fuente', source: { tableIdSuffix: '1001-reteIVA', valueType: 'total' } },
            { id: '5247-reteiva', codigo: '5247', nombre: 'Pagos o Abonos en Cuenta y Retenciones Cttos Colaboración Empresarial - ReteIVA', seccion: 'Retención en la fuente', source: { tableIdSuffix: '5247-reteIVA', valueType: 'total' } },

            // Sección Retenciones Practicadas
            { id: '1003-bases', codigo: '1003', nombre: 'Retenciones en la Fuente que le Practican  - Bases', seccion: 'Retenciones Practicadas', source: { tableIdSuffix: '1003-Bases-Retenciones-Practicadas', valueType: 'total' } },
            { id: '1003-retenciones', codigo: '1003', nombre: 'Retenciones en la Fuente que le Practican - Retenciones', seccion: 'Retenciones Practicadas', source: { tableIdSuffix: '1003-Retenciones-Practicadas', valueType: 'total' } },
            
            // Sección Impuesto Sobre las Ventas e Impuesto al Consumo
            { id: '1005-iva-descontable-propio', codigo: '1005', nombre: 'Impuesto a las Ventas por Pagar (Descontable) - (Generado por el Denunciado)', seccion: 'Impuesto Sobre las Ventas e Impuesto al Consumo', source: { tableIdSuffix: '1005-IVA-Descontable', valueType: 'total' } },
            { id: '1005-iva-descontable-1001', codigo: '1001', nombre: 'Impuesto a las Ventas por Pagar (Descontable) - (F1001) - (Generado por el Denunciado)', seccion: 'Impuesto Sobre las Ventas e Impuesto al Consumo', source: { tableIdSuffix: '1005-IVA-Descontable-(F1001)', valueType: 'total' } },
            { id: '1005-iva-descontable-1024', codigo: '1024', nombre: 'Impuesto a las Ventas por Pagar (Descontable) - (F1024) - (Generado por el Denunciado)', seccion: 'Impuesto Sobre las Ventas e Impuesto al Consumo', source: { tableIdSuffix: '1005-IVA-Descontable-(F1024)', valueType: 'total' } },
            { id: '1024-iva-generado', codigo: '1024', nombre: 'IVA Generado (F1024)', seccion: 'Impuesto Sobre las Ventas e Impuesto al Consumo', source: { tableIdSuffix: '1024-IVA-Gene', valueType: 'total' } },
            { id: '1005-iva-descontable-5249', codigo: '5249', nombre: 'Impuesto a las Ventas por Pagar (Descontable) - (F5249) - (Generado por el Denunciado)', seccion: 'Impuesto Sobre las Ventas e Impuesto al Consumo', source: { tableIdSuffix: '1005-IVA-Descontable-(F5249)', valueType: 'total' } },
            { id: '1005-ic-propio', codigo: '1005', nombre: 'Impuesto a las Ventas por Pagar (Descontable) - Impoconsumo', seccion: 'Impuesto Sobre las Ventas e Impuesto al Consumo', source: { tableIdSuffix: '1005-Impuesto-al-Consumo', valueType: 'total' } },
            { id: '1005-ic-1024', codigo: '1005', nombre: 'Impuesto a las Ventas por Pagar (Descontable) - Impoconsumo - (F1024)', seccion: 'Impuesto Sobre las Ventas e Impuesto al Consumo', source: { tableIdSuffix: '1005-Impuesto-al-Consumo-(F1024)', valueType: 'total' } },
            { id: '1006-iva-generado-propio', codigo: '1006', nombre: 'Impuesto a las Ventas por Pagar (Generado) e Impuesto al Consumo - (Descontable para el Denunciado)', seccion: 'Impuesto Sobre las Ventas e Impuesto al Consumo', source: { tableIdSuffix: '1006-IVA-Generado', valueType: 'total' } },
            { id: '5250-iva-generado-5250', codigo: '1006', nombre: 'Impuesto a las Ventas por Pagar (Generado) e Impuesto al Consumo (F5250) - (Descontable para el Denunciado)', seccion: 'Impuesto Sobre las Ventas e Impuesto al Consumo', source: { tableIdSuffix: '1006-IVA-Generado-(F5250)', valueType: 'total' } },
            
            // Sección Costos y Deducciones
            { id: '1006-ic-propio-costos', codigo: '1006', nombre: 'Impuesto a las Ventas por Pagar (Generado) e Impuesto al Consumo (Impoconsumo) - (F1006)', seccion: 'Costos y Deducciones - INRNGO', source: { tableIdSuffix: '1006-Impuesto-al-Consumo', valueType: 'total' } },
            { id: '1007-compras', codigo: '1007', nombre: 'Ingresos Recibidos y Devoluciones', seccion: 'Costos y Deducciones - INRNGO', source: { tableIdSuffix: '1007-Compras', valueType: 'total' } },
            { id: '2276-aportes', codigo: '2276', nombre: 'Información de Rentas de Trabajo y de Pensiones - Aportes Salud y Pensión', seccion: 'Costos y Deducciones - INRNGO', source: { tableIdSuffix: '2276-aportes', valueType: 'total' } },
            { id: '5248-compras', codigo: '5248', nombre: 'Ingresos Recibidos y Devoluciones Cttos Colaboración Empresarial', seccion: 'Costos y Deducciones - INRNGO', source: { tableIdSuffix: '5248-Compras', valueType: 'total' } },
            

            // Sección Pasivos
            { id: '1008-cxp-propio', codigo: '1008', nombre: 'Saldo de Cuentas por Cobrar al 31 Diciembre', seccion: 'Pasivos', source: { tableIdSuffix: '1008-Cuentas-por-Pagar', valueType: 'total' } },
            { id: '1008-cxp-5251', codigo: '1008', nombre: 'Saldo de Cuentas por Cobrar al 31 Diciembre (F5251) ', seccion: 'Pasivos', source: { tableIdSuffix: '1008-Cuentas-por-Pagar-(F5251)', valueType: 'total' } },
            
            // Patrimonio
            { id: '1009-cxc-propio', codigo: '1009', nombre: 'Saldo de Cuentas por Pagar al 31 de Diciembre (F1009)', seccion: 'Patrimonio', source: { tableIdSuffix: '1009-Cuentas-por-Cobrar', valueType: 'total' } },
            { id: '1009-cxc-5252', codigo: '5252', nombre: 'Saldo de Cuentas por Pagar al 31 de Diciembre (F5252)', seccion: 'Patrimonio', source: { tableIdSuffix: '1009-Cuentas-por-Cobrar-(F5252)', valueType: 'total' } },
            { id: '1010-patrimonio', codigo: '1010', nombre: 'Informacion de Socios, Accionistas, Comuneros y/ Cooperados', seccion: 'Patrimonio', source: { tableIdSuffix: '1010-Resumen-Valor-Patrimonial-Socios', valueType: 'column', headerName: 'Valor patrimonial acciones socios' } },
            { id: '1013-patrimonio', codigo: '1013', nombre: 'Fideicomisos Administrados', seccion: 'Patrimonio', source: { tableIdSuffix: '1013-Resumen-de-Fiducias', valueType: 'column', headerName: 'Fiducia Admistracion y pagos Valor Patrimonial' } },
            { id: '1019-saldo', codigo: '1019', nombre: 'Movimiento en Cuenta Corriente y/o Ahorro - Saldo Cuentas', seccion: 'Patrimonio', source: { tableIdSuffix: '1019-SaldoCuentas', valueType: 'column', headerName: 'Total Saldo Final Periodo de la Cuenta' } },
            { id: '1020-patrimonio', codigo: '1020', nombre: 'Certificados de Depósito a Término - Saldo Final', seccion: 'Patrimonio', source: { tableIdSuffix: '1020-Patrimonio', valueType: 'total' } },
            { id: '1021-patrimonio', codigo: '1021', nombre: 'Información de los Fondos de Inversion Colectiva', seccion: 'Patrimonio', source: { tableIdSuffix: '1021-Patrimonio', valueType: 'total' } },
            { id: '1032-adquisicion', codigo: '1032', nombre: 'Información de Enejenación de Bienes y Derechos a Través de Notaria', seccion: 'Patrimonio', source: { tableIdSuffix: '1032-Enajenacion-de-Bienes-y-Derechos-Notaria', valueType: 'column', headerName: 'Valor adquisición en Notaría ponderado por adquirente' } },
            { id: '1042-adquisicion', codigo: '1042', nombre: 'Información a Suministrar por los Comisionistas de Bolsa', seccion: 'Patrimonio', source: { tableIdSuffix: '1042-Adquisiciones-a-traves-de-Comisionistas', valueType: 'total' } },
            { id: '1476-participacion', codigo: '1476', nombre: 'Información de Registros Catastrales y de Impuesto Predial', seccion: 'Patrimonio', source: { tableIdSuffix: '1476-Informacion-Catastral-y-de-Impuesto-Predial', valueType: 'column', headerName: 'Total Participación' } },
            { id: '1480-avaluo', codigo: '1480', nombre: 'Informacion de Vehiculos', seccion: 'Patrimonio', source: { tableIdSuffix: '1480-Vehiculos', valueType: 'column', headerName: 'Total Propiedad' } },
            { id: '2273-saldo', codigo: '2273', nombre: 'Deposito de Titulos Valores y Rendimientos o Dividendos Cancelados', seccion: 'Patrimonio', source: { tableIdSuffix: '2273-Saldos-en-Deposito', valueType: 'total' } },
            { id: '2274-abonadas', codigo: '2274', nombre: 'Fondo de Cesantias - Cesantias Abonadas', seccion: 'Patrimonio', source: { tableIdSuffix: '2274-Cesantias', valueType: 'column', headerName: 'Cesantías abonadas período' } },
            { id: '2274-acumuladas', codigo: '2274', nombre: 'Fondo de Cesantias - Cesantias Acumuladas 2017 y Siguientes', seccion: 'Patrimonio', source: { tableIdSuffix: '2274-Cesantias', valueType: 'column', headerName: 'Cesantías acumuladas 2017 y sig 31 dic año reporte' } },
           
            // Sección Movimientos
            { id: '1013-inversion', codigo: '1013', nombre: 'Fideicomisos Administrados', seccion: 'Movimientos Bancarios', source: { tableIdSuffix: '1013-Resumen-de-Fiducias', valueType: 'column', headerName: 'Fiducia Admon y pagos Inversión Año' } },
            { id: '1019-debito', codigo: '1019', nombre: 'Movimiento en Cuenta Corriente y/o Ahorro - Débito', seccion: 'Movimientos Bancarios', source: { valueKey: '1019-debito-neto' } },
            { id: '1019-credito', codigo: '1019', nombre: 'Movimiento en Cuenta Corriente y/o Ahorro - Crédito', seccion: 'Movimientos Bancarios', source: { valueKey: '1019-credito-neto' } },
            { id: '1021-movimientos', codigo: '1021', nombre: 'Información de los Fondos de Inversion Colectiva', seccion: 'Movimientos Bancarios', source: { tableIdSuffix: '1021-Movimientos', valueType: 'total' } },
           
            // Sección Otros Parámetros
            { id: '1023-consumo', codigo: '1023', nombre: 'Consumos con Tarjeta de Crédito', seccion: 'Otros Parámetros', source: { tableIdSuffix: '1023-Consumos-con-Tarjeta-de-Credito', valueType: 'total' } },
            { id: '1024-venta', codigo: '1024', nombre: 'Ventas con Tarjeta de Crédito', seccion: 'Otros Parámetros', source: { tableIdSuffix: '1024-Ventas-con-Tarjeta-de-Credito', valueType: 'column', headerName: 'Venta con tarjeta crédito' } },
            { id: '1026-prestamos', codigo: '1026', nombre: 'Prestamos Bancarios Otorgados', seccion: 'Otros Parámetros', source: { tableIdSuffix: '1026-Prestamos-Bancarios-Otorgados', valueType: 'total' } },
            { id: '1038-camara-ccio', codigo: '1038', nombre: 'Creación Sociedades Cámara de Comercio', seccion: 'Otros Parámetros', source: { tableIdSuffix: '1038-Constitucion-Sociedades', valueType: 'column', headerName: 'Capital Socio sociedad creada en Cámara Comercio' } },
            { id: '1481-ica', codigo: '1481', nombre: 'Impuesto de Industria y Comercio, Avisos y Tableros', seccion: 'Otros Parámetros', source: { tableIdSuffix: '1481-ICA', valueType: 'column', headerName: 'ICA - Ingresos brutos jurisdicción' } },
            { id: '2575-donaciones', codigo: '2575', nombre: 'Donaciones Recibidas y Certificadas por Entidades No Contribuyentes', seccion: 'Otros Parámetros', source: { tableIdSuffix: '2575-Donaciones-Recibidas', valueType: 'total' } },
        ];
        

function generarContenidoResumen() {
    const container = document.createElement('div');
    container.id = "resumen-general-container";

    const toggleAndTitleWrapper = document.createElement('div');
    toggleAndTitleWrapper.style.display = 'flex';
    toggleAndTitleWrapper.style.justifyContent = 'space-between';
    toggleAndTitleWrapper.style.alignItems = 'center';
    toggleAndTitleWrapper.style.marginBottom = '1rem';

    const sectionMainTitle = document.createElement('h2');
    sectionMainTitle.textContent = 'Resumen General';
    sectionMainTitle.style.margin = '0';
    toggleAndTitleWrapper.appendChild(sectionMainTitle);

    const toggleContainerDiv = document.createElement('div');
    toggleContainerDiv.className = 'toggle-container';
    toggleContainerDiv.style.marginLeft = '0';
    toggleContainerDiv.innerHTML = `
         <label for="hide-zero-toggle" style="font-weight: 500; color: var(--text-secondary); cursor: pointer;">Ocultar Valores en Cero</label>
    <label class="toggle-switch">
        <input type="checkbox" id="hide-zero-toggle" onchange="toggleZeroRows()">
        <span class="slider"></span>
    </label>
    `;
    toggleAndTitleWrapper.appendChild(toggleContainerDiv);
    container.appendChild(toggleAndTitleWrapper);
   
    const groupedBySection = resumenGeneralConfig.reduce((acc, item) => {
        const section = item.seccion;
        if (!acc[section]) acc[section] = [];
        acc[section].push(item);
        return acc;
    }, {});
    
    const sectionOrder = ['Patrimonio', 'Pasivos', 'Ingresos', 'Costos y Deducciones - INRNGO', 'Retención en la fuente', 'Retenciones Practicadas', 'Impuesto Sobre las Ventas e Impuesto al Consumo', 'Movimientos Bancarios', 'Otros Parámetros'];

    sectionOrder.forEach(sectionName => {
        if (!groupedBySection[sectionName]) return;

        const titleWrapper = document.createElement('div');
        titleWrapper.className = 'section-title-wrapper';

        const sectionTitle = document.createElement('h3');
        sectionTitle.textContent = sectionName;
        titleWrapper.appendChild(sectionTitle);

        const cameraIcon = document.createElement('span');
        cameraIcon.className = 'capture-icon';
        cameraIcon.title = `Capturar sección "${sectionName}" como imagen`;
        cameraIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828-.828A2 2 0 0 1 3.172 4H2zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1zm9 2.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0z"/></svg>`;
        
        cameraIcon.onclick = () => {
            const sectionWrapperForCapture = document.createElement('div');
            
            // --- INICIO DE LA MEJORA ---
            // Se clona solo el título (h3), no el contenedor completo con el ícono.
            const titleElement = titleWrapper.querySelector('h3');
            if(titleElement) {
                sectionWrapperForCapture.appendChild(titleElement.cloneNode(true));
            }
            // --- FIN DE LA MEJORA ---

            const tableElement = titleWrapper.nextElementSibling;
            if(tableElement && tableElement.tagName === 'TABLE') {
                sectionWrapperForCapture.appendChild(tableElement.cloneNode(true));
            }
            capturarElementoComoImagen(sectionWrapperForCapture, sectionName);
        };
        
        titleWrapper.appendChild(cameraIcon);
        container.appendChild(titleWrapper);

        const table = document.createElement('table');
        table.classList.add('resumen-general-tabla');
        table.id = `table-resumen-${normalizeText(sectionName)}`;
        const thead = table.createTHead();
        const tbody = table.createTBody();
        const headerRow = thead.insertRow();
        
       ['Código Formato', 'Nombre Formato', 'Valor'].forEach((headerText, index) => {
           const th = document.createElement('th');
           th.textContent = headerText;
           if (index === 0) { th.style.width = '15%'; }
           else if (index === 1) { th.style.width = '60%'; }
           else { th.style.width = '25%'; }
           headerRow.appendChild(th);
        });

        groupedBySection[sectionName].forEach(item => {
            const tr = tbody.insertRow();
            const codigoCell = tr.insertCell();
            const link = document.createElement('a');
            link.href = '#'; // Se usa # para que el cursor cambie, pero el evento previene la navegación.
            link.textContent = item.codigo;
            link.style.color = 'var(--primary-color)';
            link.style.textDecoration = 'underline';
            link.style.fontWeight = 'bold';
            link.onclick = function(e) {
                e.preventDefault(); // Evita que la página salte al inicio.
                const tabButton = document.getElementById(`btn-tab-${item.codigo}`);
                if (tabButton) {
                    tabButton.click(); // Simula un clic en la pestaña del formato correspondiente.
                } else {
                    console.warn(`No se encontró el botón de la pestaña para el formato ${item.codigo}`);
                }
            };
            codigoCell.appendChild(link);
            codigoCell.style.textAlign = 'center';
            tr.cells[0].style.textAlign = 'center';
            tr.insertCell().textContent = item.nombre;
            const valorCell = tr.insertCell();
            valorCell.setAttribute('contenteditable', 'true');
            valorCell.dataset.id = item.id;
            valorCell.innerHTML = formatNumber(0);
            valorCell.style.textAlign = 'right';
            valorCell.classList.add('numeric-cell');
            valorCell.addEventListener('blur', (e) => {
                const cell = e.target;
                const rawValue = cell.textContent;
                const numericValue = parseCleanedInteger(rawValue);
                cell.innerHTML = formatNumber(numericValue);
                updateSectionTotal(table);
            });
            valorCell.addEventListener('keydown', (e) => {
               if (e.key === 'Enter') {
                   e.preventDefault();
                   e.target.blur();
               }
            });
        });

        const needsTotal = ['Patrimonio', 'Pasivos', 'Ingresos', 'Costos y Deducciones - INRNGO', 'Retención en la fuente'].includes(sectionName);
        if (needsTotal) {
            const tfoot = table.createTFoot();
            const footerRow = tfoot.insertRow();
            const totalLabelCell = footerRow.insertCell();
            totalLabelCell.style.textAlign = 'left';
            totalLabelCell.colSpan = 2;
            totalLabelCell.textContent = `Total ${sectionName}`;
            const totalValueCell = footerRow.insertCell();
            totalValueCell.classList.add('numeric-cell');
            totalValueCell.id = `total-resumen-${normalizeText(sectionName)}`;
            totalValueCell.innerHTML = formatNumber(0);
        }
        
        container.appendChild(table);
    });

    return container;
}
      

      /**
 * Revisa la tabla de resumen del formato 1476 para ver si alguna fila
 * en la columna "Total Participación" tiene un valor de cero.
 * @returns {boolean} - True si se encuentra al menos un cero, de lo contrario false.
 */
function checkForZeroParticipationIn1476() {
    const table1476 = document.getElementById('summaryTable-1476-Informacion-Catastral-y-de-Impuesto-Predial');
    if (!table1476) return false;

    const thead = table1476.querySelector('thead');
    const tbody = table1476.querySelector('tbody');
    if (!thead || !tbody) return false;

    // Encuentra el índice de la columna "Total Participación"
    const headerCells = Array.from(thead.querySelectorAll('th'));
    const totalColumnIndex = headerCells.findIndex(th => th.textContent.includes('Total Participación'));

    if (totalColumnIndex === -1) return false;

    // Revisa cada fila en el cuerpo de la tabla
    for (const row of tbody.rows) {
        const cell = row.cells[totalColumnIndex];
        if (cell) {
            const value = parseCleanedInteger(cell.textContent);
            if (value === 0) {
                return true; // Se encontró un cero, no es necesario seguir buscando.
            }
        }
    }

    return false; // No se encontraron ceros.
}


/**
 * Llena la tabla de "Resumen General" con los valores calculados de cada formato
 * y añade la leyenda de advertencia para el formato 1476 si es necesario.
 */
function populateResumenGeneralTab() {
    // Llama a la nueva función de verificación al principio.
    const hasZeroParticipation = checkForZeroParticipationIn1476();

    resumenGeneralConfig.forEach(item => {
        const valorCell = document.querySelector(`#resumen-general-container td[data-id="${item.id}"]`);
        if (valorCell) {
            const value = calculateSummaryValue(item.id);
            valorCell.innerHTML = formatNumber(value);

            // --- INICIO DE LA MEJORA ---
            const nameCell = valorCell.previousElementSibling; // La celda con el nombre del formato
            if (nameCell) {
                // Limpia cualquier leyenda anterior para evitar duplicados
                const existingLegend = nameCell.querySelector('.warning-legend');
                if (existingLegend) {
                    existingLegend.remove();
                }

                // Si es el formato 1476 y se encontró una participación de cero, añade la leyenda.
                if (item.id === '1476-participacion' && hasZeroParticipation) {
                    const legend = document.createElement('span');
                    legend.textContent = ' (Predio participación cero)';
                    legend.style.color = 'red';
                    legend.style.fontWeight = 'normal';
                    legend.style.fontSize = '0.8em';
                    legend.className = 'warning-legend'; // Clase para identificar la leyenda
                    nameCell.appendChild(legend);
                }
            }
 }

            });

            const allSummaryTables = document.querySelectorAll('#resumen-general-container table');
            allSummaryTables.forEach(table => {
                updateSectionTotal(table);
            });

            toggleZeroRows(); 
}

        function updateSectionTotal(tableElement) {
            const tbody = tableElement.querySelector('tbody');
            if (!tbody) return;
            const totalCell = document.getElementById(`total-resumen-${normalizeText(tableElement.id.replace('table-resumen-', ''))}`);
            if (!totalCell) return;

            let total = 0;
            tbody.querySelectorAll('tr').forEach(row => {
                const valueCell = row.cells[2];
                if (valueCell) {
                    total += parseCleanedInteger(valueCell.textContent);
                }
            });

            totalCell.innerHTML = formatNumber(total);
        }
        
 
function calculateSummaryValue(valueId) {
    const config = resumenGeneralConfig.find(item => item.id === valueId);
    if (!config || !config.source) {
        console.error(`No source config found for ID: ${valueId}`);
        return 0;
    }

    // --- INICIO DE LA CORRECCIÓN ---
    // Lógica para obtener el valor desde el objeto de datos, evitando leer el DOM.
    if (config.source.valueKey) {
        return resumenGeneralData[config.source.valueKey] || 0;
    }
    // --- FIN DE LA CORRECCIÓN ---

    const { tableIdSuffix, valueType, headerName } = config.source;
    const table = document.getElementById(`summaryTable-${tableIdSuffix}`);

    if (!table) { return 0; }

    const tfoot = table.querySelector('tfoot');
    if (!tfoot || tfoot.rows.length === 0) {
        return 0;
    }

    const headerRow = table.querySelector('thead tr');
    if (!headerRow) return 0;

    const footerRow = tfoot.rows[tfoot.rows.length - 1];

    if (valueType === 'total') {
        const lastCell = footerRow.cells[footerRow.cells.length - 1];
        return lastCell ? parseCleanedInteger(lastCell.textContent) : 0;
    }

    if (valueType === 'column') {
        let columnIndex = -1;
        for (let i = 0; i < headerRow.cells.length; i++) {
            const headerText = headerRow.cells[i].textContent.split('--')[0].trim(); 
            if (headerText === headerName) {
                columnIndex = i;
                break;
            }
        }
        if (columnIndex === -1) return 0;

        const firstFooterCell = footerRow.cells[0];
        const colSpan = firstFooterCell ? firstFooterCell.colSpan : 1;
        const indexOffset = colSpan > 1 ? colSpan - 1 : 0;
        const targetCellIndexInFooter = columnIndex - indexOffset;

        if (targetCellIndexInFooter < 0 || targetCellIndexInFooter >= footerRow.cells.length) {
            return 0;
        }

        const columnCell = footerRow.cells[targetCellIndexInFooter];
        return columnCell ? parseCleanedInteger(columnCell.textContent) : 0;
    }

    return 0;
}



        function updateClock() {
            const now = new Date();
            const options = {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: true
            };
            const formattedDateTime = now.toLocaleString('es-CO', options);
            document.getElementById('current-datetime').textContent = `Fecha de Proceso: ${formattedDateTime}`;
        }
        
        setInterval(updateClock, 1000);
        
        document.addEventListener('DOMContentLoaded', updateClock);



// ▼▼▼ REEMPLAZA TU FUNCIÓN generarPDF ACTUAL CON ESTA VERSIÓN CORREGIDA ▼▼▼

async function generarPDF() {
    const radicadoInput = document.getElementById('radicado-sidf');
    if (!radicadoInput || !radicadoInput.value.trim()) {
        const errorMessage = "Por favor, ingrese el 'Número Radicado Denuncia SIDF' antes de generar el informe.";
        updateStatus(errorMessage);
        const statusDiv = document.getElementById('status');
        statusDiv.style.color = '#EF4444';
        statusDiv.style.fontWeight = 'bold';
        return;
    }

    let anioInfo = "AÑO";
    if (encabezadoCualitativoGlobal && encabezadoCualitativoGlobal.length > 0) {
        if (encabezadoCualitativoGlobal[7] && encabezadoCualitativoGlobal[7][2]) {
             anioInfo = String(encabezadoCualitativoGlobal[7][2]).trim();
        }
    }
    const radicadoValue = radicadoInput.value.trim().replace(/[\/\s\\]/g, '-');
    const nombreArchivo = `Anexo_Analisis_Operaciones_${anioInfo}_${radicadoValue}.pdf`;

    updateStatus("Generando informe PDF, por favor espera...");
    document.getElementById('btnGenerarPDF').disabled = true;

    try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'pt',
            format: 'letter'
        });

        const marginLeft = 40;
        const marginTop = 60;
        const pageHeight = pdf.internal.pageSize.getHeight();
        const contentWidth = pdf.internal.pageSize.getWidth() - marginLeft * 2;
        let currentY = marginTop;

        const addHeaderAndFooter = (data) => {
            const pageNumber = data.pageNumber;
            const startY = marginTop - 30;
            pdf.setFontSize(8);
            pdf.setTextColor(100);
            pdf.setFont('helvetica', 'bold');
            pdf.text("FOCUS", marginLeft, startY);
            pdf.setFont('helvetica', 'normal');
            pdf.text("Fiscal Oversight For Compliance and Uncovering Suspicious", marginLeft, startY + 10);
            const now = new Date();
            const formattedDateTime = `Generado: ${now.toLocaleDateString('es-CO')} ${now.toLocaleTimeString('es-CO')}`;
            pdf.text(formattedDateTime, pdf.internal.pageSize.getWidth() - marginLeft, startY, { align: 'right' });
            pdf.text(`Página ${pageNumber}`, pdf.internal.pageSize.getWidth() - marginLeft, pageHeight - 20, { align: 'right' });
        };

        const checkPageBreak = (neededHeight) => {
            if (currentY + neededHeight > pageHeight - 40) {
                pdf.addPage();
                currentY = marginTop;
                return true;
            }
            return false;
        };
        
        let maxValorWidth = 0;
        const resumenContainerForCalc = document.getElementById('resumen-general-container');
        if (resumenContainerForCalc) {
            const tables = resumenContainerForCalc.querySelectorAll('table.resumen-general-tabla');
            let longestValueString = "Valor"; 
            tables.forEach(table => {
                const cells = table.querySelectorAll('tbody td:nth-child(3), tfoot td:last-child');
                cells.forEach(cell => {
                    const cellText = cell.textContent.trim();
                    if (cellText.length > longestValueString.length) {
                        longestValueString = cellText;
                    }
                });
            });
            pdf.setFontSize(8);
            maxValorWidth = pdf.getTextWidth(longestValueString) + 15;
        }

        const analysisSection = document.querySelector('.analysis-section');
        if (analysisSection) {
            const analysisTitle = analysisSection.querySelector('.analysis-title');
            if (analysisTitle) {
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(12);
                const titleLines = pdf.splitTextToSize(analysisTitle.innerText, contentWidth);
                pdf.text(titleLines, marginLeft, currentY);
                currentY += titleLines.length * 12 + 5;
            }
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(10);
            pdf.text(`Número Radicado Denuncia SIDF: ${radicadoInput.value}`, marginLeft, currentY);
            currentY += 20;
        }

        if (encabezadoCualitativoGlobal && encabezadoCualitativoGlobal.length > 0) {
            const lineHeight = 12;
            const labelIndent = marginLeft;
            const valueIndent = marginLeft + 180;

            const rowsToDraw = [];
            for (const rowData of encabezadoCualitativoGlobal) {
                const textoPrimeraCelda = rowData && rowData[0] ? String(rowData[0]).trim() : "";
                if (textoPrimeraCelda === 'Formato') break;
                if (textoPrimeraCelda && !textoPrimeraCelda.includes('Consulta Realizada por:') && !textoPrimeraCelda.includes('Usuario')) {
                    rowsToDraw.push(rowData);
                }
            }
            
            checkPageBreak(rowsToDraw.length * lineHeight);

            rowsToDraw.forEach(rowData => {
                const label = rowData[0] || '';
                let value = rowData[2] || '';
                if (normalizeText(label).includes('fechageneracion')) {
                    const dateObj = excelSerialDateToJSDate(Number(value));
                    // --- CAMBIO AQUÍ ---
                    if (dateObj) value = dateObj.toLocaleString('es-CO');
                }
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(9);
                pdf.setTextColor('#6B7280'); 
                pdf.text(String(label), labelIndent, currentY);
                if (String(value).trim() !== '') {
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(String(value), valueIndent, currentY);
                }
                currentY += lineHeight;
            });
            currentY += 15;
        }

        const resumenContainer = document.getElementById('resumen-general-container');
        if (resumenContainer) {
            const sections = resumenContainer.querySelectorAll('.section-title-wrapper');
            for (const titleWrapper of sections) {
                const titleElement = titleWrapper.querySelector('h3');
                const tableElement = titleWrapper.nextElementSibling;

                if (titleElement && tableElement && tableElement.tagName === 'TABLE') {
                    const estimatedTitleHeight = 20;
                    const estimatedTableHeight = tableElement.rows.length * 15;
                    checkPageBreak(estimatedTitleHeight + estimatedTableHeight);

                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(11);
                    pdf.setTextColor('#1F2937');
                    pdf.text(titleElement.textContent, marginLeft, currentY);
                    currentY += 18;

                    pdf.autoTable({
                        html: tableElement,
                        startY: currentY,
                        theme: 'grid',
                        styles: { fontSize: 8, cellPadding: 3 },
                        headStyles: { fillColor: '#b1bedb', textColor: '#002f63', fontStyle: 'bold', halign: 'center' },
                        footStyles: { fillColor: '#F3F4F6', textColor: '#1F2937', fontStyle: 'bold' },
                        columnStyles: {
                            0: { halign: 'center', cellWidth: 80 },
                            1: { cellWidth: 'auto' },
                            2: { halign: 'right', cellWidth: maxValorWidth > 0 ? maxValorWidth : 'auto' }
                        },
                        willDrawCell: function(data) {
                            if (data.section === 'foot' && data.column.index === 2) {
                                data.cell.styles.halign = 'right';
                            }
                        },
                        didParseCell: function (data) {
                            if (data.column.index === 2 && (data.cell.section === 'body' || data.cell.section === 'foot')) {
                                const rawValue = data.cell.raw?.textContent || data.cell.text[0];
                                const numericValue = parseCleanedInteger(rawValue);
                                data.cell.text = formatNumber(numericValue).replace(/<[^>]*>/g, '');
                            }
                        },
                        didDrawPage: addHeaderAndFooter,
                        margin: { top: marginTop }
                    });
                    currentY = pdf.autoTable.previous.finalY + 20;
                }
            }
        }

        pdf.save(nombreArchivo);
        updateStatus("Informe PDF generado exitosamente.");

    } catch (err) {
        console.error("Error al generar el PDF:", err);
        updateStatus("Ocurrió un error al generar el PDF. Revisa la consola.");
    } finally {
        document.getElementById('btnGenerarPDF').disabled = false;
    }
}




function exportOrganizedSheet() {
    if (!organizedWorksheetGlobal) {
        updateStatus("No hay una hoja organizada para exportar. Carga y procesa un archivo primero.");
        return;
    }

    updateStatus("Generando archivo Excel de la hoja organizada...");

    const wb = XLSX.utils.book_new();
    // Añade la hoja organizada al libro de Excel
    XLSX.utils.book_append_sheet(wb, organizedWorksheetGlobal, "Hoja Organizada");

    const nombreArchivo = `Archivo_Organizado_${new Date().toISOString().slice(0,10)}.xlsx`;
    XLSX.writeFile(wb, nombreArchivo);
    updateStatus(`Archivo "${nombreArchivo}" exportado.`);
}



function toggleZeroRows() {
    const hideZeros = document.getElementById('hide-zero-toggle').checked;
    // Seleccionamos solo las tablas de resumen, que son las que nos interesan.
    const summaryTables = document.querySelectorAll('#tabContentContainer .sub-tab-content[id*="subcontent-resumen"] table, #content-tab-resumen table');

    summaryTables.forEach(table => {
        const tbody = table.querySelector('tbody');
        if (!tbody) return;

        for (const row of tbody.rows) {
            let hasNonZeroValue = false;
            // Buscamos todas las celdas numéricas en la fila
            const numericCells = row.querySelectorAll('td.numeric-cell');

            if (numericCells.length > 0) {
                numericCells.forEach(cell => {
                    if (parseCleanedInteger(cell.textContent) !== 0) {
                        hasNonZeroValue = true;
                    }
                });
            } else {
                // Si no hay celdas numéricas, la fila no se considera "de ceros"
                hasNonZeroValue = true; 
            }

            if (!hasNonZeroValue) { // Si la fila solo contiene ceros
                if (hideZeros) {
                    row.classList.add('row-is-zero');
                } else {
                    row.classList.remove('row-is-zero');
                }
            }
        }
    });
}

/**
 * Abre la ventana modal de recomendaciones.
 */
function openRecommendationsModal() {
    const modal = document.getElementById('recommendations-modal');
    if (modal) {
        modal.style.display = 'flex';
    }
}

/**
 * Cierra la ventana modal de recomendaciones.
 */
function closeRecommendationsModal() {
    const modal = document.getElementById('recommendations-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}


/**
 * Captura un elemento HTML específico (como una sección de resumen)
 * y lo descarga como una imagen PNG.
 * @param {HTMLElement} elementToCapture - El elemento del DOM a capturar.
 * @param {string} sectionName - El nombre de la sección para el nombre del archivo.
 */
function capturarElementoComoImagen(elementToCapture, sectionName) {
    if (!elementToCapture) {
        updateStatus("Error: No se encontró la sección para capturar.");
        return;
    }
    updateStatus(`Capturando sección "${sectionName}"...`);

    // 1. Estilos para hacer el elemento invisible pero renderizable
    elementToCapture.style.position = 'absolute';
    elementToCapture.style.left = '-9999px';
    elementToCapture.style.backgroundColor = 'white'; // Asegura un fondo sólido
    elementToCapture.style.padding = '2px'; // Añade un pequeño margen
    elementToCapture.style.paddingLeft = '2px'; // Mantiene los otros espacios
    elementToCapture.style.paddingRight = '2px';
    elementToCapture.style.paddingBottom = '2px';
    elementToCapture.style.width = '1000px'; // Un ancho fijo para consistencia

    // 2. Añade el elemento al DOM para que html2canvas pueda "verlo"
    document.body.appendChild(elementToCapture);
    const titleWrapperInCapture = elementToCapture.querySelector('.section-title-wrapper');
    if (titleWrapperInCapture) {
        titleWrapperInCapture.style.marginTop = '0';
    }

    html2canvas(elementToCapture, {
        scale: 2, // Mejora la resolución
        useCORS: true,
        logging: false,
        backgroundColor: '#FFFFFF' // Asegura un fondo blanco
    }).then(canvas => {



 // 1. Abre una nueva pestaña EN BLANCO primero.
        const newWindow = window.open('', '_blank');
        
        if (newWindow) {
            // 2. Obtiene la imagen como una URL de datos.
            const imageUrl = canvas.toDataURL('image/png');
            
            // 3. Escribe el código HTML en la nueva pestaña para mostrar la imagen.
            newWindow.document.write(`
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <title>Captura - ${sectionName}</title>
                    <style>
                        body { margin: 0; background-color: #f0f0f0; text-align: center; padding: 20px; }
                        img { max-width: 100%; height: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
                    </style>
                </head>
                <body>
                    <img src="${imageUrl}" alt="Captura de la sección ${sectionName}">
                </body>
                </html>
            `);
            newWindow.document.close(); // Finaliza la escritura para que la página se cargue.
            
            updateStatus(`Sección "${sectionName}" abierta en una nueva pestaña.`);
        } else {
            updateStatus("Error al abrir la nueva pestaña. Revisa si tu navegador está bloqueando los pop-ups.");
        }

    }).catch(err => {
        console.error("Error al capturar la sección:", err);
        updateStatus("Ocurrió un error durante la captura de la sección.");

}).finally(() => {
        // --- LIMPIEZA ---
        // 3. Elimina el elemento temporal del DOM después de la captura
        document.body.removeChild(elementToCapture);
    });

}

function createHomeLink() {
    const homeLink = document.createElement('div');
    homeLink.className = 'home-icon-link';
    homeLink.title = 'Volver al Resumen General';
    homeLink.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L8 2.207l6.646 6.647a.5.5 0 0 0 .708-.708L8.707 1.5z"/><path d="m8 3.293-6 6V13.5a1.5 1.5 0 0 0 1.5 1.5h9A1.5 1.5 0 0 0 14 13.5V9.293l-6-6z"/></svg>`;

    homeLink.onclick = () => {
        const resumenTabButton = document.getElementById('btn-tab-resumen');
        if (resumenTabButton) {
            resumenTabButton.click();
        }
    };
    return homeLink;
}

/**
 * Extrae la identificación, razón social y año de la información cualitativa desde celdas específicas.
 * @returns {object} Un objeto con las propiedades 'Identificación', 'Nombre / Razón Social' y 'Año'.
 */
function getQualitativeData() {
    const data = {
        'Identificación': 'NO ENCONTRADO',
        'Nombre / Razón Social': 'NO ENCONTRADO',
        'Año': 'NO ENCONTRADO'
    };

    // Se verifica que el array de información cualitativa exista y tenga suficientes filas.
    // Se necesita hasta la fila 12, que corresponde al índice 11 del array.
    if (encabezadoCualitativoGlobal && encabezadoCualitativoGlobal.length > 11) { 
        
        // Extrae el Año desde la celda C8 (fila con índice 7, columna con índice 2)
        if (encabezadoCualitativoGlobal[7] && encabezadoCualitativoGlobal[7][2] !== undefined) {
            data['Año'] = String(encabezadoCualitativoGlobal[7][2]).trim();
        }

        // Extrae la Identificación desde la celda C11 (fila con índice 10, columna con índice 2)
        if (encabezadoCualitativoGlobal[10] && encabezadoCualitativoGlobal[10][2] !== undefined) {
            data['Identificación'] = String(encabezadoCualitativoGlobal[10][2]).trim();
        }

        // Extrae el Nombre / Razón Social desde la celda C12 (fila con índice 11, columna con índice 2)
        if (encabezadoCualitativoGlobal[11] && encabezadoCualitativoGlobal[11][2] !== undefined) {
            data['Nombre / Razón Social'] = String(encabezadoCualitativoGlobal[11][2]).trim();
        }

    } else {
        console.warn("La sección de información cualitativa no tiene la estructura esperada (al menos 12 filas). No se pudieron extraer los datos por celda.");
    }

    return data;
}

/**
 * Captura todos los valores y totales de la pestaña "Resumen General" actualmente visible en la UI.
 * @param {string} fileName - El nombre del archivo que se acaba de procesar.
 * @returns {object} Un objeto plano con todos los datos del resumen para ese archivo.
 */
function captureFileSummaryData(fileName) {
    const summary = {
        'Nombre del Archivo': fileName,
        ...getQualitativeData()
    };

    // Captura los totales de cada sección principal
    const sectionOrder = ['Patrimonio', 'Pasivos', 'Ingresos', 'Costos y Deducciones - INRNGO', 'Retención en la fuente'];
    sectionOrder.forEach(sectionName => {
        const totalCell = document.getElementById(`total-resumen-${normalizeText(sectionName)}`);
        summary[`Total ${sectionName}`] = totalCell ? parseCleanedInteger(totalCell.textContent) : 0;
    });

    // Captura el valor de cada ítem individual del resumen
    resumenGeneralConfig.forEach(item => {
        const valorCell = document.querySelector(`#resumen-general-container td[data-id="${item.id}"]`);
        if (valorCell) {
            // Usa el nombre del formato como clave para el objeto
            summary[item.nombre] = parseCleanedInteger(valorCell.textContent);
        }
    });

    return summary;
}

/**
 * Genera y descarga el archivo Excel con el resumen consolidado de todos los archivos procesados.
 */
function exportarResumenConsolidado() {
    if (consolidatedResultsData.length === 0) {
        updateStatus("No hay datos consolidados para exportar.");
        return;
    }
    updateStatus("Generando resumen consolidado en Excel...");

    // 1. Define el mapa de equivalencias y el orden deseado de las columnas.
    const headerEquivalences = {
        'Nombre del Archivo': 'Nombre del Archivo',
        'Identificación': 'Identificación',
        'Nombre / Razón Social': 'Nombre / Razón Social',
        'Año': 'Año',
        'Total Patrimonio': 'patrimonio_bruto_exogena',
        'Total Pasivos': 'pasivos_exogena',
        'Total Ingresos': 'ingreso_exogena',
        'Total Costos y Deducciones - INRNGO': 'compras_exogena',
        'Total Retención en la fuente': 'retenciones_le_practican_exogena',
        'Movimiento en Cuenta Corriente y/o Ahorro - Crédito': 'mov_credito_exogena',
        'Movimiento en Cuenta Corriente y/o Ahorro - Débito': 'mov_debito_exogena',
        'Prestamos Bancarios Otorgados': 'prestamos_otorgados_exogena',
        'Consumos con Tarjeta de Crédito': 'consumos_tc_exogena',
        'Retenciones en la Fuente que le Practican  - Bases': 'bases_retencion_precticadas_exogena',
        'Retenciones en la Fuente que le Practican - Retenciones': 'retenciones_practicadas_exogena',
        'Impuesto a las Ventas por Pagar (Descontable) - (Generado por el Denunciado)': 'iva_generado_exogena',
        'Impuesto a las Ventas por Pagar (Descontable) - (F1001) - (Generado por el Denunciado)': 'iva_generado_exogena_f1001',
        'Impuesto a las Ventas por Pagar (Descontable) - (F1024) - (Generado por el Denunciado)': 'iva_generado_exogena_f1024',
        'Impuesto a las Ventas por Pagar (Descontable) - (F5249) - (Generado por el Denunciado)': 'iva_generado_exogena_f5249',
        'Impuesto a las Ventas por Pagar (Generado) e Impuesto al Consumo - (Descontable para el Denunciado)': 'iva_descontable_exogena',
        'Impuesto a las Ventas por Pagar (Generado) e Impuesto al Consumo (F5250) - (Descontable para el Denunciado)': 'iva_descontable_exogena_f5250',
        'Impuesto a las Ventas por Pagar (Descontable) - Impoconsumo': 'impoconsumo_descontable_exogena',
        'Impuesto a las Ventas por Pagar (Descontable) - Impoconsumo - (F1024)': 'impoconsumo_descontable_exogena_f1024',
        'Impuesto a las Ventas por Pagar (Generado) e Impuesto al Consumo': 'impoconsumo_generado_exogena',
        'Impuesto a las Ventas por Pagar (Generado) e Impuesto al Consumo (F5250)': 'impoconsumo_generado_exogena_f5250',
        'Donaciones Recibidas y Certificadas por Entidades No Contribuyentes': 'donaciones_exogena',
        'Certificados de Depósito a Término - Retención Practicada': 'Certificados de Depósito a Término - Retención Practicada',
        'Creación Sociedades Cámara de Comercio': 'Creación Sociedades Cámara de Comercio',
        'Deposito de Titulos Valores y Rendimientos o Dividendos Cancelados': 'Deposito de Titulos Valores y Rendimientos o Dividendos Cancelados',
        'Impuesto de Industria y Comercio, Avisos y Tableros': 'Impuesto de Industria y Comercio, Avisos y Tableros',
        'Información de los Fondos de Inversion Colectiva': 'Información de los Fondos de Inversion Colectiva',
        'Pagos o Abonos en Cuenta a Beneficiarios en el Exterior - ReteIVA': 'Pagos o Abonos en Cuenta a Beneficiarios en el Exterior - ReteIVA',
        'Pagos o Abonos en Cuenta a Beneficiarios en el Exterior - Retención': 'Pagos o Abonos en Cuenta a Beneficiarios en el Exterior - Retención',
        'Pagos o Abonos en Cuenta y Retenciones Practicadas - ReteIVA': 'Pagos o Abonos en Cuenta y Retenciones Practicadas - ReteIVA',
        'Ventas con Tarjeta de Crédito': 'Ventas con Tarjeta de Crédito'
    };
    
    // Define el orden exacto de las columnas
    const orderedOriginalHeaders = Object.keys(headerEquivalences);

    // 2. Identifica todos los encabezados presentes en los datos.
    const allDataHeaders = new Set();
    consolidatedResultsData.forEach(result => {
        Object.keys(result).forEach(key => allDataHeaders.add(key));
    });

    // 3. Construye la lista final de encabezados para el Excel.
    // Primero, los encabezados predefinidos que realmente existen en los datos, en el orden correcto.
    const finalHeadersOrdered = orderedOriginalHeaders.filter(header => allDataHeaders.has(header));
    
    // Luego, añade cualquier otro encabezado encontrado que no estaba en la lista predefinida.
    const otherHeaders = [...allDataHeaders].filter(header => !headerEquivalences.hasOwnProperty(header));
    const finalOriginalHeaders = [...finalHeadersOrdered, ...otherHeaders.sort()];

    // Mapea los nombres originales a los nombres de exportación.
    const finalExportHeaders = finalOriginalHeaders.map(header => headerEquivalences[header] || header);

    // 4. Prepara las filas de datos para la hoja de cálculo, usando los nuevos encabezados.
    const dataForSheet = consolidatedResultsData.map(result => {
        const row = {};
        finalOriginalHeaders.forEach(originalHeader => {
            const exportHeader = headerEquivalences[originalHeader] || originalHeader;
            row[exportHeader] = result[originalHeader] !== undefined ? result[originalHeader] : 0;
        });
        return row;
    });

    // 5. Crea y descarga el archivo Excel.
    const ws = XLSX.utils.json_to_sheet(dataForSheet, { header: finalExportHeaders });
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Resumen Consolidado");
    
    const nombreArchivo = `Resumen_Consolidado_Exogena${new Date().toISOString().slice(0,10)}.xlsx`;
    XLSX.writeFile(wb, nombreArchivo);
    updateStatus(`Archivo "${nombreArchivo}" exportado.`);
}

function waitForDOMStability() {
    return new Promise(resolve => {
        // Espera un ciclo de renderizado para asegurar que el DOM se actualice
        requestAnimationFrame(() => {
            // Ejecuta tras una micro-pausa de 50ms para garantizar que los cálculos se reflejen en el DOM
            setTimeout(resolve, 50); 
        });
    });
}


/**
 * Calcula los totales netos de Crédito y Débito para el formato 1019
 * (incluyendo el ajuste del 1026 y 1021) directamente desde la data bruta
 * y los almacena en la variable global resumenGeneralData.
 */
function calculate1019NetTotalsFromRawData() {
    if (!formatosProcesadosGlobal['1019'] && !formatosProcesadosGlobal['1021']) {
        // Si no hay 1019 o 1021, reseteamos a cero para el archivo actual
        resumenGeneralData['1019-credito-neto'] = 0;
        resumenGeneralData['1019-debito-neto'] = 0;
        return;
    }

    // 1. Combinar datos 1019 y 1021
    let filasParaMovimientos1019 = formatosProcesadosGlobal['1019'] ? explotarYConsolidarFilas(formatosProcesadosGlobal['1019']) : [];
    if (formatosProcesadosGlobal['1021']) {
       const filas1021 = explotarYConsolidarFilas(formatosProcesadosGlobal['1021']);
       if (!filasParaMovimientos1019.some(f => String(f[CODIGO_FORMATO_KEY]) === '1021')) {
           filasParaMovimientos1019.push(...filas1021);
       }
    }
    
    // 2. Filtrar por cuentas principales y agregar movimientos brutos
    const s2HeadersToSum = COLUMNAS_S2_FORMATO_1019_MOVIMIENTOS;
    const filasPrincipalesOVacias = filasParaMovimientos1019.filter(fila => {
        const reportadoComoNorm = normalizeText(fila[REPORTADO_COMO_KEY] || '');
        const formatoValido = String(fila[CODIGO_FORMATO_KEY]) === '1019' || String(fila[CODIGO_FORMATO_KEY]) === '1021';
        return formatoValido && (reportadoComoNorm === 'principal' || reportadoComoNorm === '');
    });

    let totalCreditoBruto = 0;
    let totalDebitoBruto = 0;
    const creditoHeader = s2HeadersToSum[0]; 
    const debitoHeader = s2HeadersToSum[1];  

    filasPrincipalesOVacias.forEach(fila => {
        if (fila[creditoHeader]) totalCreditoBruto += parseCleanedInteger(fila[creditoHeader]);
        if (fila[debitoHeader]) totalDebitoBruto += parseCleanedInteger(fila[debitoHeader]);
    });

    // 3. Calcular el ajuste 1026
    let sumaBeneficiarioPrestamo1026 = 0;
    const rawData1026 = formatosProcesadosGlobal['1026'];
    
    if (rawData1026 && rawData1026.length > 0) {
        // Encontrar las CLAVES INDEXADAS que corresponden a las columnas S2 del F1026
        const indexedKeys1026 = [];
        
        // Obtenemos todos los encabezados reales con índice de las filas del 1026
        const availableKeys = Object.keys(rawData1026[0] || {});

        // Se itera sobre las columnas S2 predefinidas del F1026 (COLUMNAS_S2_FORMATO_1026)
        COLUMNAS_S2_FORMATO_1026.forEach(targetHeader => {
            // Buscamos la clave indexada (ej. "Beneficiario Préstamo comercial_idx22")
            // que comience con el nombre del encabezado objetivo.
            const foundKey = availableKeys.find(k => 
                k.startsWith(targetHeader) && k.includes('_idx')
            );
            if (foundKey) {
                indexedKeys1026.push(foundKey);
            }
        });

        // Sumar los valores usando las claves indexadas directamente de los datos brutos.
        rawData1026.forEach(fila => {
            indexedKeys1026.forEach(indexedKey => {
                const value = fila[indexedKey];
                if (value) {
                    sumaBeneficiarioPrestamo1026 += parseCleanedInteger(value);
                }
            });
        });
    }

   // 4. Calcular totales netos y almacenar en el objeto global
    const totalCreditoNeto = totalCreditoBruto - sumaBeneficiarioPrestamo1026;
    const totalDebitoNeto = totalDebitoBruto; // El débito no tiene ajuste

    resumenGeneralData['1019-credito-neto'] = totalCreditoNeto;
    resumenGeneralData['1019-debito-neto'] = totalDebitoNeto;
    resumenGeneralData['1026-ajuste-bruto'] = sumaBeneficiarioPrestamo1026; 
}

    </script>
</body>
</html>
